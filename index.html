<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de F√∫tbol - Liga 1 Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap');
        :root { --gold:#f1c40f; --dark:#1a1a1a; --mid:#2c3e50; --blue:#3498db; --red:#e74c3c; --green:#27ae60; }
        * { box-sizing:border-box; }
        body { background:var(--dark); color:white; font-family:'Rajdhani',sans-serif; display:flex; flex-direction:column; align-items:center; margin:0; padding:20px; overflow-x:hidden; }

        /* UI PANEL */
        #ui-panel { display:flex; justify-content:space-between; align-items:center; width:800px; margin-bottom:5px; background:var(--mid); padding:15px 25px; border-radius:10px; box-sizing:border-box; box-shadow:0 4px 6px rgba(0,0,0,.3); }
        .score-board { font-size:24px; font-weight:bold; display:flex; gap:20px; align-items:center; }
        .team-azul { color:var(--blue); font-family:'Bebas Neue',sans-serif; letter-spacing:1px; }
        .team-rojo { color:var(--red); font-family:'Bebas Neue',sans-serif; letter-spacing:1px; }
        .timer { font-size:24px; font-weight:bold; color:#ecf0f1; background:rgba(0,0,0,.4); padding:5px 15px; border-radius:8px; font-family:'Bebas Neue',sans-serif; }
        .coins { color:var(--gold); font-size:20px; font-weight:bold; background:rgba(0,0,0,.3); padding:5px 15px; border-radius:20px; display:flex; align-items:center; gap:10px; }

        #live-events { display:flex; justify-content:space-between; width:800px; padding:10px 20px; box-sizing:border-box; font-size:14px; margin-bottom:10px; background:rgba(44,62,80,.8); border-radius:8px; min-height:50px; border:2px solid #34495e; }
        #home-scorers { color:var(--blue); width:48%; text-align:left; }
        #away-scorers { color:var(--red); width:48%; text-align:right; }

        .btn { background:var(--green); color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold; cursor:pointer; transition:.2s; font-family:'Rajdhani',sans-serif; font-size:14px; }
        .btn:hover { background:#2ecc71; transform:translateY(-1px); }
        .btn:disabled { background:#7f8c8d!important; color:#ccc!important; cursor:not-allowed; transform:none!important; }
        .cheat-btn { background:#e67e22; color:white; border:none; padding:2px 8px; border-radius:3px; font-weight:bold; cursor:pointer; font-size:12px; }
        select.btn, input.setup-input, select.setup-input { background:#34495e; color:white; cursor:pointer; outline:none; border:1px solid #7f8c8d; padding:10px; border-radius:5px; font-size:16px; font-family:'Rajdhani',sans-serif; }

        #game-container { position:relative; display:none; }
        canvas { background-color:#27ae60; border:4px solid #fff; border-radius:4px; box-shadow:0 10px 20px rgba(0,0,0,.5); cursor:crosshair; }

        /* OVERLAYS */
        #selection-overlay { display:none; position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(241,196,15,.9); color:#000; padding:10px 20px; border-radius:20px; font-weight:bold; z-index:50; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.5); pointer-events:none; }
        .cancel-btn { pointer-events:auto; background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px; margin-left:10px; cursor:pointer; }

        /* PENALTY SELECTION OVERLAY */
        #penalty-select-overlay { display:none; position:absolute; top:0; left:0; width:100%; background:rgba(0,0,0,.85); padding:14px 20px; z-index:200; text-align:center; border-bottom:3px solid var(--gold); }
        #penalty-select-overlay h3 { margin:0 0 6px; font-family:'Bebas Neue',sans-serif; font-size:26px; color:var(--gold); letter-spacing:2px; }
        .pen-selected-list { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:6px; }
        .pen-tag { background:#34495e; border:2px solid var(--gold); border-radius:20px; padding:3px 12px; font-size:13px; font-weight:bold; }

        /* PENALTY CANVAS OVERLAY */
        #penalty-canvas-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:180; background:rgba(0,0,0,.6); pointer-events:none; }
        #penalty-hud { display:none; position:absolute; top:8px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); border:2px solid var(--gold); border-radius:12px; padding:8px 24px; text-align:center; z-index:190; pointer-events:none; }
        #penalty-hud .pen-score { font-family:'Bebas Neue',sans-serif; font-size:32px; color:var(--gold); }
        #penalty-hud .pen-kicks-row { display:flex; justify-content:center; gap:6px; margin-top:2px; font-size:18px; }
        #penalty-hud .pen-turn-text { font-size:13px; color:#bdc3c7; margin-top:3px; }

        /* MODALES */
        #message-modal, #shop-modal, #player-select-modal { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(44,62,80,.98); padding:20px 30px; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,.8); z-index:300; text-align:center; border:3px solid var(--gold); }
        #message-modal { width:500px; }
        #message-text { max-height:350px; overflow-y:auto; text-align:left; line-height:1.5; font-family:monospace; white-space:pre-wrap; font-size:14px; }
        #shop-modal { width:560px; z-index:100; max-height:92vh; overflow-y:auto; }
        #player-select-modal { width:420px; z-index:150; }

        /* ANIMACION GOL */
        #goal-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:500; pointer-events:none; overflow:hidden; background:radial-gradient(ellipse at center, rgba(241,196,15,.3) 0%, rgba(0,0,0,.7) 100%); }
        #goal-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); font-family:'Bebas Neue',sans-serif; font-size:120px; color:var(--gold); text-shadow:0 0 60px rgba(241,196,15,1),0 0 120px rgba(241,196,15,.5),4px 4px 0 #000; white-space:nowrap; transition:transform .3s cubic-bezier(.34,1.56,.64,1); letter-spacing:8px; }
        #goal-scorer-text { position:absolute; top:62%; left:50%; transform:translateX(-50%); font-family:'Bebas Neue',sans-serif; font-size:28px; color:white; text-shadow:2px 2px 0 #000; letter-spacing:3px; opacity:0; transition:opacity .4s ease .3s; }
        .confetti-piece { position:absolute; opacity:0; animation:confettiFall 1.5s ease-out forwards; }
        @keyframes confettiFall { 0%{opacity:1;transform:translateY(-20px) rotate(0deg);} 100%{opacity:0;transform:translateY(520px) rotate(720deg);} }

        /* FIN TEMPORADA */
        #endseason-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.97); z-index:2000; flex-direction:column; align-items:center; justify-content:center; }
        .trophy-display { font-size:100px; animation:trophyBounce .8s ease-out; }
        @keyframes trophyBounce { 0%{transform:scale(0) rotate(-20deg);} 60%{transform:scale(1.2) rotate(5deg);} 100%{transform:scale(1) rotate(0);} }
        .champion-name { font-family:'Bebas Neue',sans-serif; font-size:64px; color:var(--gold); text-shadow:0 0 40px rgba(241,196,15,.8); letter-spacing:6px; animation:fadeInUp .6s ease .4s both; }
        .awards-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin:20px 0; width:700px; }
        .award-card { background:#1a1a1a; border:2px solid #333; border-radius:10px; padding:15px; text-align:center; animation:fadeInUp .5s ease both; }
        .award-card:nth-child(1){animation-delay:.6s;border-color:var(--gold);} .award-card:nth-child(2){animation-delay:.8s;border-color:var(--blue);} .award-card:nth-child(3){animation-delay:1s;border-color:var(--red);}
        .award-icon { font-size:36px; display:block; margin-bottom:5px; }
        .award-title { font-size:12px; color:#999; text-transform:uppercase; letter-spacing:1px; }
        .award-winner { font-family:'Bebas Neue',sans-serif; font-size:20px; color:white; margin:4px 0; }
        .award-value { font-size:13px; color:var(--gold); }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(30px);} to{opacity:1;transform:translateY(0);} }
        .stars-bg { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden; }
        .star { position:absolute; background:var(--gold); border-radius:50%; animation:starFloat linear infinite; }
        @keyframes starFloat { 0%{transform:translateY(100vh) rotate(0deg);opacity:1;} 100%{transform:translateY(-100px) rotate(720deg);opacity:0;} }

        /* TORNEO */
        #tournament-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(26,26,26,.97); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .setup-box { background:var(--mid); padding:40px; border-radius:15px; text-align:center; border:4px solid var(--blue); box-shadow:0 10px 30px rgba(0,0,0,.5); width:480px; }
        .difficulty-selector { display:flex; gap:8px; margin:10px 0 20px; }
        .diff-btn { flex:1; padding:10px; border:2px solid #34495e; border-radius:8px; background:transparent; color:white; cursor:pointer; font-family:'Rajdhani',sans-serif; font-size:15px; font-weight:600; transition:.2s; }
        .diff-btn.active-easy{border-color:#2ecc71;background:rgba(46,204,113,.15);color:#2ecc71;}
        .diff-btn.active-normal{border-color:var(--gold);background:rgba(241,196,15,.15);color:var(--gold);}
        .diff-btn.active-hard{border-color:var(--red);background:rgba(231,76,60,.15);color:var(--red);}

        /* LIGA & COPA */
        .league-container,.bracket-container { background:var(--mid); padding:30px; border-radius:15px; width:95%; max-width:1100px; border:4px solid var(--gold); box-shadow:0 10px 30px rgba(0,0,0,.5); display:none; flex-direction:row; gap:20px; }
        .table-wrap { flex:2; background:#1a1a1a; padding:15px; border-radius:8px; height:450px; overflow-y:auto; }
        .fixture-wrap { flex:1.5; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#34495e; padding:20px; border-radius:8px; }
        .tabs { display:flex; width:100%; margin-bottom:10px; gap:5px; }
        .tab-btn { flex:1; background:#34495e; border:none; color:white; padding:10px; cursor:pointer; border-radius:5px; font-weight:bold; font-family:'Rajdhani',sans-serif; }
        .tab-btn.active { background:var(--gold); color:black; }
        table.standings { width:100%; border-collapse:collapse; font-size:13px; text-align:center; }
        table.standings th { background:var(--gold); color:#000; padding:8px; position:sticky; top:0; z-index:1; font-family:'Bebas Neue',sans-serif; letter-spacing:1px; }
        table.standings td { padding:6px; border-bottom:1px solid #333; }
        .my-team-row { background:rgba(241,196,15,.2); font-weight:bold; border:1px solid var(--gold); }
        .matchup-card { background:#1a1a1a; padding:20px; border-radius:10px; width:100%; text-align:center; border:2px solid var(--blue); margin-bottom:20px; }
        .team-color-box { width:15px; height:15px; border-radius:3px; display:inline-block; margin-right:8px; border:1px solid #fff; vertical-align:middle; }
        .matches-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:15px; margin:10px 0; max-height:350px; overflow-y:auto; padding-right:10px; }
        .matchup { background:#1a1a1a; padding:10px; border-radius:8px; text-align:center; border:2px solid #1abc9c; font-weight:bold; }
        .matchup.player-match { border-color:var(--gold); background:#2c3e50; box-shadow:0 0 10px rgba(241,196,15,.5); }
        .team-row { display:flex; justify-content:space-between; align-items:center; margin:5px 0; font-size:14px; }

        /* SCROLLBARS */
        ::-webkit-scrollbar{width:8px;} ::-webkit-scrollbar-track{background:#1a1a1a;border-radius:4px;} ::-webkit-scrollbar-thumb{background:var(--gold);border-radius:4px;}

        /* SHOP */
        .shop-item { background:#34495e; margin:8px 0; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; font-size:14px; border-left:4px solid transparent; cursor:pointer; transition:.2s; }
        .shop-item:hover { background:#3b536b; transform:translateX(2px); }
        .item-upg{border-color:var(--gold);background:#2c3e50;} .item-def{border-color:var(--blue);} .item-med{border-color:#2ecc71;} .item-del{border-color:var(--red);}
        .buy-btn { background:var(--gold); color:#000; font-weight:bold; border:none; padding:8px 15px; cursor:pointer; border-radius:5px; transition:.2s; min-width:70px; font-family:'Rajdhani',sans-serif; }
        .buy-btn:hover { background:#f39c12; }

        /* BADGE DIFICULTAD */
        #difficulty-badge { position:absolute; top:10px; right:10px; padding:5px 12px; border-radius:20px; font-weight:bold; font-size:13px; font-family:'Bebas Neue',sans-serif; letter-spacing:1px; z-index:10; }
        .badge-easy{background:rgba(46,204,113,.3);border:1px solid #2ecc71;color:#2ecc71;}
        .badge-normal{background:rgba(241,196,15,.3);border:1px solid var(--gold);color:var(--gold);}
        .badge-hard{background:rgba(231,76,60,.3);border:1px solid var(--red);color:var(--red);}
        .formacion-opt{background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:10px;color:white;padding:12px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;transition:0.2s;width:100%;}
        .formacion-opt:hover{border-color:#f1c40f;background:rgba(241,196,15,0.1);color:#f1c40f;transform:translateX(4px);}
        .formacion-opt.selected{border-color:#f1c40f;background:rgba(241,196,15,0.15);color:#f1c40f;}
        .squad-slot{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin-bottom:6px;font-size:13px;}
        .squad-slot.filled{border-color:rgba(241,196,15,.3);}
        .squad-slot.empty{opacity:.5;border-style:dashed;}
        .squad-slot-name{flex:1;font-weight:700;color:var(--gold);}
        .squad-slot-info{font-size:11px;color:rgba(255,255,255,.4);}
        .squad-slot-btns{display:flex;gap:5px;}
        .sqbtn{border:none;padding:4px 10px;border-radius:5px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Rajdhani',sans-serif;}
        .sqbtn-load{background:#27ae60;color:white;} .sqbtn-load:hover{background:#2ecc71;}
        .sqbtn-del{background:#c0392b;color:white;} .sqbtn-del:hover{background:#e74c3c;}
        .sqbtn-save{background:rgba(241,196,15,.15);border:1px solid var(--gold);color:var(--gold);} .sqbtn-save:hover{background:rgba(241,196,15,.3);}
        /* REASIGNACION */
        #reasign-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;align-items:center;justify-content:center;}
        .reasign-box{background:#1a2535;border:3px solid var(--gold);border-radius:18px;padding:24px;width:720px;max-width:98vw;max-height:95vh;overflow-y:auto;}
        .reasign-title{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--gold);letter-spacing:3px;text-align:center;margin-bottom:4px;}
        .reasign-sub{text-align:center;font-size:13px;color:rgba(255,255,255,.4);margin-bottom:18px;}
        .reasign-cols{display:grid;grid-template-columns:1fr 40px 1fr;gap:8px;align-items:start;}
        .reasign-col-title{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;color:rgba(255,255,255,.5);text-align:center;margin-bottom:10px;padding:6px;background:rgba(255,255,255,.04);border-radius:6px;}
        .reasign-arrow{display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--gold);padding-top:80px;}
        .slot-card{background:rgba(255,255,255,.04);border:2px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;min-height:54px;}
        .slot-card:hover{border-color:var(--gold);background:rgba(241,196,15,.07);}
        .slot-card.selected-src{border-color:#3498db;background:rgba(52,152,219,.15);box-shadow:0 0 12px rgba(52,152,219,.3);}
        .slot-card.selected-dst{border-color:#2ecc71;background:rgba(46,204,113,.12);}
        .slot-card.empty{border-style:dashed;opacity:.6;}
        .slot-card.dropped{border-color:#2ecc71;background:rgba(46,204,113,.1);}
        .slot-rol{font-size:11px;padding:2px 8px;border-radius:10px;font-weight:700;letter-spacing:1px;}
        .rol-Lateral{background:rgba(52,152,219,.25);color:#3498db;}
        .rol-Central{background:rgba(231,76,60,.25);color:#e74c3c;}
        .rol-Medio{background:rgba(46,204,113,.25);color:#2ecc71;}
        .rol-Delantero{background:rgba(241,196,15,.25);color:#f1c40f;}
        .slot-name{font-size:14px;font-weight:700;flex:1;}
        .slot-stars{font-size:12px;color:var(--gold);}
        .reasign-btns{display:flex;gap:10px;justify-content:center;margin-top:20px;}
        .reasign-info{text-align:center;font-size:13px;color:rgba(255,255,255,.4);margin-top:10px;min-height:20px;}
    </style>
</head>
<body>

<!-- FIN TEMPORADA -->
<div id="endseason-overlay">
    <div class="stars-bg" id="stars-bg"></div>
    <div class="trophy-display" id="endseason-trophy">üèÜ</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:#999;letter-spacing:4px;margin-bottom:5px;">CAMPE√ìN DE</div>
    <div class="champion-name" id="endseason-champion-name">UNIVERSITARIO</div>
    <div class="awards-grid" id="awards-grid"></div>
    <button class="btn" style="font-size:18px;padding:12px 30px;margin-top:10px;" onclick="location.reload()">üîÑ Nueva Temporada</button>
</div>

<!-- MODAL FORMACION PRE-PARTIDO -->
<div id="formacion-previa-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;align-items:center;justify-content:center;">
    <div style="background:#1a2535;border:3px solid #f1c40f;border-radius:20px;padding:36px 40px;text-align:center;width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.7);">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;color:#f1c40f;letter-spacing:3px;margin-bottom:6px;">‚öΩ FORMACI√ìN INICIAL</div>
        <p style="color:rgba(255,255,255,0.5);font-size:14px;margin-bottom:24px;">Elige tu t√°ctica antes de salir a la cancha</p>
        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">
            <button class="formacion-opt" onclick="elegirFormacionPrevia('4-4-2')">4-4-2 ‚Äî Clasica</button>
            <button class="formacion-opt" onclick="elegirFormacionPrevia('4-3-3')">4-3-3 ‚Äî Ofensiva</button>
            <button class="formacion-opt" onclick="elegirFormacionPrevia('3-5-2')">3-5-2 ‚Äî Posesion</button>
            <button class="formacion-opt" onclick="elegirFormacionPrevia('4-2-3-1')">4-2-3-1 ‚Äî Equilibrada</button>
            <button class="formacion-opt" onclick="elegirFormacionPrevia('5-3-2')">5-3-2 ‚Äî Defensiva</button>
        </div>
        <p style="font-size:12px;color:rgba(255,255,255,0.25);">Solo se pide antes del primer partido</p>
    </div>
</div>

<!-- MODAL REASIGNACION FORMACION -->
<div id="reasign-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;align-items:center;justify-content:center;">
    <div class="reasign-box">
        <div class="reasign-title">üîÑ CAMBIO DE T√ÅCTICA</div>
        <div class="reasign-sub" id="reasign-sub">Selecciona un jugador de la izquierda y as√≠gnalo a una posici√≥n de la derecha</div>
        <div class="reasign-cols">
            <div>
                <div class="reasign-col-title" id="reasign-col-left">FORMACI√ìN ACTUAL</div>
                <div id="reasign-left"></div>
            </div>
            <div class="reasign-arrow">‚Üí</div>
            <div>
                <div class="reasign-col-title" id="reasign-col-right">NUEVA FORMACI√ìN</div>
                <div id="reasign-right"></div>
            </div>
        </div>
        <div class="reasign-info" id="reasign-info"></div>
        <div class="reasign-btns">
            <button class="btn" style="background:#e74c3c;min-width:120px;" onclick="cancelarReasign()">‚úï Cancelar</button>
            <button class="btn" style="min-width:160px;" onclick="confirmarReasign()">‚úÖ Confirmar Cambio</button>
        </div>
    </div>
</div>

<!-- SETUP TORNEO -->
<div id="tournament-overlay">
    <div class="setup-box" id="setup-screen">
        <h1 style="color:var(--gold);margin-top:0;font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:4px;">LIGA 1 ¬∑ 2026</h1>
        <p style="margin-bottom:5px;color:#bdc3c7;">Formato:</p>
        <select class="setup-input" id="format-select" style="width:100%;margin-bottom:15px;">
            <option value="liga">üèÜ Liga (Todos contra Todos)</option>
            <option value="copa">‚öîÔ∏è Copa (Eliminaci√≥n Directa)</option>
        </select>
        <p style="margin-bottom:5px;color:#bdc3c7;">Dificultad:</p>
        <div class="difficulty-selector">
            <button class="diff-btn active-easy" id="diff-easy" onclick="setDifficulty('easy')">üü¢ F√°cil</button>
            <button class="diff-btn" id="diff-normal" onclick="setDifficulty('normal')">üü° Normal</button>
            <button class="diff-btn" id="diff-hard" onclick="setDifficulty('hard')">üî¥ Dif√≠cil</button>
        </div>
        <p style="margin-bottom:5px;color:#bdc3c7;">Tu equipo:</p>
        <select class="setup-input" id="team-select" style="width:100%;margin-bottom:20px;" onchange="toggleCustomTeam()"></select>
        <div id="custom-team-fields" style="display:none;background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin-bottom:20px;">
            <input type="text" class="setup-input" id="custom-name" placeholder="Nombre de tu equipo" maxlength="18" style="width:90%;margin-bottom:10px;"><br>
            Color Principal: <input type="color" id="custom-color1" value="#3498db" style="cursor:pointer;"><br><br>
            Color Secundario: <input type="color" id="custom-color2" value="#ffffff" style="cursor:pointer;">
        </div>
        <!-- ALINEACIONES GUARDADAS -->
        <div id="load-squad-banner" style="background:rgba(241,196,15,.08);border:2px solid rgba(241,196,15,.3);border-radius:12px;padding:14px;margin-bottom:15px;">
            <div style="font-size:15px;color:var(--gold);font-weight:bold;margin-bottom:10px;">üíæ Mis Alineaciones (m√°x. 5)</div>
            <div id="squad-slots-list"></div>
        </div>
        <button class="btn" style="font-size:22px;padding:18px 30px;width:100%;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;" onclick="iniciarTorneo()">‚öΩ COMENZAR TORNEO</button>
    </div>

    <div class="league-container" id="league-screen">
        <div class="table-wrap">
            <div class="tabs">
                <button class="tab-btn active" id="tab-pos" onclick="switchTab('pos','league')">Posiciones</button>
                <button class="tab-btn" id="tab-gol" onclick="switchTab('gol','league')">Goleadores</button>
                <button class="tab-btn" id="tab-ast" onclick="switchTab('ast','league')">Asistencias</button>
            </div>
            <table class="standings" id="table-posiciones">
                <thead><tr><th>Pos</th><th style="text-align:left;">Equipo</th><th>PJ</th><th>PG</th><th>PE</th><th>PP</th><th>GF</th><th>GC</th><th>DG</th><th>PTS</th></tr></thead>
                <tbody id="standings-body"></tbody>
            </table>
            <table class="standings" id="table-stats" style="display:none;">
                <thead><tr><th>Rnk</th><th style="text-align:left;">Jugador</th><th style="text-align:left;">Equipo</th><th id="stat-col-name">Goles</th></tr></thead>
                <tbody id="stats-body"></tbody>
            </table>
        </div>
        <div class="fixture-wrap">
            <h2 style="margin-top:0;color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:2px;" id="jornada-title">Jornada 1</h2>
            <div class="matchup-card" id="next-match-card"></div>
            <button class="btn" id="btn-play-liga" style="font-size:18px;padding:15px 30px;width:100%;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;" onclick="empezarPartido()">‚öΩ IR A LA CANCHA</button>
        </div>
    </div>

    <div class="bracket-container" id="bracket-screen">
        <div class="fixture-wrap" style="flex:2;margin-bottom:0;">
            <h2 id="round-title-copa" style="color:var(--gold);margin-top:0;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;">Octavos de Final</h2>
            <div class="matches-grid" id="matches-grid-copa"></div>
            <button class="btn" id="btn-play-copa" style="font-size:20px;padding:15px 30px;margin-top:15px;width:100%;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;" onclick="empezarPartido()">‚öΩ IR A LA CANCHA</button>
        </div>
        <div class="table-wrap" style="flex:1.5;margin-left:15px;">
            <div class="tabs">
                <button class="tab-btn active" id="tab-gol-copa" onclick="switchTab('gol','copa')">Goleadores</button>
                <button class="tab-btn" id="tab-ast-copa" onclick="switchTab('ast','copa')">Asistencias</button>
            </div>
            <table class="standings" id="table-stats-copa">
                <thead><tr><th>Rnk</th><th style="text-align:left;">Jugador</th><th style="text-align:left;">Equipo</th><th id="stat-col-name-copa">Goles</th></tr></thead>
                <tbody id="stats-body-copa"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- UI JUEGO -->
<div id="ui-panel">
    <div class="score-board">
        <span class="team-azul" id="scoreAzul">Local: 0</span>
        <div class="timer">‚è±Ô∏è <span id="time">90</span>s</div>
        <span class="team-rojo" id="scoreRojo">Visita: 0</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
        <select class="btn" id="formation-select" onchange="cambiarFormacion(this.value)">
            <option value="4-4-2">4-4-2 Cl√°sica</option>
            <option value="4-3-3">4-3-3 Ofensiva</option>
            <option value="3-5-2">3-5-2 Posesi√≥n</option>
            <option value="4-2-3-1">4-2-3-1 Equilibrada</option>
            <option value="5-3-2">5-3-2 Defensiva</option>
        </select>
        <div class="coins">ü™ô <span id="coins">100</span><button class="cheat-btn" onclick="pedirCodigo()">üîë</button></div>
        <button class="btn" id="sound-btn" onclick="initSound()" style="background:#8e44ad;">üîá Sonido</button>
        <button class="btn" onclick="abrirMercado()">üõí Mercado</button>
    </div>
</div>
<div id="live-events">
    <div id="home-scorers"></div>
    <div id="away-scorers"></div>
</div>

<div id="game-container">
    <!-- ANIMACION GOL -->
    <div id="goal-overlay">
        <div id="goal-text">¬°GOOOL!</div>
        <div id="goal-scorer-text"></div>
    </div>

    <!-- BADGE DIFICULTAD -->
    <div id="difficulty-badge" class="badge-easy">F√ÅCIL</div>

    <!-- HUD PENALES -->
    <div id="penalty-hud">
        <div class="pen-score"><span id="phud-home">0</span> - <span id="phud-away">0</span></div>
        <div class="pen-kicks-row"><div id="phud-kicks-home"></div><span style="margin:0 10px;color:#555;">|</span><div id="phud-kicks-away"></div></div>
        <div class="pen-turn-text" id="phud-turn"></div>
    </div>

    <!-- OVERLAY SELECCION PENAL -->
    <div id="penalty-select-overlay">
        <h3>‚öΩ TIROS PENALES ‚Äî Elige tus 5 pateadores</h3>
        <p style="margin:0 0 4px;font-size:13px;color:#bdc3c7;" id="pen-counter">0/5 seleccionados ‚Äî clic en jugador para agregar/quitar</p>
        <div class="pen-selected-list" id="pen-selected-list"></div>
        <button class="btn" id="btn-confirmar-penales" style="margin-top:8px;display:none;" onclick="confirmarPateadores()">‚úÖ Confirmar y Patear</button>
    </div>

    <!-- OVERLAY SELECCION FICHAJE -->
    <div id="selection-overlay">
        <span id="selection-text">Selecciona un jugador</span>
        <button class="cancel-btn" onclick="cancelarCompra()">Cancelar</button>
    </div>

    <!-- MODAL MENSAJE -->
    <div id="message-modal">
        <h3 id="message-title" style="margin-top:0;color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;">Mensaje</h3>
        <div id="message-text"></div>
        <div id="message-buttons" style="display:flex;justify-content:center;gap:15px;margin-top:15px;"></div>
    </div>

    <!-- MODAL SELECCION JUGADOR -->
    <div id="player-select-modal">
        <h3 style="color:var(--gold);margin-top:0;font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;">Transfermarkt 2026</h3>
        <p style="font-size:13px;color:#bdc3c7;">Elige un jugador para esta posici√≥n:</p>
        <div class="shop-list" id="player-options-list" style="max-height:260px;overflow-y:auto;"></div>
        <button class="btn" style="background:var(--red);margin-top:10px;" onclick="cerrarSeleccionJugador()">Cancelar</button>
    </div>

    <!-- SHOP -->
    <div id="shop-modal">
        <h2 style="color:var(--gold);margin-top:0;margin-bottom:5px;font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:2px;">üèüÔ∏è Gesti√≥n del Club</h2>

        <!-- GUARDAR PLANTILLA -->
        <div style="background:rgba(241,196,15,.08);border:1px solid var(--gold);border-radius:8px;padding:10px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <div style="text-align:left;font-size:13px;"><strong style="color:var(--gold);">üíæ Plantilla</strong><br><small style="color:#bdc3c7;">Guarda tu alineaci√≥n para la pr√≥xima vez</small></div>
            <button class="btn" style="background:#8e44ad;padding:8px 14px;" onclick="guardarPlantilla()">Guardar Plantilla</button>
        </div>

        <h3 style="color:#1abc9c;margin-top:10px;margin-bottom:5px;font-size:15px;border-bottom:1px solid #1abc9c;padding-bottom:5px;">Infraestructura Permanente</h3>
        <div style="max-height:120px;overflow-y:auto;margin-bottom:10px;">
            <div class="shop-item item-upg">
                <div style="text-align:left;"><strong>üëü Botines de √âlite</strong><br><small>+15% Velocidad a todo tu equipo.</small></div>
                <button class="buy-btn" id="btn-upg-speed" onclick="comprarMejora('speed',200,this)">200 ü™ô</button>
            </div>
            <div class="shop-item item-upg">
                <div style="text-align:left;"><strong>üéØ Entrenamiento de Definici√≥n</strong><br><small>Reducci√≥n dr√°stica de fallos al arco.</small></div>
                <button class="buy-btn" id="btn-upg-shoot" onclick="comprarMejora('shoot',200,this)">200 ü™ô</button>
            </div>
            <div class="shop-item item-upg">
                <div style="text-align:left;"><strong>üß§ Entrenador de Arqueros</strong><br><small>Tu portero ataja un 25% m√°s.</small></div>
                <button class="buy-btn" id="btn-upg-gk" onclick="comprarMejora('gk',200,this)">200 ü™ô</button>
            </div>
        </div>

        <h3 style="color:var(--blue);margin-top:10px;margin-bottom:5px;font-size:15px;border-bottom:1px solid var(--blue);padding-bottom:5px;">Mercado de Fichajes (50 ü™ô c/u)</h3>
        <div style="max-height:280px;overflow-y:auto;">
            <div style="font-size:11px;color:#999;padding:4px 0 2px;text-transform:uppercase;letter-spacing:1px;">Porteros</div>
            <div class="shop-item item-def" onclick="iniciarSeleccionJugador('Portero','Portero','Ofensivo')"><div style="text-align:left;"><strong>üß§ Portero Ofensivo</strong><br><small>Buen pase, sale a cortar.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-def" onclick="iniciarSeleccionJugador('Portero','Portero','Defensivo')"><div style="text-align:left;"><strong>üß§ Portero Defensivo</strong><br><small>Grande, ataja excelente.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div style="font-size:11px;color:#999;padding:4px 0 2px;text-transform:uppercase;letter-spacing:1px;">Defensas</div>
            <div class="shop-item item-def" onclick="iniciarSeleccionJugador('Central','Defensa','Central')"><div style="text-align:left;"><strong>üõ°Ô∏è Defensa Central</strong><br><small>Muralla en el √°rea.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-def" onclick="iniciarSeleccionJugador('Lateral','Defensa','Lateral Ofensivo')"><div style="text-align:left;"><strong>‚¨ÜÔ∏è Lateral Ofensivo</strong><br><small>Sube mucho para asistir.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-def" onclick="iniciarSeleccionJugador('Lateral','Defensa','Lateral Defensivo')"><div style="text-align:left;"><strong>üîí Lateral Defensivo</strong><br><small>Cubre el carril defensivo.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div style="font-size:11px;color:#999;padding:4px 0 2px;text-transform:uppercase;letter-spacing:1px;">Mediocampo</div>
            <div class="shop-item item-med" onclick="iniciarSeleccionJugador('Medio','Medio','MCD')"><div style="text-align:left;"><strong>üí™ MCD (Contenci√≥n)</strong><br><small>Quita y filtra balones.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-med" onclick="iniciarSeleccionJugador('Medio','Medio','Mediapunta')"><div style="text-align:left;"><strong>üé© Mediapunta (CAM)</strong><br><small>Pases perfectos al ataque.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-med" onclick="iniciarSeleccionJugador('Medio','Medio','Box to Box')"><div style="text-align:left;"><strong>üîÑ Box to Box</strong><br><small>Llega desde atr√°s, dispara de media distancia.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div style="font-size:11px;color:#999;padding:4px 0 2px;text-transform:uppercase;letter-spacing:1px;">Delanteros</div>
            <div class="shop-item item-del" onclick="iniciarSeleccionJugador('Delantero','Delantero','Extremo')"><div style="text-align:left;"><strong>üí® Extremo (LW/RW)</strong><br><small>R√°pido, desborda por banda.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-del" onclick="iniciarSeleccionJugador('Delantero','Delantero','Centrodelantero')"><div style="text-align:left;"><strong>üéØ Centrodelantero (9)</strong><br><small>Letal en el √°rea chica.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
            <div class="shop-item item-del" onclick="iniciarSeleccionJugador('Delantero','Delantero','Segundo Delantero')"><div style="text-align:left;"><strong>üî´ Segundo Delantero</strong><br><small>Tiros lejanos, apoya al 9.</small></div><span style="font-size:11px;color:#999;">50ü™ô</span></div>
        </div>
        <button class="btn" style="background:var(--red);margin-top:10px;width:100%;" onclick="cerrarMercado()">‚Üê Volver a la Cancha</button>
    </div>

    <!-- CANVAS PRINCIPAL DEL JUEGO -->
    <canvas id="gameCanvas" width="800" height="500"></canvas>
</div>

<script>
// ============================================================
// CONSTANTES Y CONFIGURACI√ìN
// ============================================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const timeEl = document.getElementById('time');
const coinsEl = document.getElementById('coins');
const GOAL_Y_START = 175, GOAL_HEIGHT = 150, GOAL_Y_END = GOAL_Y_START + GOAL_HEIGHT;
const MATCH_DURATION = 90;
const PENALTY_SPOT_X = 180; // desde la porter√≠a izquierda (lado rojo en penales)
const PENALTY_GK_X = 30;

let currentDifficulty = 'easy';
const DIFFICULTY_CONFIG = {
    easy:   { aiSpeedMult:.75, aiUpgradesPerJornada:.5,  aiKickMult:.8,  aiSaveMult:.7,  penSaveChance:.15, penMissChance:.45, label:'F√ÅCIL',   badgeClass:'badge-easy' },
    normal: { aiSpeedMult:1.0, aiUpgradesPerJornada:1.0, aiKickMult:1.0, aiSaveMult:1.0, penSaveChance:.30, penMissChance:.30, label:'NORMAL',  badgeClass:'badge-normal' },
    hard:   { aiSpeedMult:1.3, aiUpgradesPerJornada:1.8, aiKickMult:1.25,aiSaveMult:1.35,penSaveChance:.45, penMissChance:.20, label:'DIF√çCIL', badgeClass:'badge-hard' }
};

// ============================================================
// DATOS
// ============================================================
const DATABASE_TEAMS = [
    {id:'u',   name:'Universitario',     c1:'#f3e5ab',c2:'#800000',power:90},
    {id:'al',  name:'Alianza Lima',       c1:'#1a237e',c2:'#ffffff',power:90},
    {id:'sc',  name:'Sporting Cristal',   c1:'#5DADE2',c2:'#ffffff',power:90},
    {id:'mel', name:'FBC Melgar',         c1:'#c0392b',c2:'#000000',power:85},
    {id:'cus', name:'Cusco FC',           c1:'#d4af37',c2:'#000000',power:85},
    {id:'cie', name:'Cienciano',          c1:'#e74c3c',c2:'#ffffff',power:75},
    {id:'adt', name:'ADT de Tarma',       c1:'#74b9ff',c2:'#2d3436',power:75},
    {id:'gra', name:'Atl√©tico Grau',      c1:'#ffec13',c2:'#1a1a1a',power:75},
    {id:'shu', name:'Sport Huancayo',     c1:'#b33939',c2:'#27ae60',power:70},
    {id:'sba', name:'Sport Boys',         c1:'#fd79a8',c2:'#000000',power:65},
    {id:'gar', name:'Dep. Garcilaso',     c1:'#81ecec',c2:'#1a1a1a',power:65},
    {id:'cha', name:'Los Chankas CYC',    c1:'#d63031',c2:'#d4af37',power:65},
    {id:'aal', name:'Alianza Atl√©tico',   c1:'#ecf0f1',c2:'#2980b9',power:65},
    {id:'com', name:'Comerciantes Unid.', c1:'#6c5ce7',c2:'#f1c40f',power:60},
    {id:'fcc', name:'FC Cajamarca',       c1:'#bdc3c7',c2:'#2c3e50',power:60},
    {id:'utc', name:'UTC Cajamarca',      c1:'#f5deb3',c2:'#800000',power:60},
    {id:'jpi', name:'Juan Pablo II',      c1:'#f39c12',c2:'#e74c3c',power:60},
    {id:'moq', name:'CD Moquegua',        c1:'#00b894',c2:'#ffffff',power:60}
];

const ROSTERS = {
    'u':  {Portero:['D. Romero','M. Vargas','J. Rodr√≠guez'],Central:['A. Santamar√≠a','W. Riveros','M. Di Benedetto','A. Corzo'],Lateral:['C. Inga','J. Carabal√≠','P. Reyna','H. Ancajima'],Medio:['J. Castillo','J. Murrugarra','J. Concha','H. Calcaterra','D. V√°squez','S. Flores','M. Silva'],Extremo:['E. Flores','H. F√©rtoli','C. Loayza','A. Polo'],Delantero:['√Å. Valera','J. Rivera','S. Gassama','R. Dioses']},
    'al': {Portero:['G. Viscarra','A. Duarte','F. Mes√≠as'],Central:['R. Garc√©s','G. Ch√°vez','M. Antoni','J. Vel√°squez'],Lateral:['C. Carbajal','R. Alarc√≥n','D. Montenegro','L. Adv√≠ncula'],Medio:['P. Aquino','J. Castillo','E. Pavez','P. Cari','F. Gaibor'],Extremo:['K. Quevedo','A. Cantero','E. Castillo','G. Gentile'],Delantero:['F. Girotti','L. Ramos','P. Guerrero','G. Motta']},
    'sc': {Portero:['D. Enr√≠quez','R. Sol√≠s','I. Spoljaric'],Central:['L. Abram','M. Araujo','R. Lutiger','A. P√≥sito'],Lateral:['Cristiano','F. Lora','L. Sosa','J. Gonz√°lez'],Medio:['G. Cazonatti','C. Cabellos','M. T√°vara','Y. Yot√∫n','C. Benavente'],Extremo:['S. Gonz√°lez','M. Castro','S. S√°nchez','J. Moretti','J. Mell√°n'],Delantero:['F. Vizeu','L. Iberico','D. Otaya']},
    'mel':{Portero:['C. C√°ceda','J. Cabezuado','R. Farro'],Central:['M. Lazo','J. Alc√°ntar','A. Deneumostier'],Lateral:['N. Cabanillas','J. Ayque','√Å. Obando'],Medio:['J. Salas','W. Tandazo','Y. Gamero','K. Y√°√±ez','N. Quagliata'],Extremo:['J. C√°ceres','F. Zanelatto','C. Bordacahar','P. N√∫√±ez'],Delantero:['P. Erustes','J. de Santis','N. Figueroa']},
    'cus':{Portero:['P. D√≠az','A. Vidal','R. Anderson'],Central:['C. Gamarra','G. Choi','A. Fuentes'],Lateral:['J. Bol√≠var','√Å. Ampuero','M. Ruid√≠as'],Medio:['M. Auca','O. Valenzuela','C. Diez','I. Colman'],Extremo:['L. Colitto','J. Manzaneda','J. Al√≠'],Delantero:['F. Callejo','J. T√©vez']},
    'cie':{Portero:['J. Bolado','M. Vargas'],Central:['J. Valoyes','D. Ortiz','H. Riojas'],Lateral:['J. Estrada','A. Ugarriza','K. Aparicio'],Medio:['√Å. Romero','C. Torrej√≥n','R. Garc√≠a'],Extremo:['K. Sandoval','G. Gentile','J. Romagnoli'],Delantero:['D. Carando','G. Pacheco']},
    'adt':{Portero:['J. Valencia','C. Sol√≠s'],Central:['R. Bioj√≥','J. Soto','L. G√≥mez Cuero'],Lateral:['J. Navarro','A. Guti√©rrez'],Medio:['J. Guiv√≠n','√Å. Ojeda','L. P√©rez','V. Cedr√≥n'],Extremo:['A. Mazzo'],Delantero:['A. Rodr√≠guez','H. Rengifo','N. Rengifo']},
    'gra':{Portero:['P. √Ålvarez','A. Fuentes'],Central:['R. Tapia','F. Cavagna','D. Franco'],Lateral:['J. Bol√≠var','E. Rodas'],Medio:['R. Guarderas','D. Barreto','H. Espinoza','E. Correa'],Extremo:['N. Delgadillo'],Delantero:['R. Ruid√≠az','I. Camargo']},
    'shu':{Portero:['√Å. Zamudio','D. Campos'],Central:['J. Barreda','M. Gaona','Y. Murillo'],Lateral:['H. √Ångeles','A. Ch√°vez'],Medio:['R. Salcedo','E. Villar','C. Huyhua'],Extremo:['P. Magallanes','J. Canela'],Delantero:['W. D√≠az','R. Huaccha']},
    'sba':{Portero:['S. Rivadeneira'],Central:['G. Dulanto','A. Flores','R. Alfani'],Lateral:['M. Llontop','S. Aranda'],Medio:['E. Gonzales','F. Illanes','L. Sol√≠s'],Extremo:['J. Alarc√≥n','J. Torres','L. Urruti'],Delantero:['L. Nequecaur','P. Liza']},
    'gar':{Portero:['P. Zubczuk','J. Barbieri'],Central:['A. G√≥mez','H. Benincasa','J. Portales'],Lateral:['O. N√∫√±ez','E. Canales'],Medio:['C. Torrej√≥n','I. Garrafa','A. Ascues'],Extremo:['K. Sandoval','B. da Silva','F. Arancibia'],Delantero:['A. Graneros','C. Olivares','J. Sinisterra']},
    'com':{Portero:['√Å. Villete','J. Char√∫n'],Central:['Y. V√≠lchez','J. Rodr√≠guez','F. Alcedo'],Lateral:['C. V√°squez','A. Cossio'],Medio:['C. Correa','M. Carpio','J. Herrera'],Extremo:['W. Ayov√≠','√ì. Pinto'],Delantero:['M. Sen','M. Carranza']},
    'fcc':{Portero:['S. Aspajo','M. Sandi'],Central:['H. Timan√°','M. Almir√≥n','B. Bernaola'],Lateral:['N. Loyola','R. Lagos'],Medio:['A. Moyano','K. Paico','P. Lavandeira'],Extremo:['F. Ocas','C. Meza','B. Palacios'],Delantero:['H. Barcos','S. Peralta']},
    'utc':{Portero:['√Å. Campos','R. Bettocchi'],Central:['M. Ganoza','P. Serra','B. Duarte'],Lateral:['J. Huerto','D. Caro'],Medio:['M. Lliuya','A. Mu√±oz','D. Camacho'],Extremo:['L. Arce','J. N√∫√±ez'],Delantero:['M. de Jes√∫s']},
    'jpi':{Portero:['I. Quispe','J. Stucchi'],Central:['B. Pu√±o','S. Luzqui√±os','P. Fuentes'],Lateral:['F. Agurto','P. Ant√≥n'],Medio:['C. Flores','C. Garc√≠a','D. Lozano','C. Cueva'],Extremo:['M. Alan√≠z','A. Espinoza'],Delantero:['M. Juambeltz']},
    'cha':{Portero:['F. Saravia','H. Camacho'],Central:['G. Rizzo','M. Kaufman','C. Pimienta'],Lateral:['A. Quintana','B. Guevara'],Medio:['K. S√°nchez','D. Dioses','J. Palomino'],Extremo:['J. Manzaneda','O. Takeuchi'],Delantero:['I. Camargo','P. Bueno']},
    'aal':{Portero:['E. Hermoza','D. Prieto'],Central:['A. Gordillo','E. Perleche','W. Guzm√°n'],Lateral:['J. Mendieta','J. Aguirre'],Medio:['F. Urciuoli','H. Lup√∫','C. V√°squez'],Extremo:['J. Quintana'],Delantero:['P. Guzm√°n']},
    'moq':{Portero:['C. Grados','R. Figueroa'],Central:['J. Amasifuen','C. Enciso','J. Granda'],Lateral:['E. Montenegro','A. Perleche'],Medio:['R. Chipao','C. Ram√≠rez','D. Ram√≠rez'],Extremo:['K. Ruiz','J. Vilela'],Delantero:['B. Angulo','J. Collazos','E. Lastre']},
    'gen':{Portero:['S. Rivadeneyra'],Central:['L. Abram','C. Ramos'],Lateral:['L. Adv√≠ncula','M. Trauco'],Medio:['R. Tapia','W. Cartagena'],Extremo:['A. Carrillo'],Delantero:['G. Lapadula','L. Urruti']}
};

// ============================================================
// ESTADO GLOBAL
// ============================================================
let globalStats = {}, purchasedPlayers = [], activeAIPlayers = [];
let tournamentFormat = 'liga', leagueTeams = [], leagueSchedule = [], tournamentBracket = [], currentMatchday = 0;
let myTeamData = null;
let currentMatchState = {myTeamIsHome:true, enemyData:null, actualMyColor:'', actualEnemyColor:''};
let currentFormation = "4-4-2";
let primerPartido = true;
let simulandoCopa = false; // evita doble simulacion // Pedir formaci√≥n antes del primer partido
let pendingSquadLoad = null; // plantilla pendiente de cargar

let state = {
    monedas:100, golesAzul:0, golesRojo:0, tiempo:MATCH_DURATION,
    partidoActivo:false, pausado:false, modoFichaje:null,
    upgrades:{speed:false, shoot:false, gk:false}
};

// ============================================================
// PLANTILLA SAVE/LOAD
// ============================================================
// ‚îÄ‚îÄ‚îÄ SISTEMA DE 5 ALINEACIONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAX_SQUADS = 5;

function getSquads() {
    try { return JSON.parse(localStorage.getItem('liga1_squads') || '[]'); } catch(e) { return []; }
}
function saveSquads(arr) { localStorage.setItem('liga1_squads', JSON.stringify(arr)); }

function buildSquadData(nombre) {
    const azules = players.filter(p => p.team === 'azul');
    return {
        nombre: nombre,
        teamId: myTeamData.id, teamName: myTeamData.name,
        formation: currentFormation, upgrades: {...state.upgrades},
        players: azules.map(p => ({ rolBase:p.rolBase, type:p.type, subType:p.subType, playerName:p.playerName, baseX:p.baseX, baseY:p.baseY })),
        date: new Date().toLocaleDateString('es-PE')
    };
}

function guardarPlantilla() {
    const squads = getSquads();
    const nombre = prompt('Nombre para esta alineaci√≥n:', myTeamData.name + ' ' + currentFormation);
    if (!nombre) return;
    if (squads.length >= MAX_SQUADS) {
        mostrarAlerta('‚ùå L√≠mite alcanzado', 'Ya tienes 5 alineaciones guardadas. Borra una antes de guardar.');
        return;
    }
    squads.push(buildSquadData(nombre.trim()));
    saveSquads(squads);
    renderSquadSlots();
    mostrarAlerta('‚úÖ Alineaci√≥n Guardada', `"${nombre}" guardada correctamente.`);
}

function autoGuardarPlantilla() {
    // Se llama al quedar eliminado ‚Äî guarda silenciosamente con nombre auto
    const squads = getSquads();
    if (squads.length >= MAX_SQUADS) squads.shift(); // quita la m√°s antigua si est√° lleno
    const nombre = myTeamData.name + ' (auto)';
    squads.push(buildSquadData(nombre));
    saveSquads(squads);
}

function verificarPlantillaGuardada() {
    renderSquadSlots();
}

function renderSquadSlots() {
    const squads = getSquads();
    const container = document.getElementById('squad-slots-list');
    if (!container) return;
    container.innerHTML = '';

    // Slots llenos
    squads.forEach((s, i) => {
        const row = document.createElement('div');
        row.className = 'squad-slot filled';
        row.innerHTML = `
            <span style="font-size:18px;">üõ°Ô∏è</span>
            <div style="flex:1">
                <div class="squad-slot-name">${s.nombre}</div>
                <div class="squad-slot-info">${s.teamName} ¬∑ ${s.formation} ¬∑ ${s.date}</div>
            </div>
            <div class="squad-slot-btns">
                <button class="sqbtn sqbtn-load" onclick="cargarPlantillaIdx(${i})">‚ñ∂ Cargar</button>
                <button class="sqbtn sqbtn-del" onclick="borrarPlantillaIdx(${i})">üóë</button>
            </div>`;
        container.appendChild(row);
    });

    // Slots vac√≠os
    for (let i = squads.length; i < MAX_SQUADS; i++) {
        const row = document.createElement('div');
        row.className = 'squad-slot empty';
        row.innerHTML = `<span style="font-size:16px;color:rgba(255,255,255,.2);">Ôºã</span><div class="squad-slot-name" style="color:rgba(255,255,255,.2);">Slot vac√≠o ${i+1}</div>`;
        container.appendChild(row);
    }
}

function cargarPlantillaIdx(idx) {
    const squads = getSquads();
    if (!squads[idx]) return;
    pendingSquadLoad = squads[idx];
    const sel = document.getElementById('team-select');
    if (pendingSquadLoad.teamId && [...sel.options].some(o => o.value === pendingSquadLoad.teamId)) {
        sel.value = pendingSquadLoad.teamId;
        toggleCustomTeam();
    }
    state._loadSquad = pendingSquadLoad;
    mostrarAlerta('‚úÖ Alineaci√≥n seleccionada', `"${squads[idx].nombre}" se cargar√° al iniciar el torneo.`);
}

function borrarPlantillaIdx(idx) {
    const squads = getSquads();
    const nombre = squads[idx]?.nombre || 'esta alineaci√≥n';
    mostrarConfirmacion('üóë Borrar alineaci√≥n', `¬øBorrar "${nombre}"?`, () => {
        squads.splice(idx, 1);
        saveSquads(squads);
        renderSquadSlots();
    }, ()=>{});
}

function cargarPlantilla() {
    if (!pendingSquadLoad) return;
    const sel = document.getElementById('team-select');
    if (pendingSquadLoad.teamId && [...sel.options].some(o => o.value === pendingSquadLoad.teamId)) {
        sel.value = pendingSquadLoad.teamId;
        toggleCustomTeam();
    }
    state._loadSquad = pendingSquadLoad;
}

function ignorarPlantilla() {
    pendingSquadLoad = null;
    document.getElementById('load-squad-banner').style.display = 'none';
    state._loadSquad = null;
}

function aplicarPlantillaCargada(save) {
    // Formaci√≥n
    const formacion = formacionesDB[save.formation];
    if (!formacion) return;
    currentFormation = save.formation;
    document.getElementById('formation-select').value = save.formation;

    const azulCampo = players.filter(p => p.team === 'azul' && p.rolBase !== 'Portero');
    for (let i = 0; i < Math.min(10, save.players.filter(p=>p.rolBase!=='Portero').length); i++) {
        const saved = save.players.filter(p=>p.rolBase!=='Portero')[i];
        const p = azulCampo[i];
        if (!p || !saved) continue;
        p.baseX = formacion[i].x; p.baseY = formacion[i].y;
        p.rolBase = formacion[i].rol;
        p.type = saved.type; p.subType = saved.subType; p.playerName = saved.playerName;
        if (saved.type !== 'Novato') {
            p.aplicarEspecialidad(saved.type, saved.subType);
            if (saved.playerName) purchasedPlayers.push(saved.playerName);
        }
        p.reset();
    }
    // Portero
    const savedGK = save.players.find(p => p.rolBase === 'Portero');
    const gkPlayer = players.find(p => p.team === 'azul' && p.rolBase === 'Portero');
    if (savedGK && gkPlayer && savedGK.type !== 'Novato') {
        gkPlayer.aplicarEspecialidad(savedGK.type, savedGK.subType);
        gkPlayer.playerName = savedGK.playerName;
        if (savedGK.playerName) purchasedPlayers.push(savedGK.playerName);
    }
    // Mejoras
    if (save.upgrades) {
        state.upgrades = {...save.upgrades};
        if (state.upgrades.speed) { let b=document.getElementById('btn-upg-speed'); if(b){b.innerText='‚úì COMPRADO';b.disabled=true;} }
        if (state.upgrades.shoot) { let b=document.getElementById('btn-upg-shoot'); if(b){b.innerText='‚úì COMPRADO';b.disabled=true;} }
        if (state.upgrades.gk)    { let b=document.getElementById('btn-upg-gk');    if(b){b.innerText='‚úì COMPRADO';b.disabled=true;} }
    }
    state._loadSquad = null;
}

// ============================================================
// FORMACIONES
// ============================================================
const formacionesDB = {
    "4-4-2":  [{x:130,y:100,rol:'Lateral'},{x:110,y:200,rol:'Central'},{x:110,y:300,rol:'Central'},{x:130,y:400,rol:'Lateral'},{x:250,y:100,rol:'Medio'},{x:220,y:200,rol:'Medio'},{x:220,y:300,rol:'Medio'},{x:250,y:400,rol:'Medio'},{x:350,y:180,rol:'Delantero'},{x:350,y:320,rol:'Delantero'}],
    "4-3-3":  [{x:130,y:100,rol:'Lateral'},{x:110,y:200,rol:'Central'},{x:110,y:300,rol:'Central'},{x:130,y:400,rol:'Lateral'},{x:220,y:150,rol:'Medio'},{x:200,y:250,rol:'Medio'},{x:220,y:350,rol:'Medio'},{x:350,y:100,rol:'Delantero'},{x:370,y:250,rol:'Delantero'},{x:350,y:400,rol:'Delantero'}],
    "3-5-2":  [{x:110,y:150,rol:'Central'},{x:100,y:250,rol:'Central'},{x:110,y:350,rol:'Central'},{x:240,y:80,rol:'Medio'},{x:200,y:180,rol:'Medio'},{x:190,y:250,rol:'Medio'},{x:200,y:320,rol:'Medio'},{x:240,y:420,rol:'Medio'},{x:350,y:180,rol:'Delantero'},{x:350,y:320,rol:'Delantero'}],
    "4-2-3-1":[{x:130,y:100,rol:'Lateral'},{x:110,y:200,rol:'Central'},{x:110,y:300,rol:'Central'},{x:130,y:400,rol:'Lateral'},{x:190,y:200,rol:'Medio'},{x:190,y:300,rol:'Medio'},{x:270,y:120,rol:'Medio'},{x:260,y:250,rol:'Medio'},{x:270,y:380,rol:'Medio'},{x:370,y:250,rol:'Delantero'}],
    "5-3-2":  [{x:130,y:80,rol:'Lateral'},{x:110,y:180,rol:'Central'},{x:100,y:250,rol:'Central'},{x:110,y:320,rol:'Central'},{x:130,y:420,rol:'Lateral'},{x:230,y:150,rol:'Medio'},{x:210,y:250,rol:'Medio'},{x:230,y:350,rol:'Medio'},{x:350,y:180,rol:'Delantero'},{x:350,y:320,rol:'Delantero'}]
};

// ============================================================
// HELPERS
// ============================================================
function setDifficulty(d) {
    currentDifficulty = d;
    ['easy','normal','hard'].forEach(x => {
        let b = document.getElementById('diff-'+x);
        b.className = 'diff-btn' + (x===d ? ' active-'+x : '');
    });
}

function hexToRgb(hex) { let r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:{r:0,g:0,b:0}; }
function colorDistance(c1,c2) { let a=hexToRgb(c1),b=hexToRgb(c2); return Math.sqrt((a.r-b.r)**2+(a.g-b.g)**2+(a.b-b.b)**2); }

function recordStat(playerName, teamObj, type) {
    // FIX: verificamos que el nombre no sea gen√©rico
    if (!playerName || playerName==='Novato' || playerName.startsWith('Juvenil') || playerName.startsWith('Jugador')) return;
    // FIX: la clave incluye el equipo para evitar colisiones cross-team
    let key = playerName + '||' + teamObj.id;
    if (!globalStats[key]) globalStats[key] = {name:playerName, teamName:teamObj.name, teamId:teamObj.id, c1:teamObj.c1, goals:0, assists:0};
    if (type==='goal') globalStats[key].goals++;
    else if (type==='assist') globalStats[key].assists++;
}

function generateStarting11(teamId) {
    let db = ROSTERS[teamId] || ROSTERS['gen'];
    let gk = db.Portero?.[0] || 'Arquero';
    let field = [];
    for (let cat of ['Delantero','Extremo','Medio','Lateral','Central']) if(db[cat]) field = field.concat(db[cat]);
    field = [...new Set(field)].slice(0,10);
    while (field.length < 10) field.push('Juvenil '+Math.floor(Math.random()*99));
    return {gk, field};
}

// ============================================================
// INICIAR TORNEO
// ============================================================
window.onload = () => {
    let sel = document.getElementById('team-select');
    sel.innerHTML = '<option value="custom">-- Crear Equipo Propio --</option>';
    DATABASE_TEAMS.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.name}</option>`);
    sel.value = 'u';
    verificarPlantillaGuardada();
};

function toggleCustomTeam() {
    document.getElementById('custom-team-fields').style.display =
        document.getElementById('team-select').value==='custom' ? 'block' : 'none';
}

function iniciarTorneo() {
    tournamentFormat = document.getElementById('format-select').value;
    leagueTeams=[]; globalStats={}; purchasedPlayers=[]; activeAIPlayers=[];
    state.upgrades={speed:false,shoot:false,gk:false};
    document.querySelectorAll('.buy-btn[id^="btn-upg-"]').forEach(b=>{b.innerText='200 ü™ô';b.disabled=false;});

    // Badge dificultad
    let dc = DIFFICULTY_CONFIG[currentDifficulty];
    let badge = document.getElementById('difficulty-badge');
    badge.className = dc.badgeClass;
    badge.innerText = dc.label;

    let val = document.getElementById('team-select').value;
    let availableDB = [...DATABASE_TEAMS].sort(()=>Math.random()-.5);

    if (val==='custom') {
        myTeamData = {id:'player', name:document.getElementById('custom-name').value.trim()||'Mi Equipo', c1:document.getElementById('custom-color1').value, c2:document.getElementById('custom-color2').value, power:75};
        leagueTeams.push(myTeamData);
    } else {
        myTeamData = DATABASE_TEAMS.find(t=>t.id===val);
        leagueTeams.push(myTeamData);
        availableDB = availableDB.filter(t=>t.id!==val);
    }

    if (tournamentFormat==='liga') {
        leagueTeams = leagueTeams.concat(val==='custom' ? availableDB.slice(0,17) : availableDB);
        leagueTeams.forEach(t=>{t.pts=0;t.pj=0;t.pg=0;t.pe=0;t.pp=0;t.gf=0;t.gc=0;t.dg=0; if(t.id!=='player') t.starting11=generateStarting11(t.id);});
        let n=leagueTeams.length, r=[...leagueTeams]; leagueSchedule=[];
        for(let i=0;i<n-1;i++){
            let j=[];
            for(let k=0;k<n/2;k++){let h=r[k],a=r[n-1-k]; if(k===0&&i%2!==0)j.push({home:a,away:h}); else j.push({home:h,away:a});}
            leagueSchedule.push(j); r.splice(1,0,r.pop());
        }
        currentMatchday=0;
    } else {
        let teams = [myTeamData,...availableDB.slice(0,15)].sort(()=>Math.random()-.5);
        teams.forEach(t=>{if(t.id!=='player')t.starting11=generateStarting11(t.id);});
        let r16=[];
        for(let i=0;i<16;i+=2) r16.push({home:teams[i],away:teams[i+1],isPlayerMatch:(teams[i].id===myTeamData.id||teams[i+1].id===myTeamData.id),played:false});
        tournamentBracket=[r16]; currentMatchday=0;
    }

    document.getElementById('setup-screen').style.display='none';
    document.getElementById('game-container').style.display='block';
    players.forEach(p=>{if(p.team==='azul')p.color=myTeamData.c1;});

    // Aplicar plantilla cargada
    if (state._loadSquad) aplicarPlantillaCargada(state._loadSquad);

    if (tournamentFormat==='liga') mostrarTablaLiga(); else mostrarBracketCopa();
}

// ============================================================
// PANTALLAS TORNEO
// ============================================================
function switchTab(tab, mode) {
    let suffix = mode==='copa' ? '-copa' : '';
    document.querySelectorAll('.tab-btn').forEach(b=>{
        let pid = b.parentElement?.parentElement?.parentElement?.id||'';
        if((mode==='copa'&&pid.includes('bracket'))||(mode==='league'&&pid.includes('league'))) b.classList.remove('active');
    });
    document.getElementById(`tab-${tab}${suffix}`)?.classList.add('active');
    if (mode==='league') {
        document.getElementById('table-posiciones').style.display = tab==='pos'?'table':'none';
        document.getElementById('table-stats').style.display = tab!=='pos'?'table':'none';
        if(tab!=='pos') renderStats(tab,'stats-body','stat-col-name');
    } else renderStats(tab,'stats-body-copa','stat-col-name-copa');
}

function renderStats(type, tbodyId, headerId) {
    let sorted = Object.values(globalStats).filter(s=>type==='gol'?s.goals>0:s.assists>0);
    sorted.sort((a,b)=>type==='gol'?b.goals-a.goals:b.assists-a.assists);
    document.getElementById(headerId).innerText = type==='gol'?'Goles':'Asist.';
    let tbody = document.getElementById(tbodyId); tbody.innerHTML='';
    sorted.slice(0,15).forEach((s,i)=>{ tbody.innerHTML+=`<tr><td>${i+1}</td><td style="text-align:left;font-weight:bold;">${s.name}</td><td style="text-align:left;"><span class="team-color-box" style="background:${s.c1}"></span>${s.teamName}</td><td>${type==='gol'?s.goals:s.assists}</td></tr>`; });
}

function mostrarTablaLiga() {
    leagueTeams.sort((a,b)=>b.pts!==a.pts?b.pts-a.pts:b.dg!==a.dg?b.dg-a.dg:b.gf-a.gf);
    let tbody=document.getElementById('standings-body'); tbody.innerHTML='';
    leagueTeams.forEach((t,i)=>{
        let cls=t.id===myTeamData.id?'my-team-row':'';
        tbody.innerHTML+=`<tr class="${cls}"><td>${i+1}</td><td style="text-align:left;"><span class="team-color-box" style="background:${t.c1}"></span>${t.name}</td><td>${t.pj}</td><td>${t.pg}</td><td>${t.pe}</td><td>${t.pp}</td><td>${t.gf}</td><td>${t.gc}</td><td>${t.dg}</td><td><strong>${t.pts}</strong></td></tr>`;
    });
    let jc=document.getElementById('next-match-card');
    if (currentMatchday < leagueSchedule.length) {
        document.getElementById('jornada-title').innerText=`Jornada ${currentMatchday+1} de 17`;
        let myMatch=leagueSchedule[currentMatchday].find(m=>m.home.id===myTeamData.id||m.away.id===myTeamData.id);
        currentMatchState.myTeamIsHome=myMatch.home.id===myTeamData.id;
        currentMatchState.enemyData=currentMatchState.myTeamIsHome?myMatch.away:myMatch.home;
        jc.innerHTML=`<div style="font-size:18px;margin-bottom:10px;color:#bdc3c7;">Tu siguiente partido:</div><div style="font-size:20px;font-weight:bold;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;"><span class="team-color-box" style="background:${myMatch.home.c1}"></span>${myMatch.home.name}<br><span style="font-size:14px;color:#bdc3c7;">vs</span><br><span class="team-color-box" style="background:${myMatch.away.c1}"></span>${myMatch.away.name}</div>`;
        document.getElementById('btn-play-liga').style.display='block';
    } else {
        document.getElementById('jornada-title').innerText='FIN DE TEMPORADA';
        document.getElementById('btn-play-liga').style.display='none';
        jc.innerHTML='';
        setTimeout(mostrarFinTemporada,500);
    }
    document.getElementById('tournament-overlay').style.display='flex';
    document.getElementById('bracket-screen').style.display='none';
    document.getElementById('league-screen').style.display='flex';
    switchTab('pos','league');
}

function mostrarBracketCopa() {
    const rnames=["Octavos de Final","Cuartos de Final","Semifinal","GRAN FINAL"];
    document.getElementById('round-title-copa').innerText=rnames[currentMatchday];
    let grid=document.getElementById('matches-grid-copa'); grid.innerHTML='';
    tournamentBracket[currentMatchday].forEach(m=>{
        let d=document.createElement('div'); d.className=`matchup ${m.isPlayerMatch?'player-match':''}`;
        let sc=m.played?`<span style="font-size:18px;color:var(--gold);">${m.scoreHome} - ${m.scoreAway}</span>`:'<span style="color:#666;">vs</span>';
        d.innerHTML=`<div class="team-row"><span class="team-color-box" style="background:${m.home.c1}"></span>${m.home.name}</div><div style="font-size:12px;color:#bdc3c7;margin:5px 0;">${sc}</div><div class="team-row"><span class="team-color-box" style="background:${m.away.c1}"></span>${m.away.name}</div>`;
        grid.appendChild(d);
    });
    let myM=tournamentBracket[currentMatchday].find(m=>m.isPlayerMatch);
    if(myM){currentMatchState.myTeamIsHome=myM.home.id===myTeamData.id;currentMatchState.enemyData=currentMatchState.myTeamIsHome?myM.away:myM.home;}
    document.getElementById('tournament-overlay').style.display='flex';
    document.getElementById('league-screen').style.display='none';
    document.getElementById('bracket-screen').style.display='flex';
    switchTab('gol','copa');
}

// ============================================================
// FIN TEMPORADA
// ============================================================
function mostrarFinTemporada() {
    let starsEl=document.getElementById('stars-bg'); starsEl.innerHTML='';
    for(let i=0;i<40;i++){let s=document.createElement('div');s.className='star';let sz=Math.random()*8+4;s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;animation-duration:${Math.random()*3+2}s;animation-delay:${Math.random()*3}s;opacity:0;`;starsEl.appendChild(s);}
    let ch=leagueTeams[0];
    document.getElementById('endseason-champion-name').innerText=ch.name.toUpperCase();
    document.getElementById('endseason-champion-name').style.color=ch.c1;
    document.getElementById('endseason-trophy').innerText=ch.id===myTeamData.id?'üèÜ':'ü•à';
    let ts=Object.values(globalStats).filter(s=>s.goals>0).sort((a,b)=>b.goals-a.goals)[0];
    let ta=Object.values(globalStats).filter(s=>s.assists>0).sort((a,b)=>b.assists-a.assists)[0];
    document.getElementById('awards-grid').innerHTML=`
        <div class="award-card"><span class="award-icon">üèÖ</span><div class="award-title">Campe√≥n Liga 1</div><div class="award-winner" style="color:${ch.c1}">${ch.name}</div><div class="award-value">${ch.pts} puntos</div></div>
        <div class="award-card"><span class="award-icon">‚öΩ</span><div class="award-title">Goleador</div><div class="award-winner">${ts?ts.name:'‚Äî'}</div><div class="award-value">${ts?ts.goals+' goles ¬∑ '+ts.teamName:''}</div></div>
        <div class="award-card"><span class="award-icon">üéØ</span><div class="award-title">Rey Asistencias</div><div class="award-winner">${ta?ta.name:'‚Äî'}</div><div class="award-value">${ta?ta.assists+' asist. ¬∑ '+ta.teamName:''}</div></div>`;
    document.getElementById('endseason-overlay').style.display='flex';
    document.getElementById('tournament-overlay').style.display='none';
}

// ============================================================
// SIMULADOR IA
// ============================================================
function simularMarcadorIA(home, away) {
    let pDiff=(home.power+5)-away.power;
    if(home.id===myTeamData.id) pDiff+=currentDifficulty==='easy'?15:currentDifficulty==='hard'?-20:0;
    else if(away.id===myTeamData.id) pDiff-=currentDifficulty==='easy'?15:currentDifficulty==='hard'?-20:0;
    let sH=Math.floor(Math.random()*3),sA=Math.floor(Math.random()*3);
    if(pDiff>=20){sH+=2;sA=0;} else if(pDiff<=-20){sA+=2;sH=0;}
    else if(pDiff>=10){sH++;sA=Math.max(0,sA-1);} else if(pDiff<=-10){sA++;sH=Math.max(0,sH-1);}
    if(Math.random()>.8)sH++; if(Math.random()>.8)sA++;
    return {h:sH,a:sA};
}

// ============================================================
// PARTIDOS
// ============================================================
function elegirFormacionPrevia(formacion) {
    // Marcar visualmente
    document.querySelectorAll('.formacion-opt').forEach(b => {
        b.classList.toggle('selected', b.innerText.startsWith(formacion));
    });
    // Aplicar formaci√≥n
    currentFormation = formacion;
    document.getElementById('formation-select').value = formacion;
    let f = formacionesDB[formacion];
    let campo = players.filter(p => p.team === 'azul' && p.rolBase !== 'Portero');
    campo.forEach((p, i) => { p.baseX = f[i].x; p.baseY = f[i].y; p.rolBase = f[i].rol; p.reset(); });
    // Cerrar modal y arrancar
    primerPartido = false;
    document.getElementById('formacion-previa-modal').style.display = 'none';
    // Ahora s√≠ arrancar el partido
    document.getElementById('tournament-overlay').style.display = 'none';
    penaltyActive = false;
    currentMatchState.actualMyColor = myTeamData.c1;
    currentMatchState.actualEnemyColor = currentMatchState.enemyData.c1;
    if (colorDistance(myTeamData.c1, currentMatchState.enemyData.c1) < 100) {
        if (currentMatchState.myTeamIsHome) currentMatchState.actualEnemyColor = currentMatchState.enemyData.c2;
        else currentMatchState.actualMyColor = myTeamData.c2;
    }
    document.getElementById('scoreAzul').innerText = myTeamData.name.substring(0,10) + ': 0';
    document.getElementById('scoreAzul').style.color = currentMatchState.actualMyColor;
    document.getElementById('scoreRojo').innerText = currentMatchState.enemyData.name.substring(0,10) + ': 0';
    document.getElementById('scoreRojo').style.color = currentMatchState.actualEnemyColor;
    players.forEach(p => { if(p.team==='azul') p.color=currentMatchState.actualMyColor; if(p.team==='rojo') p.color=currentMatchState.actualEnemyColor; });
    mejorarEquipoRival(currentMatchday);
    reiniciarPartido();
}

function empezarPartido() {
    // Primer partido: pedir formaci√≥n antes de arrancar
    if (primerPartido) {
        // Marcar la formaci√≥n actual como seleccionada
        document.querySelectorAll('.formacion-opt').forEach(b => {
            b.classList.toggle('selected', b.innerText.startsWith(currentFormation));
        });
        document.getElementById('formacion-previa-modal').style.display = 'flex';
        return;
    }
    document.getElementById('tournament-overlay').style.display='none';
    penaltyActive=false;

    currentMatchState.actualMyColor=myTeamData.c1;
    currentMatchState.actualEnemyColor=currentMatchState.enemyData.c1;
    if(colorDistance(myTeamData.c1,currentMatchState.enemyData.c1)<100){
        if(currentMatchState.myTeamIsHome) currentMatchState.actualEnemyColor=currentMatchState.enemyData.c2;
        else currentMatchState.actualMyColor=myTeamData.c2;
    }
    document.getElementById('scoreAzul').innerText=`${myTeamData.name.substring(0,10)}: 0`;
    document.getElementById('scoreAzul').style.color=currentMatchState.actualMyColor;
    document.getElementById('scoreRojo').innerText=`${currentMatchState.enemyData.name.substring(0,10)}: 0`;
    document.getElementById('scoreRojo').style.color=currentMatchState.actualEnemyColor;
    players.forEach(p=>{if(p.team==='azul')p.color=currentMatchState.actualMyColor;if(p.team==='rojo')p.color=currentMatchState.actualEnemyColor;});
    mejorarEquipoRival(currentMatchday);
    reiniciarPartido();
}

function mejorarEquipoRival(idx) {
    let dc=DIFFICULTY_CONFIG[currentDifficulty];
    let base=tournamentFormat==='liga'?Math.floor(idx/1.5)+1:(idx*3)+2;
    let n=Math.round(base*dc.aiUpgradesPerJornada);
    let redField=players.filter(p=>p.team==='rojo'&&p.rolBase!=='Portero');
    let names=[...currentMatchState.enemyData.starting11.field];
    redField.forEach((p,i)=>{p.type='Novato';p.subType='Basico';p.resetStats();p.playerName=names[i];});
    let redGK=players.find(p=>p.team==='rojo'&&p.rolBase==='Portero');
    if(redGK){redGK.type='Novato';redGK.subType='Basico';redGK.resetStats();redGK.playerName=currentMatchState.enemyData.starting11.gk;}
    let db=ROSTERS[currentMatchState.enemyData.id]||ROSTERS['gen'];
    activeAIPlayers=[];
    [...redField].sort(()=>Math.random()-.5).slice(0,n).forEach(p=>{
        let sub='Basico',cat='Central';
        if(p.rolBase==='Lateral'){sub=Math.random()>.5?'Lateral Ofensivo':'Lateral Defensivo';cat='Lateral';}
        else if(p.rolBase==='Medio'){sub=Math.random()>.5?'MCD':'Mediapunta';cat='Medio';}
        else if(p.rolBase==='Delantero'){let r=Math.random();sub=r<.33?'Centrodelantero':r<.66?'Segundo Delantero':'Extremo';cat=sub==='Extremo'?'Extremo':'Delantero';}
        p.aplicarEspecialidad(p.rolBase,sub);
        p.speed*=dc.aiSpeedMult; p.kickPower*=dc.aiKickMult;
        let pool=(db[cat]||ROSTERS['gen'][cat]||[]).filter(n=>!activeAIPlayers.includes(n));
        if(!pool.length)pool=['Juvenil '+Math.floor(Math.random()*99)];
        p.playerName=pool[Math.floor(Math.random()*pool.length)];
        activeAIPlayers.push(p.playerName);
    });
    if(n>4&&redGK){redGK.aplicarEspecialidad('Portero',Math.random()>.5?'Defensivo':'Ofensivo');redGK.saveSkill*=dc.aiSaveMult;}
}

function simularRestoYAvanzar() {
    if(tournamentFormat==='liga') simularLiga();
    else {
        if(simulandoCopa) return; // evitar doble llamada
        simulandoCopa = true;
        simularCopa();
    }
}

function simularLiga() {
    let jornada=leagueSchedule[currentMatchday];
    let res=`RESULTADOS FECHA ${currentMatchday+1}:\n\n`;
    for(let m of jornada){
        let isMe=(m.home.id===myTeamData.id||m.away.id===myTeamData.id);
        let sH,sA;
        if(!isMe){
            let r=simularMarcadorIA(m.home,m.away);sH=r.h;sA=r.a;
            let pH=m.home.starting11?m.home.starting11.field.slice(0,5):['Delantero'];
            for(let g=0;g<sH;g++){recordStat(pH[Math.floor(Math.random()*pH.length)],m.home,'goal');if(Math.random()>.5)recordStat(pH[Math.floor(Math.random()*pH.length)],m.home,'assist');}
            let pA=m.away.starting11?m.away.starting11.field.slice(0,5):['Delantero'];
            for(let g=0;g<sA;g++){recordStat(pA[Math.floor(Math.random()*pA.length)],m.away,'goal');if(Math.random()>.5)recordStat(pA[Math.floor(Math.random()*pA.length)],m.away,'assist');}
        } else {
            sH=currentMatchState.myTeamIsHome?state.golesAzul:state.golesRojo;
            sA=currentMatchState.myTeamIsHome?state.golesRojo:state.golesAzul;
        }
        actualizarStats(m.home,sH,sA); actualizarStats(m.away,sA,sH);
        res+=`[${sH}] ${m.home.name} ‚Äî ${m.away.name} [${sA}]\n`;
    }
    mostrarAlerta(`Jornada ${currentMatchday+1} finalizada`,res,()=>{currentMatchday++;mostrarTablaLiga();});
}

function simularCopa() {
    let current=tournamentBracket[currentMatchday],next=[],res=`RESULTADOS ${document.getElementById('round-title-copa').innerText}:\n\n`;
    for(let m of current){
        // GUARD: no simular dos veces el mismo partido
        if(m.played) {
            let penStr=m.penScoreHome!==undefined?` (pen: ${m.penScoreHome}-${m.penScoreAway})`:'';
            res+=`[${m.scoreHome}] ${m.home.name} ‚Äî ${m.away.name} [${m.scoreAway}]${penStr}\n`;
            continue;
        }
        if(!m.isPlayerMatch){
            let r=simularMarcadorIA(m.home,m.away);
            m.scoreHome=r.h; m.scoreAway=r.a;
            m.penScoreHome=undefined; m.penScoreAway=undefined;
            if(m.scoreHome===m.scoreAway){
                // Penales IA: aleatorio simple sin acumulacion
                m.winner=Math.random()>.5?m.home:m.away;
                let penH=Math.floor(Math.random()*3)+3;
                let penA=penH - (Math.floor(Math.random()*2)+1);
                if(penA<0)penA=0;
                m.penScoreHome=m.winner===m.home?penH:penA;
                m.penScoreAway=m.winner===m.away?penH:penA;
            } else {
                m.winner=m.scoreHome>m.scoreAway?m.home:m.away;
            }
            let pH=m.home.starting11?m.home.starting11.field.slice(0,5):['Del'];
            for(let g=0;g<m.scoreHome;g++)recordStat(pH[Math.floor(Math.random()*pH.length)],m.home,'goal');
            let pA=m.away.starting11?m.away.starting11.field.slice(0,5):['Del'];
            for(let g=0;g<m.scoreAway;g++)recordStat(pA[Math.floor(Math.random()*pA.length)],m.away,'goal');
        } else {
            m.scoreHome=currentMatchState.myTeamIsHome?state.golesAzul:state.golesRojo;
            m.scoreAway=currentMatchState.myTeamIsHome?state.golesRojo:state.golesAzul;
            m.penScoreHome=undefined; m.penScoreAway=undefined;
            m.winner=m.scoreHome>m.scoreAway?m.home:(m.scoreAway>m.scoreHome?m.away:(state.golesAzul>state.golesRojo?m.home:m.away));
        }
        m.played=true;
        let penStr=m.penScoreHome!==undefined?` (pen: ${m.penScoreHome}-${m.penScoreAway})`:'';
        res+=`[${m.scoreHome}] ${m.home.name} ‚Äî ${m.away.name} [${m.scoreAway}]${penStr}\n`;
    }
    for(let i=0;i<current.length;i+=2){let m1=current[i],m2=current[i+1];if(m2)next.push({home:m1.winner,away:m2.winner,isPlayerMatch:(m1.winner===myTeamData||m2.winner===myTeamData),played:false});}
    let myPrev=current.find(m=>m.isPlayerMatch);
    mostrarAlerta('Resumen de Ronda',res,()=>{
        if(myPrev.winner!==myTeamData){
            autoGuardarPlantilla();
            mostrarAlerta('¬°ELIMINADO!','Tu equipo fue eliminado de la Copa.\n\nüíæ Plantilla guardada autom√°ticamente.',()=>location.reload());
        }
        else if(next.length>0){simulandoCopa=false;tournamentBracket.push(next);currentMatchday++;mostrarBracketCopa();}
        else {
            let ts=Object.values(globalStats).filter(s=>s.goals>0).sort((a,b)=>b.goals-a.goals)[0];
            document.getElementById('awards-grid').innerHTML=`<div class="award-card" style="grid-column:1/-1"><span class="award-icon">üèÜ</span><div class="award-title">Campe√≥n de la Copa</div><div class="award-winner" style="color:${myTeamData.c1}">${myTeamData.name}</div></div><div class="award-card" style="grid-column:1/-1"><span class="award-icon">‚öΩ</span><div class="award-title">Goleador</div><div class="award-winner">${ts?ts.name:'‚Äî'}</div><div class="award-value">${ts?ts.goals+' goles':''}</div></div>`;
            document.getElementById('endseason-trophy').innerText='üèÜ';
            document.getElementById('endseason-champion-name').innerText=myTeamData.name.toUpperCase();
            document.getElementById('endseason-champion-name').style.color=myTeamData.c1;
            let starsEl=document.getElementById('stars-bg');starsEl.innerHTML='';
            for(let i=0;i<40;i++){let s=document.createElement('div');s.className='star';let sz=Math.random()*8+4;s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;animation-duration:${Math.random()*3+2}s;animation-delay:${Math.random()*3}s;opacity:0;`;starsEl.appendChild(s);}
            document.getElementById('endseason-overlay').style.display='flex';
            document.getElementById('tournament-overlay').style.display='none';
        }
    });
}

function actualizarStats(t,gf,gc){t.pj++;t.gf+=gf;t.gc+=gc;t.dg=t.gf-t.gc;if(gf>gc){t.pg++;t.pts+=3;}else if(gf===gc){t.pe++;t.pts++;}else t.pp++;}

// ============================================================
// MERCADO
// ============================================================
function abrirMercado(){state.pausado=true;document.getElementById('shop-modal').style.display='block';}
function cerrarMercado(){state.pausado=false;document.getElementById('shop-modal').style.display='none';}
function cerrarSeleccionJugador(){document.getElementById('player-select-modal').style.display='none';document.getElementById('shop-modal').style.display='block';}
function cancelarCompra(){state.modoFichaje=null;state.pausado=false;document.getElementById('selection-overlay').style.display='none';}

function comprarMejora(tipo,costo,btn){
    if(state.monedas>=costo){state.monedas-=costo;coinsEl.innerText=state.monedas;state.upgrades[tipo]=true;playCoin();btn.innerText='‚úì COMPRADO';btn.disabled=true;mostrarAlerta('Mejora Adquirida','¬°Tu equipo recibi√≥ la mejora para el resto del torneo!');}
    else mostrarAlerta('Sin fondos','No tienes suficientes monedas.');
}

function iniciarSeleccionJugador(rolReq,tipoGen,subTipo,costo=50){
    let list=document.getElementById('player-options-list');list.innerHTML='';
    let db=ROSTERS[myTeamData.id]||ROSTERS['gen'];
    let cat='Delantero';
    if(rolReq==='Portero')cat='Portero';else if(rolReq==='Central')cat='Central';else if(rolReq==='Lateral')cat='Lateral';
    else if(['MCD','Mediapunta','Box to Box'].includes(subTipo))cat='Medio';
    else if(subTipo==='Extremo')cat='Extremo';
    let choices=(db[cat]||ROSTERS['gen'][cat]||[]).filter(n=>!purchasedPlayers.includes(n));
    if(!choices.length)choices=['Juvenil '+Math.floor(Math.random()*99)];
    choices.forEach(name=>{
        let d=document.createElement('div');d.className='shop-item item-med';d.style.cursor='pointer';
        d.innerHTML=`<div style="text-align:left;font-weight:bold;font-size:16px;">üë§ ${name}</div><span style="color:var(--gold);font-size:13px;">${costo}ü™ô</span>`;
        d.onclick=()=>procesarCompra(rolReq,tipoGen,subTipo,costo,name);list.appendChild(d);
    });
    document.getElementById('shop-modal').style.display='none';
    document.getElementById('player-select-modal').style.display='block';
}

function procesarCompra(rol,tipo,sub,costo,name){
    if(state.monedas>=costo){
        let avail=players.filter(p=>p.team==='azul'&&p.type==='Novato'&&(rol==='Cualquiera'?p.rolBase!=='Portero':p.rolBase===rol));
        if(avail.length){
            document.getElementById('player-select-modal').style.display='none';
            state.modoFichaje={rol,tipo,sub,costo,name};
            document.getElementById('selection-text').innerText=`Asigna a ${name} haciendo clic en un "Novato"`;
            document.getElementById('selection-overlay').style.display='block';
        } else mostrarAlerta('Sin espacio','No tienes m√°s espacio para este rol.');
    } else mostrarAlerta('Sin fondos','No tienes suficientes monedas.');
}

canvas.addEventListener('click',(e)=>{
    if(penaltyActive&&penaltyPhase==='select'){
        // Selecci√≥n de pateadores
        const rect=canvas.getBoundingClientRect();
        const cx=e.clientX-rect.left,cy=e.clientY-rect.top;
        for(let p of players){
            if(p.team==='azul'&&p.rolBase!=='Portero'&&Math.hypot(p.x-cx,p.y-cy)<=p.radius+15){
                let idx=penaltyKickers.indexOf(p);
                if(idx>=0){ penaltyKickers.splice(idx,1); } // deseleccionar con clic
                else if(penaltyKickers.length<5){ penaltyKickers.push(p); }
                actualizarUISeleccionPenal();
                return;
            }
        }
        return;
    }
    if(!state.modoFichaje)return;
    const rect=canvas.getBoundingClientRect();
    const cx=e.clientX-rect.left,cy=e.clientY-rect.top;
    for(let p of players){
        let ok=state.modoFichaje.rol==='Cualquiera'?p.rolBase!=='Portero':p.rolBase===state.modoFichaje.rol;
        if(p.team==='azul'&&p.type==='Novato'&&ok&&Math.hypot(p.x-cx,p.y-cy)<=p.radius+15){
            state.monedas-=state.modoFichaje.costo;coinsEl.innerText=state.monedas;
            p.aplicarEspecialidad(state.modoFichaje.tipo,state.modoFichaje.sub);
            p.playerName=state.modoFichaje.name;purchasedPlayers.push(p.playerName);
            playCoin();state.modoFichaje=null;
            document.getElementById('selection-overlay').style.display='none';
            state.pausado=false;return;
        }
    }
});

// ============================================================
// ‚öΩ SISTEMA DE PENALES ANIMADOS EN CANVAS
// ============================================================
let penaltyActive = false;
let penaltyPhase = null; // 'select' | 'animate'
let penaltyKickers = [];  // jugadores azul elegidos
let penaltyAIKickers = [];
let penaltyResults = {home:[], away:[]};
let penaltyAnimQueue = []; // {team, player, scored} secuencia
let penaltyAnimIdx = 0;
let penaltyAnimState = null; // estado actual de la animaci√≥n
let penaltyAnimTimer = 0;
let penaltyCallback = null;

function iniciarFasePenales(cb) {
    penaltyActive = true;
    penaltyPhase = 'select';
    penaltyKickers = [];
    penaltyAIKickers = [];
    penaltyResults = {home:[], away:[]};
    penaltyAnimQueue = [];
    penaltyAnimIdx = 0;
    penaltyAnimState = null;
    penaltyCallback = cb;
    state.partidoActivo = false;
    state.pausado = true;

    // Mover todos los jugadores a sus posiciones de penal
    reposicionarParaPenales();

    // Mostrar overlay de selecci√≥n
    document.getElementById('penalty-select-overlay').style.display='block';
    actualizarUISeleccionPenal();
}

function reposicionarParaPenales() {
    // Todos los jugadores se alinean en el centro del campo
    let azulField = players.filter(p=>p.team==='azul'&&p.rolBase!=='Portero');
    let rojoField = players.filter(p=>p.team==='rojo'&&p.rolBase!=='Portero');
    let azulGK = players.find(p=>p.team==='azul'&&p.rolBase==='Portero');
    let rojoGK = players.find(p=>p.team==='rojo'&&p.rolBase==='Portero');

    // Equipo azul se agrupa a la derecha del centro
    azulField.forEach((p,i)=>{p.x=500+Math.floor(i/5)*25;p.y=150+i%5*50;});
    // Equipo rojo se agrupa a la izquierda del centro
    rojoField.forEach((p,i)=>{p.x=275-Math.floor(i/5)*25;p.y=150+i%5*50;});
    // Porteros en sus porter√≠as
    if(azulGK){azulGK.x=30;azulGK.y=250;}
    if(rojoGK){rojoGK.x=770;rojoGK.y=250;}
    ball.x=canvas.width/2; ball.y=canvas.height/2; ball.vx=0; ball.vy=0;
}

function actualizarUISeleccionPenal() {
    let list=document.getElementById('pen-selected-list');
    // Cada tag tiene un boton X para quitar
    list.innerHTML=penaltyKickers.map((p,i)=>
        `<span class="pen-tag" style="cursor:pointer;" onclick="quitarPateador(${i})" title="Quitar">üë§ ${p.playerName||'Jugador'} ‚úï</span>`
    ).join('');
    // Contador
    let counter=document.getElementById('pen-counter');
    if(counter) counter.innerText=penaltyKickers.length+'/5 seleccionados ‚Äî clic en jugador para agregar/quitar';
    let btn=document.getElementById('btn-confirmar-penales');
    btn.style.display=penaltyKickers.length===5?'inline-block':'none';
}

function quitarPateador(idx){
    penaltyKickers.splice(idx,1);
    actualizarUISeleccionPenal();
}

function confirmarPateadores() {
    document.getElementById('penalty-select-overlay').style.display='none';

    // IA elige 5 aleatoriamente
    let rojoField=players.filter(p=>p.team==='rojo'&&p.rolBase!=='Portero');
    penaltyAIKickers=[...rojoField].sort(()=>Math.random()-.5).slice(0,5);

    // Construir cola alternada: home1, away1, home2, away2...
    for(let i=0;i<5;i++){
        penaltyAnimQueue.push({team:'home', player:penaltyKickers[i]});
        penaltyAnimQueue.push({team:'away', player:penaltyAIKickers[i]});
    }

    // Mostrar HUD
    document.getElementById('penalty-hud').style.display='block';
    actualizarPenalHUD();

    // Arrancar primera animaci√≥n
    lanzarSiguienteAnim();
}

function lanzarSiguienteAnim() {
    if(penaltyAnimIdx >= penaltyAnimQueue.length){
        // Verificar resultado final
        setTimeout(finalizarPenales,1000);
        return;
    }

    // Check si ya hay ganador matem√°tico
    let hR=penaltyResults.home, aR=penaltyResults.away;
    let round=Math.floor(penaltyAnimIdx/2);
    if(round>=1){
        let homeRem=5-hR.length, awayRem=5-aR.length;
        let homePts=hR.filter(Boolean).length, awayPts=aR.filter(Boolean).length;
        if(homePts>awayPts+awayRem||awayPts>homePts+homeRem){
            setTimeout(finalizarPenales,600);
            return;
        }
    }

    let entry=penaltyAnimQueue[penaltyAnimIdx];
    let isHome=entry.team==='home';
    let shooter=entry.player;
    let gkPlayer=isHome ? players.find(p=>p.team==='rojo'&&p.rolBase==='Portero') : players.find(p=>p.team==='azul'&&p.rolBase==='Portero');

    // ¬øMarc√≥?
    let dc=DIFFICULTY_CONFIG[currentDifficulty];
    let scored = isHome ? Math.random()>(dc.penSaveChance) : Math.random()>(dc.penMissChance);

    // Posici√≥n inicial del pateador y porter√≠a objetivo
    // Los penales siempre se patean hacia la porter√≠a derecha (roja) cuando es home, y hacia la izquierda (azul) cuando es away
    let penSpotX = isHome ? 620 : 180; // distancia desde porter√≠a
    let penSpotY = 250;
    let goalX = isHome ? canvas.width : 0;
    let goalTargetY = GOAL_Y_START + 30 + Math.random()*90; // zona donde cae el remate

    // Posici√≥n portero
    let gkX = isHome ? canvas.width-20 : 20;
    if(gkPlayer){gkPlayer.x=gkX;gkPlayer.y=250;}
    // Shooter empieza lejos, camina al punto
    if(shooter){shooter.x=penSpotX+(isHome?-80:80);shooter.y=penSpotY;}

    penaltyAnimState = {
        phase:'walk',        // walk ‚Üí kick ‚Üí fly ‚Üí result
        shooter, gkPlayer, isHome, scored, goalX, goalTargetY, penSpotX, penSpotY,
        ballStartX: penSpotX, ballStartY: penSpotY,
        ballX: penSpotX+(isHome?-80:80), ballY: penSpotY,
        timer:0,
        gkSaveY: scored ? goalTargetY+200 : goalTargetY+(Math.random()>0.5?-1:1)*(Math.random()*20+5),
        shooterArrived: false,
        label: (shooter?.playerName||'Jugador').split(' ').pop(),
        entryTeam: entry.team
    };

    document.getElementById('phud-turn').innerText=`${isHome?'üîµ':'üî¥'} ${penaltyAnimState.label} patea...`;
}

function stepPenaltyAnim() {
    if(!penaltyActive||penaltyPhase!=='animate'&&penaltyPhase!==null) return;
    if(!penaltyAnimState) return;
    let s=penaltyAnimState;
    s.timer++;

    if(s.phase==='walk'){
        // Pateador camina hacia el punto
        let targetX=s.penSpotX+(s.isHome?-30:30);
        let dx=targetX-s.shooter.x;
        if(Math.abs(dx)<3){s.shooter.x=targetX;s.phase='charge';s.timer=0;}
        else s.shooter.x+=dx*0.12;
        s.ballX=s.penSpotX; s.ballY=s.penSpotY;
    } else if(s.phase==='charge'){
        // Toma carrera (retrocede un poco y avanza)
        if(s.timer<20){
            s.shooter.x += s.isHome ? -0.8 : 0.8; // retrocede
        } else if(s.timer<40){
            s.shooter.x += s.isHome ? 3 : -3; // corre hacia el bal√≥n
        } else {
            s.phase='kick'; s.timer=0;
        }
        s.ballX=s.penSpotX; s.ballY=s.penSpotY;
    } else if(s.phase==='kick'){
        // El pie toca el bal√≥n (frame √∫nico de impacto)
        s.phase='fly'; s.timer=0;
        playKick();
    } else if(s.phase==='fly'){
        // Bal√≥n vuela hacia la porter√≠a
        let t=s.timer/35; // 0..1
        s.ballX=s.penSpotX+(s.goalX-s.penSpotX)*t;
        s.ballY=s.penSpotY+(s.goalTargetY-s.penSpotY)*t - Math.sin(t*Math.PI)*40;
        // Portero se mueve
        if(s.gkPlayer){
            let gkTarget=s.gkSaveY;
            s.gkPlayer.y+=(gkTarget-s.gkPlayer.y)*0.15;
        }
        if(s.timer>=35){
            s.phase='result'; s.timer=0;
            if(s.scored) playGoal();
        }
    } else if(s.phase==='result'){
        // Mostrar resultado 90 frames
        if(s.timer===1){
            // Registrar
            if(s.entryTeam==='home') penaltyResults.home.push(s.scored);
            else penaltyResults.away.push(s.scored);
            actualizarPenalHUD();
            // Mostrar mini animaci√≥n gol
            if(s.scored) mostrarAnimacionGol(s.label, s.isHome?currentMatchState.actualMyColor:currentMatchState.actualEnemyColor);
        }
        if(s.timer>=90){
            // Siguiente
            penaltyAnimIdx++;
            reposicionarParaPenales();
            lanzarSiguienteAnim();
        }
    }
}

function actualizarPenalHUD(){
    document.getElementById('phud-home').innerText=penaltyResults.home.filter(Boolean).length;
    document.getElementById('phud-away').innerText=penaltyResults.away.filter(Boolean).length;
    document.getElementById('phud-kicks-home').innerText=penaltyResults.home.map(r=>r?'‚úÖ':'‚ùå').join(' ');
    document.getElementById('phud-kicks-away').innerText=penaltyResults.away.map(r=>r?'‚úÖ':'‚ùå').join(' ');
}

function finalizarPenales(){
    let homeGols=penaltyResults.home.filter(Boolean).length;
    let awayGols=penaltyResults.away.filter(Boolean).length;

    // Muerte sudita: agregar UN par mas animado y relanzar
    if(homeGols===awayGols){
        document.getElementById('phud-turn').innerText='MUERTE SUDITA';
        let sdIdxHome=penaltyResults.home.length % penaltyKickers.length;
        let sdIdxAway=penaltyResults.away.length % penaltyAIKickers.length;
        penaltyAnimQueue.push({team:'home', player:penaltyKickers[sdIdxHome]});
        penaltyAnimQueue.push({team:'away', player:penaltyAIKickers[sdIdxAway]});
        setTimeout(()=>lanzarSiguienteAnim(), 800);
        return;
    }

    let homeWon=homeGols>awayGols;
    document.getElementById('phud-turn').innerText=homeWon
        ? 'üéâ Ganaste en penales! ' + homeGols + '-' + awayGols
        : 'üòî Perdiste en penales ' + homeGols + '-' + awayGols;

    setTimeout(()=>{
        document.getElementById('penalty-hud').style.display='none';
        penaltyActive=false;
        state.pausado=false;
        if(homeWon) state.golesAzul++; else state.golesRojo++;
        if(penaltyCallback) penaltyCallback(homeWon);
    },2500);
}

// ============================================================
// ANIMACION GOL EN CAMPO
// ============================================================
function mostrarAnimacionGol(scorerName, teamColor) {
    let overlay=document.getElementById('goal-overlay');
    let txt=document.getElementById('goal-text');
    let stxt=document.getElementById('goal-scorer-text');
    overlay.querySelectorAll('.confetti-piece').forEach(c=>c.remove());
    overlay.style.display='block';
    txt.style.color=teamColor||'#f1c40f';
    txt.style.transform='translate(-50%,-50%) scale(1)';
    stxt.style.opacity='1';
    stxt.innerText=scorerName?`‚öΩ ${scorerName}`:'';
    const colors=['#f1c40f','#e74c3c','#3498db','#2ecc71','#9b59b6','#fff'];
    for(let i=0;i<35;i++){
        let c=document.createElement('div');c.className='confetti-piece';
        c.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*30}%;background:${colors[Math.floor(Math.random()*colors.length)]};width:${Math.random()*12+6}px;height:${Math.random()*12+6}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-delay:${Math.random()*.5}s;animation-duration:${Math.random()+1}s;`;
        overlay.appendChild(c);
    }
    setTimeout(()=>{txt.style.transform='translate(-50%,-50%) scale(0)';stxt.style.opacity='0';setTimeout(()=>overlay.style.display='none',400);},2200);
}

// ============================================================
// CLASES MOTOR
// ============================================================
class Ball {
    constructor(){this.reset();this.radius=6;this.color='#fff';this.friction=0.98;}
    reset(){this.x=canvas.width/2;this.y=canvas.height/2;this.vx=0;this.vy=0;this.lastTouch=null;this.assistTouch=null;}
    update(){
        this.x+=this.vx;this.y+=this.vy;this.vx*=this.friction;this.vy*=this.friction;
        if(this.y-this.radius<0){this.y=this.radius;this.vy*=-1;}else if(this.y+this.radius>canvas.height){this.y=canvas.height-this.radius;this.vy*=-1;}
        if(this.x-this.radius<0){if(this.y>GOAL_Y_START&&this.y<GOAL_Y_END)window.anotarGol('rojo',this.lastTouch,this.assistTouch);else{this.x=this.radius;this.vx*=-1;}}
        if(this.x+this.radius>canvas.width){if(this.y>GOAL_Y_START&&this.y<GOAL_Y_END)window.anotarGol('azul',this.lastTouch,this.assistTouch);else{this.x=canvas.width-this.radius;this.vx*=-1;}}
    }
    draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.stroke();ctx.closePath();}
}

class Player {
    constructor(bx,by,color,team,rolBase,numero){
        this.baseX=bx;this.baseY=by;this.x=bx;this.y=by;this.color=color;this.team=team;this.rolBase=rolBase;this.numero=numero;
        this.type='Novato';this.subType='Basico';this.cooldown=0;this.playerName=null;this.wallPassActive=0;this.resetStats();
    }
    resetStats(){this.radius=9;this.speed=2.5;this.kickPower=5;this.rangoTiro=250;this.precisionPase=0.5;this.saveSkill=0.2;this.wallPassActive=0;}
    reset(){this.x=this.baseX;this.y=this.baseY;this.cooldown=0;this.wallPassActive=0;}
    aplicarEspecialidad(t,s){
        this.type=t;this.subType=s;
        switch(s){
            case 'Ofensivo':     this.radius=11;this.speed=2.5;this.kickPower=6;this.saveSkill=0.4;this.precisionPase=0.8;break;
            case 'Defensivo':    this.radius=15;this.speed=3.5;this.kickPower=8;this.saveSkill=0.9;this.precisionPase=0.2;break;
            case 'Central':      this.radius=13;this.speed=1.6;this.kickPower=7;this.rangoTiro=0;break;
            case 'Lateral Ofensivo':this.radius=9;this.speed=3.5;this.kickPower=6;this.precisionPase=0.8;break;
            case 'Lateral Defensivo':this.radius=9;this.speed=3.2;this.kickPower=4;this.precisionPase=0.3;break;
            case 'MCD':          this.radius=11;this.speed=2.5;this.kickPower=5;this.precisionPase=0.5;break;
            case 'Mediapunta':   this.radius=9;this.speed=2.8;this.kickPower=6;this.precisionPase=1.0;break;
            case 'Box to Box':   this.radius=10;this.speed=3.2;this.kickPower=7;this.precisionPase=0.6;this.rangoTiro=300;break;
            case 'Extremo':      this.radius=8;this.speed=4.0;this.kickPower=5;this.precisionPase=0.8;break;
            case 'Centrodelantero':this.radius=13;this.speed=1.6;this.kickPower=9;this.rangoTiro=180;break;
            case 'Segundo Delantero':this.radius=9;this.speed=3.2;this.kickPower=6;this.rangoTiro=350;break;
        }
    }
    update(ballObj,allPlayers){
        if(this.cooldown>0)this.cooldown--;
        if(state.pausado||penaltyActive)return;
        const myTeam=allPlayers.filter(p=>p.team===this.team);
        const attackDir=this.team==='azul'?1:-1;
        const enemyGoalX=this.team==='azul'?canvas.width:0;
        const enemyGoalY=GOAL_Y_START+GOAL_HEIGHT/2;
        let targetX=this.baseX,targetY=this.baseY;
        let spd=this.speed*(this.team==='azul'&&state.upgrades.speed?1.15:1.0);

        if(this.rolBase==='Portero'){
            targetX=this.baseX;
            if(this.subType==='Ofensivo'&&((this.team==='azul'&&ballObj.x<canvas.width/2)||(this.team==='rojo'&&ballObj.x>canvas.width/2)))targetX+=attackDir*40;
            let sk=this.saveSkill+(this.team==='azul'&&state.upgrades.gk?0.25:0);
            let err=Math.random()>sk?(Math.random()-.5)*60:0;
            targetY=Math.max(GOAL_Y_START,Math.min(GOAL_Y_END,ballObj.y+err));
        } else {
            let cl=myTeam.reduce((c,p)=>p.rolBase==='Portero'?c:Math.hypot(p.x-ballObj.x,p.y-ballObj.y)<Math.hypot(c.x-ballObj.x,c.y-ballObj.y)?p:c,myTeam[1]||myTeam[0]);
            const bOff=(ballObj.x-canvas.width/2)*0.4;
            const atk=(this.team==='azul'&&ballObj.x>canvas.width/2)||(this.team==='rojo'&&ballObj.x<canvas.width/2);
            if(this.wallPassActive>0)this.wallPassActive--;
            if(this===cl){targetX=ballObj.x;targetY=ballObj.y;}
            else{
                if(this.subType==='Central')targetX=this.baseX+bOff*.1;
                else if(this.subType==='Lateral Ofensivo'){targetX=atk?enemyGoalX-attackDir*150:this.baseX+bOff*.8;spd=atk?spd*1.4:spd*.8;}
                else if(this.subType==='Lateral Defensivo'){targetX=this.baseX+bOff*.15;targetY=this.baseY+(ballObj.y-this.baseY)*.3;spd*=1.28;}
                else if(this.subType==='MCD'){
                    targetX=this.baseX+bOff*.15;
                    let dB=Math.hypot(ballObj.x-this.x,ballObj.y-this.y),dCB=Math.hypot(cl.x-ballObj.x,cl.y-ballObj.y);
                    if(!atk){if(dCB<25){targetX=this.baseX;targetY=this.baseY+(ballObj.y-this.baseY)*.2;}else if(dB<200){targetX=ballObj.x;targetY=ballObj.y;spd*=1.4;}else targetY=this.baseY+(ballObj.y-this.baseY)*.5;}
                    else targetY=this.baseY+(ballObj.y-this.baseY)*.3;
                }
                else if(this.subType==='Mediapunta'){targetX=this.baseX+bOff*.6;targetY=this.baseY+(ballObj.y-this.baseY)*.5;}
                else if(this.subType==='Box to Box'){targetX=atk?enemyGoalX-attackDir*200:this.baseX;targetY=this.baseY+(ballObj.y-this.baseY)*.4;}
                else if(this.subType==='Extremo'){targetX=atk?enemyGoalX-attackDir*90:this.baseX+bOff*.9;spd=atk?spd*1.6:spd*1.4;targetY=myTeam.filter(p=>p.subType==='Extremo').indexOf(this)===0?50:canvas.height-50;}
                else if(this.subType==='Centrodelantero'){
                    targetX=enemyGoalX-attackDir*80;
                    if(atk){let bY=this.y,mS=-Infinity;const en=allPlayers.filter(p=>p.team!==this.team);for(let tY=120;tY<=canvas.height-120;tY+=30){let sc=Math.min(...en.map(e=>Math.hypot(e.x-targetX,e.y-tY)))-Math.abs(canvas.height/2-tY)*.5;if(sc>mS){mS=sc;bY=tY;}}targetY=bY;}
                    else targetY=Math.max(80,Math.min(canvas.height-80,ballObj.y+(this.baseY<canvas.height/2?-60:60)));
                }
                else if(this.subType==='Segundo Delantero'){
                    targetX=enemyGoalX-attackDir*180;
                    if(atk){let bY=this.y,mS=-Infinity;const en=allPlayers.filter(p=>p.team!==this.team),ot=myTeam.filter(p=>p!==this&&p.subType==='Segundo Delantero');for(let tY=100;tY<=canvas.height-100;tY+=40){let sc=Math.min(...en.map(e=>Math.hypot(e.x-targetX,e.y-tY)));ot.forEach(o=>{if(Math.abs(o.y-tY)<80)sc-=100;});if(sc>mS){mS=sc;bY=tY;}}targetY=bY;}
                    else targetY=this.baseY+(ballObj.y-this.baseY)*.3;
                }
                else{targetX=this.baseX+bOff;targetY=this.baseY+(ballObj.y-this.baseY)*.3;}
                if(this.wallPassActive>0&&atk){targetX=enemyGoalX-attackDir*20;targetY=this.baseY;spd*=1.4;}
            }
        }
        const dx=targetX-this.x,dy=targetY-this.y,dist=Math.hypot(dx,dy);
        if(dist>2){this.x+=dx/dist*spd;this.y+=dy/dist*spd;}

        const dBall=Math.hypot(ballObj.x-this.x,ballObj.y-this.y);
        if(dBall<this.radius+ballObj.radius&&this.cooldown===0){
            playKick();
            if(ballObj.lastTouch!==this){
                if(ballObj.lastTouch&&ballObj.lastTouch.team===this.team)ballObj.assistTouch=ballObj.lastTouch;
                else ballObj.assistTouch=null;
                ballObj.lastTouch=this;
            }
            const dGoal=Math.hypot(enemyGoalX-this.x,enemyGoalY-this.y);
            const shotClear=()=>{let a=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x);return !allPlayers.some(e=>e.team!==this.team&&e.rolBase!=='Portero'&&Math.abs(Math.atan2(e.y-this.y,e.x-this.x)-a)<.25&&Math.hypot(e.x-this.x,e.y-this.y)<dGoal);};
            const passSafe=t=>{let a=Math.atan2(t.y-this.y,t.x-this.x),d=Math.hypot(t.x-this.x,t.y-this.y);return !allPlayers.some(e=>e.team!==this.team&&Math.abs(Math.atan2(e.y-this.y,e.x-this.x)-a)<.3&&Math.hypot(e.x-this.x,e.y-this.y)<d);};
            let canShoot=dGoal<=this.rangoTiro;
            if(this.subType==='Centrodelantero'&&!canShoot&&shotClear()&&dGoal<=320)canShoot=true;
            if(this.subType==='Box to Box'&&dGoal<=300&&shotClear())canShoot=true;
            if(canShoot&&this.rolBase!=='Portero'&&this.subType!=='Central'){
                let err=this.subType==='Centrodelantero'?0:.4;
                if(this.team==='azul'&&state.upgrades.shoot)err*=.2;
                let ang=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x)+(Math.random()-.5)*err;
                ballObj.vx=Math.cos(ang)*this.kickPower*1.5;ballObj.vy=Math.sin(ang)*this.kickPower*1.5;this.cooldown=15;
            } else {
                const sfwd=myTeam.filter(p=>p!==this&&passSafe(p)&&(this.team==='azul'?p.x>this.x:p.x<this.x));
                const sbk=myTeam.filter(p=>p!==this&&passSafe(p)&&(this.team==='azul'?p.x<=this.x:p.x>=this.x));
                let tgt=null,fm=1.2,err=(1-this.precisionPase)*(Math.random()-.5)*1.5;
                if(this.subType==='Mediapunta'){let fw=sfwd.filter(p=>p.rolBase==='Delantero');if(fw.length)tgt=fw[Math.floor(Math.random()*fw.length)];else{let a=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x);ballObj.vx=Math.cos(a)*this.speed*1.3;ballObj.vy=Math.sin(a)*this.speed*1.3;this.cooldown=10;return;}}
                else if(this.subType==='MCD'){if(sfwd.length>0&&Math.random()>.2)tgt=sfwd[Math.floor(Math.random()*sfwd.length)];else if(sbk.length){let d=sbk.filter(p=>p.rolBase!=='Portero');tgt=d.length?d[Math.floor(Math.random()*d.length)]:sbk[0];}}
                else if(this.subType==='Extremo'||this.subType==='Lateral Ofensivo'){if(Math.abs(enemyGoalX-this.x)>160){let a=Math.atan2((this.y<canvas.height/2?40:canvas.height-40)-this.y,enemyGoalX-this.x);ballObj.vx=Math.cos(a)*this.speed*1.6;ballObj.vy=Math.sin(a)*this.speed*1.6;this.cooldown=8;return;}let fw=sfwd.filter(p=>p.subType==='Centrodelantero'||p.rolBase==='Delantero');if(fw.length)tgt=fw.reduce((c,p)=>(this.team==='azul'?p.x>c.x:p.x<c.x)?p:c,fw[0]);else if(sfwd.length)tgt=sfwd[0];}
                else if(this.subType==='Box to Box'){if(sfwd.length)tgt=sfwd[Math.floor(Math.random()*sfwd.length)];else if(sbk.length)tgt=sbk[0];}
                else{if(sfwd.length)tgt=sfwd[0];else if(this.subType==='Centrodelantero'&&sbk.length)tgt=sbk[0];}
                if(tgt){
                    if((this.subType==='Extremo'||this.subType==='Lateral Ofensivo')&&(tgt.subType==='MCD'||tgt.subType==='Mediapunta'))this.wallPassActive=120;
                    let wp=sfwd.find(p=>p.wallPassActive>0);if(wp&&passSafe(wp))tgt=wp;
                    let pX=tgt.x,pY=tgt.y,tf=fm;
                    if(tgt.wallPassActive>0||tgt.rolBase==='Delantero'||tgt.subType==='Extremo'){let lx=tgt.x+attackDir*70;if(passSafe({x:lx,y:tgt.y})){pX=lx;tf=fm*1.5;}}
                    let a=Math.atan2(pY-this.y,pX-this.x);if(this.subType==='Central')err=(Math.random()-.5)*2;
                    ballObj.vx=Math.cos(a+err)*this.kickPower*tf;ballObj.vy=Math.sin(a+err)*this.kickPower*tf;
                } else {ballObj.vx=attackDir*this.kickPower;ballObj.vy=(Math.random()-.5)*2;}
                this.cooldown=15;
            }
        }
        allPlayers.forEach(o=>{if(o!==this){let d=Math.hypot(this.x-o.x,this.y-o.y),m=this.radius+o.radius;if(d<m&&d>0){this.x+=(this.x-o.x)/d*(m-d)*.1;this.y+=(this.y-o.y)/d*(m-d)*.1;}}});
        this.x=Math.max(this.radius,Math.min(canvas.width-this.radius,this.x));
        this.y=Math.max(this.radius,Math.min(canvas.height-this.radius,this.y));
    }
    draw(){
        ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();
        ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.stroke();
        if(this.type!=='Novato'){ctx.beginPath();ctx.arc(this.x,this.y,this.radius+3,0,Math.PI*2);ctx.strokeStyle='#FFD700';ctx.lineWidth=2;ctx.stroke();ctx.closePath();}
        ctx.beginPath();ctx.arc(this.x,this.y,this.radius/3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fill();ctx.closePath();
        ctx.fillStyle='#fff';ctx.font='bold 10px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(this.numero,this.x,this.y);
        if(this.playerName){ctx.font='bold 9px Arial';ctx.fillText(this.playerName.split(' ').pop(),this.x,this.y-this.radius-8);}
        // Highlight pateador seleccionado
        if(penaltyActive&&penaltyPhase==='select'&&this.team==='azul'&&this.rolBase!=='Portero'){
            let sel=penaltyKickers.includes(this);
            if(sel){ctx.beginPath();ctx.arc(this.x,this.y,this.radius+5,0,Math.PI*2);ctx.strokeStyle='#f1c40f';ctx.lineWidth=3;ctx.stroke();ctx.closePath();}
            else{ctx.beginPath();ctx.arc(this.x,this.y,this.radius+5+Math.sin(Date.now()/200)*2,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=2;ctx.stroke();ctx.closePath();}
        }
        // Selecci√≥n fichaje
        let isT=false;
        if(state.modoFichaje&&this.team==='azul'&&this.type==='Novato'){isT=state.modoFichaje.rol==='Cualquiera'?this.rolBase!=='Portero':this.rolBase===state.modoFichaje.rol;}
        if(isT){ctx.beginPath();ctx.arc(this.x,this.y,this.radius+6+Math.sin(Date.now()/150)*3,0,Math.PI*2);ctx.strokeStyle='#00ff00';ctx.lineWidth=3;ctx.stroke();ctx.closePath();}
    }
}

// ============================================================
// INSTANCIAS
// ============================================================
const ball = new Ball();
const players = [];
players.push(new Player(30,250,'#3498db','azul','Portero',1));
let nA=2;formacionesDB["4-4-2"].forEach(p=>players.push(new Player(p.x,p.y,'#3498db','azul',p.rol,nA++)));
players.push(new Player(770,250,'#e74c3c','rojo','Portero',1));
let nR=2;
[{x:670,y:100,rol:'Lateral'},{x:690,y:200,rol:'Central'},{x:690,y:300,rol:'Central'},{x:670,y:400,rol:'Lateral'},{x:550,y:100,rol:'Medio'},{x:580,y:200,rol:'Medio'},{x:580,y:300,rol:'Medio'},{x:550,y:400,rol:'Medio'},{x:450,y:180,rol:'Delantero'},{x:450,y:320,rol:'Delantero'}].forEach(p=>players.push(new Player(p.x,p.y,'#e74c3c','rojo',p.rol,nR++)));

// ============================================================
// GOL
// ============================================================
window.anotarGol = function(equipo, scorerP, assistP) {
    if(!state.partidoActivo||penaltyActive||state.tiempo<=0)return;
    playGoal(); playWhistle();
    let sName=scorerP?.playerName?scorerP.playerName.split(' ').pop():null;
    let aStr=assistP?.playerName&&assistP!==scorerP?` (Asist: ${assistP.playerName.split(' ').pop()})`:'' ;
    let tMin=Math.floor(((MATCH_DURATION-state.tiempo)/MATCH_DURATION)*90)+"'";
    let ev=`<div style="margin-top:2px;">‚öΩ ${tMin} ${sName||'Jugador'}${aStr}</div>`;

    // FIX: Verificar que el goleador sea realmente del equipo correcto
    if(equipo==='azul'){
        if(scorerP&&scorerP.team!=='azul')return; // ignorar si el goleador es del equipo contrario
        state.golesAzul++;
        document.getElementById('scoreAzul').innerText=`${myTeamData.name.substring(0,10)}: ${state.golesAzul}`;
        document.getElementById('home-scorers').innerHTML+=ev;
        if(scorerP&&scorerP.team==='azul'&&scorerP.playerName)recordStat(scorerP.playerName,myTeamData,'goal');
        if(assistP&&assistP.team==='azul'&&assistP!==scorerP&&assistP.playerName)recordStat(assistP.playerName,myTeamData,'assist');
        state.monedas+=10;coinsEl.innerText=state.monedas;
        mostrarAnimacionGol(sName,currentMatchState.actualMyColor);
    } else {
        if(scorerP&&scorerP.team!=='rojo')return; // FIX
        state.golesRojo++;
        document.getElementById('scoreRojo').innerText=`${currentMatchState.enemyData.name.substring(0,10)}: ${state.golesRojo}`;
        document.getElementById('away-scorers').innerHTML+=ev;
        if(scorerP&&scorerP.team==='rojo'&&scorerP.playerName)recordStat(scorerP.playerName,currentMatchState.enemyData,'goal');
        if(assistP&&assistP.team==='rojo'&&assistP!==scorerP&&assistP.playerName)recordStat(assistP.playerName,currentMatchState.enemyData,'assist');
        mostrarAnimacionGol(sName,currentMatchState.actualEnemyColor);
    }
    ball.reset();players.forEach(p=>p.reset());
};

// ============================================================
// SONIDO
// ============================================================
const AudioCtx=window.AudioContext||window.webkitAudioContext;
const audioCtx=new AudioCtx();
let soundEnabled=false;
function initSound(){if(audioCtx.state==='suspended')audioCtx.resume();soundEnabled=!soundEnabled;document.getElementById('sound-btn').innerText=soundEnabled?'üîä Sonido':'üîá Sonido';if(soundEnabled)playWhistle();}
function playKick(){if(!soundEnabled)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='triangle';o.frequency.setValueAtTime(150,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);g.gain.setValueAtTime(.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);o.start();o.stop(audioCtx.currentTime+.1);}
function playCoin(){if(!soundEnabled)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.setValueAtTime(800,audioCtx.currentTime);o.frequency.setValueAtTime(1200,audioCtx.currentTime+.1);g.gain.setValueAtTime(.2,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.3);o.start();o.stop(audioCtx.currentTime+.3);}
function playWhistle(){if(!soundEnabled)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='square';o.frequency.setValueAtTime(2000,audioCtx.currentTime);g.gain.setValueAtTime(.05,audioCtx.currentTime);g.gain.setValueAtTime(.05,audioCtx.currentTime+.1);g.gain.setValueAtTime(0,audioCtx.currentTime+.15);g.gain.setValueAtTime(.05,audioCtx.currentTime+.2);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.5);o.start();o.stop(audioCtx.currentTime+.5);}
function playGoal(){if(!soundEnabled)return;const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*2,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=buf;const f=audioCtx.createBiquadFilter();f.type='bandpass';f.frequency.value=800;const g=audioCtx.createGain();n.connect(f);f.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(0,audioCtx.currentTime);g.gain.linearRampToValueAtTime(.4,audioCtx.currentTime+.2);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+2);n.start();}

// ============================================================
// MODALES
// ============================================================
function mostrarAlerta(t,m,cb=null){state.pausado=true;document.getElementById('message-title').innerText=t;document.getElementById('message-text').innerText=m;let c=document.getElementById('message-buttons');c.innerHTML='';let b=document.createElement('button');b.className='btn';b.innerText='Entendido';b.onclick=()=>{document.getElementById('message-modal').style.display='none';state.pausado=false;if(cb)cb();};c.appendChild(b);document.getElementById('message-modal').style.display='block';}
function mostrarConfirmacion(t,m,ok,cancel){state.pausado=true;document.getElementById('message-title').innerText=t;document.getElementById('message-text').innerText=m;let c=document.getElementById('message-buttons');c.innerHTML='';let bN=document.createElement('button');bN.className='btn';bN.style.background='var(--red)';bN.innerText='Cancelar';bN.onclick=()=>{document.getElementById('message-modal').style.display='none';state.pausado=false;if(cancel)cancel();};let bY=document.createElement('button');bY.className='btn';bY.innerText='S√≠, continuar';bY.onclick=()=>{document.getElementById('message-modal').style.display='none';if(ok)ok();};c.appendChild(bN);c.appendChild(bY);document.getElementById('message-modal').style.display='block';}
function pedirCodigo(){
    let codigo = prompt('Introduce el c√≥digo de desarrollador:');
    if(codigo && codigo.toUpperCase() === 'JOLUAL'){
        state.monedas += 1000;
        coinsEl.innerText = state.monedas;
        playCoin();
        coinsEl.style.color='#fff';
        setTimeout(()=>coinsEl.style.color='#f1c40f', 200);
        alert('‚úÖ +1000 monedas a√±adidas.');
    } else if(codigo !== null) {
        alert('‚ùå C√≥digo incorrecto.');
    }
}

// ============================================================
// REASIGNACION DE FORMACION
// ============================================================
let reasignTargetFormacion = null;
let reasignSelectedSrc = null;   // indice del jugador seleccionado en panel izquierdo
let reasignMapping = [];         // [{srcIdx, dstIdx}] asignaciones hechas

function cambiarFormacion(nombre){
    if(nombre === currentFormation){ return; }
    // Abrir modal de reasignacion
    reasignTargetFormacion = nombre;
    reasignSelectedSrc = null;
    reasignMapping = [];
    document.getElementById('reasign-col-left').innerText = 'FORMACI√ìN ACTUAL: ' + currentFormation;
    document.getElementById('reasign-col-right').innerText = 'NUEVA FORMACI√ìN: ' + nombre;
    renderReasignPanel();
    document.getElementById('reasign-modal').style.display = 'flex';
    state.pausado = true;
}

function renderReasignPanel(){
    const campo = players.filter(p=>p.team==='azul'&&p.rolBase!=='Portero');
    const newF = formacionesDB[reasignTargetFormacion];
    const leftEl = document.getElementById('reasign-left');
    const rightEl = document.getElementById('reasign-right');

    // Calcular cuantas monedas se recuperan por jugadores no asignados
    let assignedSrcs = reasignMapping.map(m=>m.srcIdx);
    let moneyBack = 0;
    campo.forEach((p,i)=>{ if(p.type!=='Novato' && !assignedSrcs.includes(i)) moneyBack+=50; });
    
    let pendingSlots = newF.filter((_,di)=>!reasignMapping.find(m=>m.dstIdx===di)).length;
    let info = '';
    if(moneyBack>0) info += `üí∞ Recuperas ${moneyBack} monedas por jugadores sin asignar  `;
    if(pendingSlots>0) info += `‚ö†Ô∏è ${pendingSlots} posici√≥n(es) quedar√°n vac√≠as`;
    document.getElementById('reasign-info').innerText = info;

    // PANEL IZQUIERDO ‚Äî jugadores actuales
    leftEl.innerHTML = '';
    campo.forEach((p,i)=>{
        const assigned = reasignMapping.find(m=>m.srcIdx===i);
        const isSelected = reasignSelectedSrc===i;
        const isUpgraded = p.type!=='Novato';
        const card = document.createElement('div');
        card.className = 'slot-card' + (isSelected?' selected-src':'') + (assigned?' dropped':'');
        card.innerHTML = `
            <span class="slot-rol rol-${p.rolBase}">${p.rolBase}</span>
            <span class="slot-name">${p.playerName || '(Sin fichar)'}</span>
            ${isUpgraded?'<span class="slot-stars">‚≠ê '+p.type+'</span>':''}
            ${assigned?'<span style="font-size:11px;color:#2ecc71;">‚Üí Pos '+(assigned.dstIdx+1)+'</span>':''}
        `;
        if(!assigned){ card.onclick = ()=>seleccionarSrc(i); }
        else { card.onclick = ()=>deseleccionarSrc(i); card.title='Clic para quitar asignaci√≥n'; }
        leftEl.appendChild(card);
    });

    // PANEL DERECHO ‚Äî slots nueva formacion
    rightEl.innerHTML = '';
    newF.forEach((pos,di)=>{
        const mapping = reasignMapping.find(m=>m.dstIdx===di);
        const srcPlayer = mapping!=null ? campo[mapping.srcIdx] : null;
        const card = document.createElement('div');
        card.className = 'slot-card' + (mapping?' dropped':' empty') + (reasignSelectedSrc!==null&&!mapping?' selected-dst':'');
        card.innerHTML = `
            <span class="slot-rol rol-${pos.rol}">${pos.rol}</span>
            <span class="slot-name">${srcPlayer ? (srcPlayer.playerName||'(Sin fichar)') : '<em style="opacity:.4">Vac√≠o</em>'}</span>
            ${srcPlayer&&srcPlayer.type!=='Novato'?'<span class="slot-stars">‚≠ê</span>':''}
        `;
        if(reasignSelectedSrc!==null && !mapping){
            card.onclick = ()=>asignarSlot(di);
        } else if(mapping){
            card.onclick = ()=>deseleccionarSrc(mapping.srcIdx);
            card.title='Clic para quitar asignaci√≥n';
        }
        rightEl.appendChild(card);
    });
}

function seleccionarSrc(i){
    reasignSelectedSrc = (reasignSelectedSrc===i) ? null : i;
    renderReasignPanel();
}

function asignarSlot(dstIdx){
    if(reasignSelectedSrc===null) return;
    // Quitar asignacion previa de este src si existe
    reasignMapping = reasignMapping.filter(m=>m.srcIdx!==reasignSelectedSrc);
    reasignMapping.push({srcIdx:reasignSelectedSrc, dstIdx});
    reasignSelectedSrc = null;
    renderReasignPanel();
}

function deseleccionarSrc(srcIdx){
    reasignMapping = reasignMapping.filter(m=>m.srcIdx!==srcIdx);
    reasignSelectedSrc = null;
    renderReasignPanel();
}

function cancelarReasign(){
    document.getElementById('reasign-modal').style.display = 'none';
    document.getElementById('formation-select').value = currentFormation;
    state.pausado = false;
}

function confirmarReasign(){
    const campo = players.filter(p=>p.team==='azul'&&p.rolBase!=='Portero');
    const newF = formacionesDB[reasignTargetFormacion];
    const assignedSrcs = reasignMapping.map(m=>m.srcIdx);

    // Devolver monedas por jugadores mejorados que NO se reasignaron
    campo.forEach((p,i)=>{
        if(p.type!=='Novato' && !assignedSrcs.includes(i)){
            state.monedas += 50;
        }
    });

    // Guardar datos de jugadores asignados antes de resetear
    const savedPlayers = reasignMapping.map(m=>({
        dstIdx: m.dstIdx,
        type: campo[m.srcIdx].type,
        subType: campo[m.srcIdx].subType,
        playerName: campo[m.srcIdx].playerName
    }));

    // Resetear todos a Novato con nueva formacion
    currentFormation = reasignTargetFormacion;
    document.getElementById('formation-select').value = currentFormation;
    purchasedPlayers = [];
    for(let i=0;i<10;i++){
        campo[i].baseX=newF[i].x; campo[i].baseY=newF[i].y;
        campo[i].rolBase=newF[i].rol;
        campo[i].type='Novato'; campo[i].subType='Basico';
        campo[i].playerName=null; campo[i].resetStats(); campo[i].reset();
    }

    // Aplicar jugadores reasignados a sus nuevos slots
    savedPlayers.forEach(s=>{
        const p = campo[s.dstIdx];
        p.type = s.type; p.subType = s.subType; p.playerName = s.playerName;
        p.aplicarEspecialidad(p.rolBase, s.subType);
        if(s.playerName) purchasedPlayers.push(s.playerName);
    });

    coinsEl.innerText = state.monedas;
    document.getElementById('reasign-modal').style.display = 'none';
    state.pausado = false;
    reiniciarPartido();
}

// ============================================================
// TIMER Y PARTIDO
// ============================================================
setInterval(()=>{
    if(state.partidoActivo&&state.tiempo>0&&!state.pausado&&!penaltyActive){
        state.tiempo--;timeEl.innerText=state.tiempo;
        if(state.tiempo<=0){
            // Detener partido Y frenar balon inmediatamente para que anotarGol no siga sumando
            state.partidoActivo=false;
            ball.vx=0; ball.vy=0;
            if(tournamentFormat==='liga'){setTimeout(()=>{playWhistle();simularRestoYAvanzar();},500);}
            else if(state.golesAzul!==state.golesRojo){setTimeout(()=>{playWhistle();simularRestoYAvanzar();},500);}
            else{
                timeEl.innerText='PEN';timeEl.style.color='#f1c40f';
                penaltyPhase='select';
                setTimeout(()=>{
                    reposicionarParaPenales();
                    penaltyActive=true;
                    document.getElementById('penalty-select-overlay').style.display='block';
                    document.getElementById('penalty-hud').style.display='block';
                    actualizarUISeleccionPenal();
                    actualizarPenalHUD();
                    penaltyCallback=()=>{ playWhistle(); timeEl.style.color='#ecf0f1'; simularRestoYAvanzar(); };
                },800);
            }
        }
    }
},1000);

function reiniciarPartido(){
    playWhistle();state.golesAzul=0;state.golesRojo=0;state.tiempo=MATCH_DURATION;
    timeEl.style.color='#ecf0f1';penaltyActive=false;penaltyPhase=null;penaltyKickers=[];
    document.getElementById('penalty-hud').style.display='none';
    document.getElementById('penalty-select-overlay').style.display='none';
    if(myTeamData&&currentMatchState.enemyData){
        document.getElementById('scoreAzul').innerText=`${myTeamData.name.substring(0,10)}: 0`;
        document.getElementById('scoreRojo').innerText=`${currentMatchState.enemyData.name.substring(0,10)}: 0`;
    }
    timeEl.innerText=state.tiempo;ball.reset();players.forEach(p=>p.reset());
    document.getElementById('home-scorers').innerHTML='';document.getElementById('away-scorers').innerHTML='';
    state.partidoActivo=true;state.pausado=false;
}

// ============================================================
// RENDER
// ============================================================
function drawPitch(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='rgba(255,255,255,.7)';ctx.lineWidth=3;ctx.strokeRect(0,0,canvas.width,canvas.height);
    ctx.beginPath();ctx.moveTo(canvas.width/2,0);ctx.lineTo(canvas.width/2,canvas.height);ctx.stroke();
    ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,60,0,Math.PI*2);ctx.stroke();
    ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(0,GOAL_Y_START);ctx.lineTo(0,GOAL_Y_END);ctx.strokeStyle=currentMatchState.actualMyColor||'#fff';ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=2;ctx.strokeRect(0,GOAL_Y_START-50,100,GOAL_HEIGHT+100);
    ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(canvas.width,GOAL_Y_START);ctx.lineTo(canvas.width,GOAL_Y_END);ctx.strokeStyle=currentMatchState.actualEnemyColor||'#fff';ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=2;ctx.strokeRect(canvas.width-100,GOAL_Y_START-50,100,GOAL_HEIGHT+100);
    // Punto penal en modo penales
    if(penaltyActive){
        ctx.fillStyle='rgba(255,255,255,.8)';
        ctx.beginPath();ctx.arc(620,250,5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(180,250,5,0,Math.PI*2);ctx.fill();
    }
}

function drawPenaltyBall(){
    if(!penaltyAnimState)return;
    let s=penaltyAnimState;
    ctx.beginPath();ctx.arc(s.ballX,s.ballY,7,0,Math.PI*2);
    ctx.fillStyle='#fff';ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.stroke();
}

function drawPenaltyResult(){
    if(!penaltyAnimState)return;
    let s=penaltyAnimState;
    if(s.phase==='result'){
        ctx.save();
        ctx.font='bold 28px "Bebas Neue",sans-serif';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        let txt=s.scored?'‚öΩ GOL':'üß§ ATAJADO';
        let col=s.scored?(s.isHome?currentMatchState.actualMyColor:'#e74c3c'):'#3498db';
        ctx.fillStyle=col;
        ctx.shadowColor=col;ctx.shadowBlur=20;
        ctx.fillText(txt,canvas.width/2,canvas.height/2-40);
        ctx.fillStyle='white';ctx.shadowBlur=0;
        ctx.font='bold 18px "Bebas Neue",sans-serif';
        ctx.fillText(s.label.toUpperCase(),canvas.width/2,canvas.height/2);
        ctx.restore();
    }
}

function gameLoop(){
    if(document.getElementById('game-container').style.display==='block'){
        drawPitch();
        if(state.partidoActivo&&!state.pausado&&!penaltyActive){
            ball.update();players.forEach(p=>p.update(ball,players));
        }
        // Dibujar jugadores
        players.forEach(p=>p.draw());
        // Si penales activos y en animaci√≥n
        if(penaltyActive&&penaltyAnimState){
            stepPenaltyAnim();
            drawPenaltyBall();
            drawPenaltyResult();
        } else if(!penaltyActive){
            ball.draw();
        }
    }
    requestAnimationFrame(gameLoop);
}

// Activar fase animaci√≥n cuando se confirman pateadores
function confirmarPateadores(){
    if(penaltyKickers.length<5)return;
    document.getElementById('penalty-select-overlay').style.display='none';
    penaltyPhase='animate';
    // IA elige 5
    let rojoField=players.filter(p=>p.team==='rojo'&&p.rolBase!=='Portero');
    penaltyAIKickers=[...rojoField].sort(()=>Math.random()-.5).slice(0,5);
    // Cola
    penaltyAnimQueue=[];
    for(let i=0;i<5;i++){
        penaltyAnimQueue.push({team:'home',player:penaltyKickers[i]});
        penaltyAnimQueue.push({team:'away',player:penaltyAIKickers[i]});
    }
    penaltyAnimIdx=0;
    actualizarPenalHUD();
    lanzarSiguienteAnim();
}

gameLoop();
</script>
</body>
</html>
