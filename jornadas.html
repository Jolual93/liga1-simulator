<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga 1 Simulator â€” Jornadas</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #0d0d0d; color: white; font-family: 'Rajdhani', sans-serif; min-height: 100vh; }

        header {
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.07);
            padding: 14px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-nav { display: flex; align-items: center; gap: 20px; }
        .nav-link { color: rgba(255,255,255,0.4); text-decoration: none; font-size: 14px; font-weight: 600; letter-spacing: 1px; transition: color 0.2s; }
        .nav-link:hover, .nav-link.active { color: #f1c40f; }
        .header-user { display: flex; align-items: center; gap: 16px; }
        .btn-logout { background: rgba(231,76,60,0.15); border: 1px solid rgba(231,76,60,0.3); color: #e74c3c; padding: 7px 16px; border-radius: 8px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 700; transition: 0.2s; }
        .btn-logout:hover { background: rgba(231,76,60,0.25); }

        .hero { background: linear-gradient(135deg, rgba(241,196,15,0.07) 0%, rgba(230,126,34,0.04) 100%); border-bottom: 1px solid rgba(241,196,15,0.12); padding: 20px 32px; display: flex; align-items: center; gap: 16px; }
        .hero h1 { font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 4px; background: linear-gradient(135deg, #f1c40f, #e67e22); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-badge { background: rgba(241,196,15,0.12); border: 1px solid rgba(241,196,15,0.25); color: #f1c40f; border-radius: 6px; padding: 3px 10px; font-size: 12px; font-weight: 700; letter-spacing: 2px; }
        .hero-right { margin-left: auto; font-size: 13px; color: rgba(255,255,255,0.3); }

        .container { max-width: 1200px; margin: 0 auto; padding: 28px 20px; }
        .main-grid { display: grid; grid-template-columns: 1fr 340px; gap: 24px; align-items: start; }

        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 24px; }
        .stat-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; padding: 16px 20px; text-align: center; }
        .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 2px; color: #f1c40f; }
        .stat-lbl { font-size: 11px; color: rgba(255,255,255,0.3); letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }

        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 16px; overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; }

        .jornada-tabs { display: flex; flex-wrap: wrap; gap: 4px; padding: 12px 16px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tab-j { padding: 4px 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: rgba(255,255,255,0.35); font-family: 'Bebas Neue', sans-serif; font-size: 14px; cursor: pointer; transition: 0.15s; letter-spacing: 1px; }
        .tab-j:hover { border-color: rgba(241,196,15,0.4); color: #f1c40f; }
        .tab-j.done { border-color: rgba(39,174,96,0.4); color: #27ae60; }
        .tab-j.active { background: #f1c40f; border-color: #f1c40f; color: #000; }

        .nav-btns { display: flex; gap: 8px; }
        .btn-nav { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); padding: 6px 14px; border-radius: 7px; font-family: 'Bebas Neue', sans-serif; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .btn-nav:hover { border-color: #f1c40f; color: #f1c40f; }
        .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; }

        .fixture-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 6px; }
        .match-row { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; }
        .match-row.finalizado { border-left: 3px solid #27ae60; }
        .match-row.en_curso { border-left: 3px solid #f1c40f; animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{border-left-color:#f1c40f;} 50%{border-left-color:transparent;} }
        .t-name { font-family: 'Bebas Neue', sans-serif; font-size: 15px; letter-spacing: 0.5px; }
        .t-home { text-align: right; }
        .t-away { text-align: left; }
        .score-box { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .score-n { font-family: 'Bebas Neue', sans-serif; font-size: 22px; min-width: 20px; text-align: center; }
        .score-sep { color: rgba(255,255,255,0.25); font-size: 14px; }
        .score-vs { color: rgba(255,255,255,0.2); font-size: 11px; font-weight: 700; letter-spacing: 1px; }

        .sim-controls { padding: 14px 16px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: 8px; font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 1px; cursor: pointer; border: none; transition: 0.2s; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-green { background: #27ae60; color: #fff; }
        .btn-green:not(:disabled):hover { background: #2ecc71; transform: translateY(-1px); }
        .btn-gold { background: #f1c40f; color: #000; }
        .btn-gold:not(:disabled):hover { background: #f39c12; transform: translateY(-1px); }
        .btn-danger { background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.22); color: #e74c3c; margin-left: auto; font-size: 13px; padding: 7px 14px; }
        .btn-danger:hover { background: rgba(231,76,60,0.2); }

        .setup-panel { background: linear-gradient(135deg, rgba(241,196,15,0.06), rgba(230,126,34,0.03)); border: 1px solid rgba(241,196,15,0.2); border-radius: 16px; padding: 48px 32px; text-align: center; margin-bottom: 24px; }
        .setup-icon { font-size: 52px; margin-bottom: 12px; }
        .setup-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 3px; margin-bottom: 8px; }
        .setup-desc { color: rgba(255,255,255,0.35); font-size: 14px; margin-bottom: 28px; line-height: 1.7; }

        /* CARDS MODO */
        .modo-card { background: rgba(255,255,255,.04); border: 2px solid rgba(255,255,255,.08); border-radius: 14px; padding: 24px 20px; cursor: pointer; transition: all .2s; text-align: center; }
        .modo-card:hover { border-color: rgba(241,196,15,.4); transform: translateY(-2px); }
        .modo-card.selected { border-color: #f1c40f; background: rgba(241,196,15,.08); }
        .modo-titulo { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; margin-bottom: 8px; color: #f1c40f; }
        .modo-desc { font-size: 13px; color: rgba(255,255,255,.4); line-height: 1.6; margin-bottom: 12px; }
        .modo-lista { list-style: none; text-align: left; font-size: 13px; color: rgba(255,255,255,.5); display: flex; flex-direction: column; gap: 4px; }

        .btn-gen { background: linear-gradient(135deg, #f1c40f, #e67e22); color: #000; border: none; padding: 14px 36px; border-radius: 12px; font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 3px; cursor: pointer; transition: 0.2s; }
        .btn-gen:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(241,196,15,0.25); }

        .s-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .s-table th { padding: 9px 10px; text-align: center; color: rgba(255,255,255,0.3); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .s-table th:nth-child(2) { text-align: left; }
        .s-table td { padding: 7px 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .s-table td:nth-child(2) { text-align: left; font-weight: 600; font-size: 14px; }
        .s-table tr:hover td { background: rgba(255,255,255,0.02); }
        .s-table tr:last-child td { border-bottom: none; }
        .pos-n { color: rgba(255,255,255,0.3); font-size: 12px; font-weight: 700; }
        .pos-gold { color: #f1c40f; }
        .pos-blue { color: #3498db; }
        .pts-cell { font-family: 'Bebas Neue', sans-serif; font-size: 17px; color: #f1c40f; }
        .dg-pos { color: #27ae60; }
        .dg-neg { color: #e74c3c; }

        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 500; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
        .overlay.show { display: flex; }
        .spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #f1c40f; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .overlay-text { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; color: #f1c40f; }

        .toast { position: fixed; bottom: 28px; right: 28px; background: #1a1e28; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px 18px; font-size: 14px; font-weight: 600; transform: translateY(120%); transition: transform 0.3s ease; z-index: 600; max-width: 320px; }
        .toast.show { transform: translateY(0); }
        .toast.ok  { border-left: 3px solid #27ae60; }
        .toast.err { border-left: 3px solid #e74c3c; }
        .toast.inf { border-left: 3px solid #3498db; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .stats-bar { grid-template-columns: 1fr 1fr; } .container { padding: 16px; } }
    </style>
</head>
<body>

<header>
    <div class="header-logo">âš½ LIGA 1 SIMULATOR</div>
    <nav class="header-nav">
        <a href="dashboard.html" class="nav-link">Mi Equipo</a>
        <a href="jornadas.html" class="nav-link active">Jornadas</a>
        <a href="game.html" class="nav-link">Offline</a>
    </nav>
    <div class="header-user">
        <span id="header-user" style="font-size:13px;color:rgba(255,255,255,.4);">â€”</span>
        <button class="btn-logout" onclick="cerrarSesion()">Salir</button>
    </div>
</header>

<div class="hero">
    <h1>Jornadas</h1>
    <span class="hero-badge">TEMPORADA 2025</span>
    <div class="hero-right" id="hero-sub">â€”</div>
</div>

<div class="container">

    <div class="stats-bar" id="stats-bar" style="display:none;">
        <div class="stat-box"><div class="stat-val" id="s-jornada">â€”</div><div class="stat-lbl">Jornada Actual</div></div>
        <div class="stat-box"><div class="stat-val" id="s-jugados">â€”</div><div class="stat-lbl">Partidos Jugados</div></div>
        <div class="stat-box"><div class="stat-val" id="s-lider">â€”</div><div class="stat-lbl">LÃ­der</div></div>
    </div>

    <div class="setup-panel" id="setup-panel" style="display:none;">
        <div class="setup-icon">ğŸ—“ï¸</div>
        <div class="setup-title">Elige el tipo de liga</div>
        <div class="setup-desc">Antes de generar el fixture, decide cÃ³mo se formarÃ¡n los equipos.</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:600px;margin:0 auto 28px;">
            <div class="modo-card" id="card-oficial" onclick="seleccionarModo('oficial')">
                <div style="font-size:40px;margin-bottom:10px;">ğŸ†</div>
                <div class="modo-titulo">Liga Oficial</div>
                <div class="modo-desc">Cada manager representa un equipo real de Liga 1. Un equipo por manager.</div>
                <ul class="modo-lista">
                    <li>âœ… 18 equipos reales</li>
                    <li>âœ… Jugadores reales</li>
                    <li>âœ… Un dueÃ±o por equipo</li>
                </ul>
            </div>
            <div class="modo-card" id="card-custom" onclick="seleccionarModo('custom')">
                <div style="font-size:40px;margin-bottom:10px;">ğŸ¨</div>
                <div class="modo-titulo">Liga Personalizada</div>
                <div class="modo-desc">Cada manager crea su propio equipo con nombre, colores y jugadores inventados.</div>
                <ul class="modo-lista">
                    <li>âœ… Nombre libre</li>
                    <li>âœ… Colores propios</li>
                    <li>âœ… Jugadores inventados</li>
                </ul>
            </div>
        </div>

        <div id="selector-equipo-oficial" style="display:none;max-width:500px;margin:0 auto 20px;">
            <div style="font-size:13px;color:rgba(255,255,255,.4);margin-bottom:10px;letter-spacing:1px;text-transform:uppercase;">Tu equipo en la liga</div>
            <select id="sel-equipo-oficial" style="width:100%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 16px;color:white;font-family:'Rajdhani',sans-serif;font-size:16px;outline:none;margin-bottom:6px;"></select>
            <div id="equipo-tomado-msg" style="color:#e74c3c;font-size:13px;display:none;">âš ï¸ Este equipo ya tiene dueÃ±o</div>
        </div>

        <button class="btn-gen" id="btn-generar" onclick="generarCalendario()" style="display:none;">ğŸš€ GENERAR FIXTURE</button>
    </div>

    <div class="main-grid" id="main-grid" style="display:none;">

        <div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title" id="fixture-title">Jornada â€”</span>
                    <div class="nav-btns">
                        <button class="btn-nav" id="btn-prev" onclick="navJornada(-1)">â€¹ Ant</button>
                        <button class="btn-nav" id="btn-next" onclick="navJornada(1)">Sig â€º</button>
                    </div>
                </div>
                <div class="jornada-tabs" id="jornada-tabs"></div>
                <div class="fixture-list" id="fixture-list">
                    <div style="text-align:center;padding:24px;color:rgba(255,255,255,.3);">Cargando...</div>
                </div>
                <div class="sim-controls">
                    <button class="btn btn-green" onclick="simularJornada()">âš¡ Simular Jornada</button>
                    <button class="btn btn-gold" onclick="simularTodas()">ğŸ† Simular Todas</button>
                    <button class="btn btn-danger" onclick="resetear()">ğŸ—‘ï¸ Reiniciar</button>
                </div>
            </div>
        </div>

        <div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ“Š Posiciones</span>
                    <button class="btn-nav" onclick="cargarPosiciones()" style="font-size:15px;padding:5px 10px;">â†»</button>
                </div>
                <table class="s-table">
                    <thead>
                        <tr>
                            <th>#</th><th>Equipo</th><th>PJ</th><th>PG</th>
                            <th>PE</th><th>PP</th><th>DG</th><th>PTS</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body">
                        <tr><td colspan="8" style="text-align:center;padding:20px;color:rgba(255,255,255,.3);">Sin datos</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<div class="overlay" id="overlay">
    <div class="spinner"></div>
    <div class="overlay-text" id="overlay-text">Procesando...</div>
</div>
<div class="toast" id="toast"></div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const SUPABASE_URL = 'https://hpvpxadhbftiulwmysaw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Inip39JWInROxtuAaTL9rQ_f24sZcFa';
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

const TEMPORADA = '2025';
const TOT       = 34;
const EQUIPOS   = [
    'Universitario de Deportes','Alianza Lima','Sporting Cristal',
    'FBC Melgar','Cusco FC','Sport Boys Association',
    'Deportivo Garcilaso','Comerciantes Unidos','Cienciano',
    'Sport Huancayo','ADT de Tarma','AtlÃ©tico Grau',
    'UTC Cajamarca','Juan Pablo II College','CD Los Chankas',
    'FC Cajamarca','Alianza AtlÃ©tico Sullana','Deportivo Moquegua'
];

let modoLiga = null; // 'oficial' | 'custom'
let equiposOcupados = []; // equipos ya elegidos por otros managers

let jornadaActual = 1;
let estadoJ = {};

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    const { data: { session } } = await db.auth.getSession();
    if (session) {
        const n = session.user.user_metadata?.nombre_manager || session.user.email.split('@')[0];
        document.getElementById('header-user').innerText = 'ğŸ‘¤ ' + n;
    }

    overlay('Verificando calendario...');
    try {
        const { data, error } = await db.from('jornadas').select('id').eq('temporada', TEMPORADA).limit(1);
        if (error) throw error;

        if (!data || !data.length) {
            document.getElementById('setup-panel').style.display = 'block';
        } else {
            await cargarEstado();
            mostrarUI();
            await Promise.all([cargarJornada(jornadaActual), cargarPosiciones()]);
        }
    } catch(e) { toast('Error: ' + e.message, 'err'); console.error(e); }
    overlayOff();
}

async function cargarEstado() {
    const { data } = await db.from('jornadas').select('numero_jornada,estado').eq('temporada', TEMPORADA).order('numero_jornada');
    if (!data) return;
    const byJ = {};
    data.forEach(r => { if (!byJ[r.numero_jornada]) byJ[r.numero_jornada] = []; byJ[r.numero_jornada].push(r.estado); });
    estadoJ = {};
    Object.entries(byJ).forEach(([n, est]) => { estadoJ[+n] = est.every(e => e === 'finalizado') ? 'finalizado' : 'pendiente'; });
    jornadaActual = TOT;
    for (let i = 1; i <= TOT; i++) { if (estadoJ[i] !== 'finalizado') { jornadaActual = i; break; } }
}

function mostrarUI() {
    document.getElementById('setup-panel').style.display = 'none';
    document.getElementById('stats-bar').style.display   = 'grid';
    document.getElementById('main-grid').style.display   = 'grid';
    renderTabs();
    actualizarStats();
}

// â”€â”€â”€ GENERAR CALENDARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ SELECCIÃ“N DE MODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.seleccionarModo = async function(modo) {
    modoLiga = modo;

    // Highlight card seleccionada
    document.getElementById('card-oficial').classList.toggle('selected', modo === 'oficial');
    document.getElementById('card-custom').classList.toggle('selected', modo === 'custom');

    if (modo === 'oficial') {
        // Cargar equipos ya ocupados por otros managers
        const { data } = await db.from('equipos').select('equipo_base').not('equipo_base', 'is', null);
        equiposOcupados = (data || []).map(r => r.equipo_base);

        // Mi equipo actual (para no bloquearlo a mÃ­ mismo)
        const { data: { session } } = await db.auth.getSession();
        const { data: miEq } = await db.from('equipos').select('equipo_base').eq('user_id', session.user.id).single();
        const miEquipoActual = miEq?.equipo_base || null;

        // Poblar select
        const sel = document.getElementById('sel-equipo-oficial');
        sel.innerHTML = '<option value="">â€” Selecciona tu equipo â€”</option>';
        EQUIPOS.forEach(eq => {
            const ocupado = equiposOcupados.includes(eq) && eq !== miEquipoActual;
            sel.innerHTML += `<option value="${eq}" ${ocupado ? 'disabled' : ''}>${eq}${ocupado ? ' (ocupado)' : ''}</option>`;
        });
        if (miEquipoActual) sel.value = miEquipoActual;

        sel.onchange = () => {
            const msg = document.getElementById('equipo-tomado-msg');
            const val = sel.value;
            const tomado = equiposOcupados.includes(val) && val !== miEquipoActual;
            msg.style.display = tomado ? 'block' : 'none';
            document.getElementById('btn-generar').style.display = (val && !tomado) ? 'inline-block' : 'none';
        };
        sel.dispatchEvent(new Event('change'));

        document.getElementById('selector-equipo-oficial').style.display = 'block';
    } else {
        // Modo custom: no necesita elegir equipo
        document.getElementById('selector-equipo-oficial').style.display = 'none';
        document.getElementById('btn-generar').style.display = 'inline-block';
    }
};

window.generarCalendario = async function() {
    // Si modo oficial, guardar elecciÃ³n de equipo
    if (modoLiga === 'oficial') {
        const equipoElegido = document.getElementById('sel-equipo-oficial').value;
        if (!equipoElegido) { toast('Selecciona tu equipo primero', 'err'); return; }

        const { data: { session } } = await db.auth.getSession();
        const { error: eqErr } = await db.from('equipos').upsert({
            user_id: session.user.id,
            equipo_base: equipoElegido,
            modo_liga: 'oficial'
        }, { onConflict: 'user_id' });
        if (eqErr) { toast('Error guardando equipo: ' + eqErr.message, 'err'); return; }
    } else if (modoLiga === 'custom') {
        const { data: { session } } = await db.auth.getSession();
        await db.from('equipos').upsert({ user_id: session.user.id, modo_liga: 'custom' }, { onConflict: 'user_id' });
    } else {
        toast('Elige primero el tipo de liga', 'err'); return;
    }

    overlay('Generando 306 partidos...');
    try {
        const fixture = roundRobin(EQUIPOS);
        const rows = [];
        fixture.forEach((ronda, idx) => ronda.forEach(p => rows.push({
            numero_jornada: idx + 1, equipo_local: p.local,
            equipo_visitante: p.visitante, estado: 'pendiente', temporada: TEMPORADA
        })));
        for (let i = 0; i < rows.length; i += 50) {
            document.getElementById('overlay-text').innerText = `Guardando ${i + Math.min(50, rows.length-i)} / ${rows.length}...`;
            const { error } = await db.from('jornadas').insert(rows.slice(i, i+50));
            if (error) throw error;
        }
        toast(`âœ… ${rows.length} partidos generados en ${fixture.length} jornadas`, 'ok');
        await cargarEstado(); mostrarUI();
        await Promise.all([cargarJornada(jornadaActual), cargarPosiciones()]);
    } catch(e) { toast('Error: ' + e.message, 'err'); console.error(e); }
    overlayOff();
};

function roundRobin(eqs) {
    const lista = [...eqs];
    if (lista.length % 2) lista.push('BYE');
    const n = lista.length, fixed = lista[0];
    let rot = lista.slice(1);
    const rondas = [];
    for (let r = 0; r < n-1; r++) {
        const arr = [fixed, ...rot], partidos = [];
        for (let i = 0; i < n/2; i++) {
            const L = arr[i], V = arr[n-1-i];
            if (L !== 'BYE' && V !== 'BYE') partidos.push({ local: L, visitante: V });
        }
        rondas.push(partidos);
        rot = [rot[rot.length-1], ...rot.slice(0, -1)];
    }
    return [...rondas, ...rondas.map(r => r.map(p => ({ local: p.visitante, visitante: p.local })))];
}

// â”€â”€â”€ CARGAR JORNADA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarJornada(num) {
    jornadaActual = num;
    document.getElementById('fixture-title').innerText = `Jornada ${num}`;
    document.getElementById('fixture-list').innerHTML = '<div style="text-align:center;padding:24px;color:rgba(255,255,255,.3);">Cargando...</div>';
    const { data } = await db.from('jornadas').select('*').eq('temporada', TEMPORADA).eq('numero_jornada', num).order('id');
    renderFixture(data || []);
    renderTabs(); actualizarNavBtns(); actualizarStats();
}

function renderFixture(p) {
    const list = document.getElementById('fixture-list');
    if (!p.length) { list.innerHTML = '<div style="text-align:center;padding:24px;color:rgba(255,255,255,.3);">Sin partidos</div>'; return; }
    list.innerHTML = p.map(m => {
        const fin = m.estado === 'finalizado', cur = m.estado === 'en_curso';
        return `<div class="match-row ${m.estado}">
            <div class="t-name t-home">${m.equipo_local}</div>
            <div class="score-box">
                ${fin || cur
                    ? `<span class="score-n">${m.goles_local??'?'}</span><span class="score-sep">â€“</span><span class="score-n">${m.goles_visitante??'?'}</span>`
                    : `<span class="score-vs">VS</span>`}
            </div>
            <div class="t-name t-away">${m.equipo_visitante}</div>
        </div>`;
    }).join('');
}

// â”€â”€â”€ SIMULAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.simularJornada = async function() {
    if (estadoJ[jornadaActual] === 'finalizado') { toast('Jornada ya jugada', 'inf'); return; }
    overlay(`Simulando Jornada ${jornadaActual}...`);
    await procesarJornadas([jornadaActual]);
    overlayOff();
};

window.simularTodas = async function() {
    const p = [];
    for (let i = 1; i <= TOT; i++) if (estadoJ[i] !== 'finalizado') p.push(i);
    if (!p.length) { toast('Â¡Todas las jornadas ya fueron jugadas!', 'inf'); return; }
    overlay(`Simulando ${p.length} jornadas pendientes...`);
    await procesarJornadas(p);
    overlayOff();
};

async function procesarJornadas(nums) {
    for (const num of nums) {
        document.getElementById('overlay-text').innerText = `Simulando Jornada ${num} / ${TOT}...`;
        const { data: partidos } = await db.from('jornadas').select('id').eq('temporada', TEMPORADA).eq('numero_jornada', num).neq('estado','finalizado');
        if (!partidos) continue;
        for (const p of partidos) {
            const [gl, gv] = goles();
            await db.from('jornadas').update({ goles_local: gl, goles_visitante: gv, estado: 'finalizado', jugado_at: new Date().toISOString() }).eq('id', p.id);
        }
        estadoJ[num] = 'finalizado';
    }
    toast(`âœ… ${nums.length} jornada(s) simuladas`, 'ok');
    await cargarEstado(); renderTabs();
    await cargarJornada(jornadaActual);
    await cargarPosiciones();
}

function goles() {
    const w = [0.22,0.32,0.24,0.12,0.06,0.03,0.01];
    const r = () => { let x = Math.random(), a = 0; for(let i=0;i<w.length;i++){a+=w[i];if(x<a)return i;} return 0; };
    return [r(), r()];
}

// â”€â”€â”€ RESETEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.resetear = async function() {
    if (!confirm('Â¿Seguro? Esto borrarÃ¡ todos los partidos y posiciones de la temporada 2025.')) return;
    overlay('Reiniciando...');
    await db.from('jornadas').delete().eq('temporada', TEMPORADA);
    await db.from('posiciones').delete().neq('equipo', '___never___');
    estadoJ = {}; jornadaActual = 1;
    document.getElementById('stats-bar').style.display   = 'none';
    document.getElementById('main-grid').style.display   = 'none';
    document.getElementById('setup-panel').style.display = 'block';
    overlayOff(); toast('Temporada reiniciada', 'inf');
};

// â”€â”€â”€ POSICIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.cargarPosiciones = async function() {
    const { data } = await db.from('posiciones').select('*').eq('temporada', TEMPORADA)
        .order('pts',{ascending:false}).order('dg',{ascending:false}).order('gf',{ascending:false});
    const tbody = document.getElementById('standings-body');
    if (!data || !data.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:rgba(255,255,255,.3);">Sin datos aÃºn</td></tr>';
        return;
    }
    tbody.innerHTML = data.map((e, i) => {
        const p = i+1, pc = p===1?'pos-gold':p<=4?'pos-blue':'', dgc = e.dg>0?'dg-pos':e.dg<0?'dg-neg':'';
        return `<tr>
            <td><span class="pos-n ${pc}">${p}</span></td>
            <td>${e.equipo}</td>
            <td>${e.pj}</td><td>${e.pg}</td><td>${e.pe}</td><td>${e.pp}</td>
            <td class="${dgc}">${e.dg>0?'+':''}${e.dg}</td>
            <td class="pts-cell">${e.pts}</td>
        </tr>`;
    }).join('');
    if (data[0] && data[0].pts > 0) document.getElementById('s-lider').innerText = data[0].equipo.split(' ')[0];
};

// â”€â”€â”€ NAVEGACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.navJornada = async function(dir) {
    const n = jornadaActual + dir;
    if (n < 1 || n > TOT) return;
    await cargarJornada(n);
};
function actualizarNavBtns() {
    document.getElementById('btn-prev').disabled = jornadaActual <= 1;
    document.getElementById('btn-next').disabled = jornadaActual >= TOT;
}
function renderTabs() {
    const c = document.getElementById('jornada-tabs');
    c.innerHTML = '';
    for (let i = 1; i <= TOT; i++) {
        const b = document.createElement('button');
        b.className = 'tab-j' + (estadoJ[i]==='finalizado'?' done':'') + (i===jornadaActual?' active':'');
        b.innerText = i;
        b.onclick = () => cargarJornada(i);
        c.appendChild(b);
    }
}
function actualizarStats() {
    const j = Object.values(estadoJ).filter(e => e==='finalizado').length;
    document.getElementById('s-jornada').innerText = jornadaActual;
    document.getElementById('s-jugados').innerText = j * 9;
    document.getElementById('hero-sub').innerText  = `Jornada ${jornadaActual} de ${TOT}`;
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function overlay(txt) { document.getElementById('overlay-text').innerText = txt; document.getElementById('overlay').classList.add('show'); }
function overlayOff() { document.getElementById('overlay').classList.remove('show'); }
function toast(msg, t='inf') {
    const el = document.getElementById('toast');
    el.innerText = msg; el.className = `toast show ${t}`;
    setTimeout(() => el.classList.remove('show'), 4000);
}
window.cerrarSesion = async function() { await db.auth.signOut(); window.location.href = 'login.html'; };

init();
</script>
</body>
</html>
