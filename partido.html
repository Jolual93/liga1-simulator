<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga 1 ‚Äî Partido en Vivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #1a1a1a; color: white; font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; overflow-x: hidden; }

        /* HEADER */
        .top-bar { width: 800px; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .top-logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 3px; background: linear-gradient(135deg, #f1c40f, #e67e22); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .top-nav a { color: rgba(255,255,255,.4); text-decoration: none; font-size: 13px; font-weight: 600; margin-left: 16px; transition: color .2s; }
        .top-nav a:hover { color: #f1c40f; }

        /* SCORE BAR */
        #ui-panel { display: flex; justify-content: space-between; align-items: center; width: 800px; background: #2c3e50; padding: 12px 20px; border-radius: 10px; margin-bottom: 6px; box-shadow: 0 4px 10px rgba(0,0,0,.4); }
        .score-board { font-size: 22px; font-weight: bold; display: flex; gap: 16px; align-items: center; }
        .team-home { color: #3498db; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        .team-away { color: #e74c3c; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        .timer { font-size: 24px; font-weight: bold; color: #ecf0f1; background: rgba(0,0,0,.4); padding: 5px 14px; border-radius: 8px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }
        .timer.live { color: #2ecc71; animation: pulse-timer 1s infinite; }
        .timer.replay { color: #f1c40f; }
        @keyframes pulse-timer { 0%,100%{opacity:1;} 50%{opacity:.6;} }

        /* MODO BADGE */
        .mode-badge { font-family: 'Bebas Neue', sans-serif; font-size: 13px; letter-spacing: 2px; padding: 3px 10px; border-radius: 5px; }
        .badge-live  { background: #c0392b; color: #fff; animation: blink-bg .8s infinite; }
        .badge-replay { background: #8e44ad; color: #fff; }
        .badge-wait  { background: #2c3e50; border: 1px solid #f1c40f; color: #f1c40f; }
        @keyframes blink-bg { 0%,100%{background:#c0392b;} 50%{background:#e74c3c;} }

        /* EVENTOS BAND */
        #live-events { display: flex; justify-content: space-between; width: 800px; padding: 8px 16px; font-size: 13px; margin-bottom: 6px; background: rgba(44,62,80,.8); border-radius: 8px; min-height: 44px; border: 2px solid #34495e; }
        #home-scorers { color: #3498db; width: 48%; text-align: left; }
        #away-scorers { color: #e74c3c; width: 48%; text-align: right; }

        /* CANVAS */
        canvas { background-color: #27ae60; border: 4px solid #fff; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,.5); display: block; }

        /* GOL OVERLAY */
        #goal-overlay { display: none; position: absolute; width: 800px; height: 500px; z-index: 500; pointer-events: none; overflow: hidden; background: radial-gradient(ellipse at center, rgba(241,196,15,.3) 0%, rgba(0,0,0,.7) 100%); }
        #goal-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0); font-family: 'Bebas Neue', sans-serif; font-size: 120px; color: #f1c40f; text-shadow: 0 0 60px rgba(241,196,15,1), 4px 4px 0 #000; white-space: nowrap; transition: transform .3s cubic-bezier(.34,1.56,.64,1); letter-spacing: 8px; }
        #goal-scorer-text { position: absolute; top: 62%; left: 50%; transform: translateX(-50%); font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: white; text-shadow: 2px 2px 0 #000; letter-spacing: 3px; opacity: 0; transition: opacity .4s ease .3s; }
        .confetti-piece { position: absolute; opacity: 0; animation: confettiFall 1.5s ease-out forwards; }
        @keyframes confettiFall { 0%{opacity:1;transform:translateY(-20px) rotate(0);} 100%{opacity:0;transform:translateY(520px) rotate(720deg);} }

        /* WAITING PANEL */
        #waiting-panel { width: 800px; background: linear-gradient(135deg, rgba(241,196,15,.07), rgba(230,126,34,.04)); border: 1px solid rgba(241,196,15,.2); border-radius: 16px; padding: 48px 32px; text-align: center; }
        .wait-icon { font-size: 64px; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .wait-title { font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 4px; color: #f1c40f; margin-bottom: 8px; }
        .wait-desc { color: rgba(255,255,255,.4); font-size: 15px; margin-bottom: 24px; }
        #countdown { font-family: 'Bebas Neue', sans-serif; font-size: 56px; color: #f1c40f; letter-spacing: 4px; }
        .wait-match { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 16px 24px; margin: 20px auto; max-width: 400px; }
        .wait-match-teams { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; margin-bottom: 6px; }
        .wait-match-sub { color: rgba(255,255,255,.3); font-size: 12px; letter-spacing: 1px; }

        /* PARTIDOS LISTA */
        .matches-list { width: 800px; margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .match-item { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.07); border-radius: 10px; padding: 10px 14px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; cursor: pointer; transition: border-color .2s; }
        .match-item:hover { border-color: rgba(241,196,15,.4); }
        .match-item.mi-partido { border-color: #f1c40f; background: rgba(241,196,15,.06); }
        .match-item.en-vivo { border-left: 3px solid #2ecc71; }
        .match-item.finalizado { border-left: 3px solid rgba(255,255,255,.2); opacity: .7; }
        .mi-equipo { color: #f1c40f; }
        .mt { font-family: 'Bebas Neue', sans-serif; font-size: 14px; }
        .mt.home { text-align: right; }
        .mt.away { text-align: left; }
        .ms { font-family: 'Bebas Nye', sans-serif; font-size: 18px; text-align: center; white-space: nowrap; }
        .ms-pending { color: rgba(255,255,255,.25); font-size: 11px; }

        /* FIN PARTIDO */
        #fin-panel { display: none; width: 800px; background: linear-gradient(135deg,#1a1a1a,#0a0a0a); border: 2px solid #f1c40f; border-radius: 16px; padding: 32px; text-align: center; margin-top: 12px; }
        .fin-title { font-family: 'Bebas Neue', sans-serif; font-size: 40px; letter-spacing: 5px; color: #f1c40f; }
        .fin-score { font-family: 'Bebas Neue', sans-serif; font-size: 64px; letter-spacing: 8px; margin: 8px 0; }
        .fin-equipos { font-size: 18px; color: rgba(255,255,255,.5); margin-bottom: 16px; }
        .fin-btns { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .btn { padding: 11px 24px; border-radius: 10px; font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; cursor: pointer; border: none; transition: .2s; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; color: #fff; }
        .btn-gold { background: #f1c40f; color: #000; }
        .btn-gold:hover { background: #f39c12; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,.2); }
        .btn-outline:hover { border-color: #f1c40f; color: #f1c40f; }

        @media (max-width: 820px) {
            .top-bar, #ui-panel, #live-events, canvas, #goal-overlay, #waiting-panel, .matches-list, #fin-panel { width: 100%; }
            canvas { width: 100%; height: auto; }
            .matches-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
    <div class="top-logo">‚öΩ LIGA 1 SIM</div>
    <nav class="top-nav">
        <a href="dashboard.html">Mi Equipo</a>
        <a href="jornadas.html">Jornadas</a>
    </nav>
</div>

<!-- SCORE BAR -->
<div id="ui-panel" style="display:none;">
    <div class="score-board">
        <span id="scoreHome" class="team-home">Local: 0</span>
        <span style="color:rgba(255,255,255,.3);">‚Äî</span>
        <span id="scoreAway" class="team-away">Visita: 0</span>
    </div>
    <span class="timer" id="timer">0'</span>
    <span class="mode-badge badge-live" id="mode-badge">‚óè EN VIVO</span>
</div>

<!-- EVENTOS -->
<div id="live-events" style="display:none;">
    <div id="home-scorers"></div>
    <div id="away-scorers"></div>
</div>

<!-- CANVAS WRAPPER -->
<div style="position:relative; display:none;" id="canvas-wrap">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="goal-overlay">
        <div id="goal-text">‚öΩ GOL</div>
        <div id="goal-scorer-text"></div>
    </div>
</div>

<!-- FIN PARTIDO -->
<div id="fin-panel">
    <div class="fin-title" id="fin-titulo">Partido Finalizado</div>
    <div class="fin-equipos" id="fin-equipos">‚Äî</div>
    <div class="fin-score" id="fin-score">0 ‚Äî 0</div>
    <div id="fin-goles" style="margin-top:8px; color:rgba(255,255,255,.5); font-size:13px;"></div>
    <div class="fin-btns">
        <button class="btn btn-gold" id="btn-replay" onclick="iniciarReplay()">üé¨ Ver Replay</button>
        <a href="jornadas.html" class="btn btn-outline">‚Üê Jornadas</a>
    </div>
</div>

<!-- WAITING PANEL -->
<div id="waiting-panel">
    <div class="wait-icon">‚öΩ</div>
    <div class="wait-title">Pr√≥xima Jornada</div>
    <div class="wait-desc">Los partidos comienzan hoy a las <strong style="color:#f1c40f;">7:00 PM</strong> (hora Per√∫)</div>
    <div id="countdown">--:--:--</div>
    <div class="wait-match" id="mi-partido-info" style="display:none;">
        <div class="wait-match-sub">TU PARTIDO HOY</div>
        <div class="wait-match-teams" id="mi-partido-teams">‚Äî</div>
        <div class="wait-match-sub" id="mi-partido-jornada">Jornada ‚Äî</div>
    </div>
</div>

<!-- LISTA DE PARTIDOS -->
<div class="matches-list" id="matches-list"></div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const SUPABASE_URL = 'https://hpvpxadhbftiulwmysaw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Inip39JWInROxtuAaTL9rQ_f24sZcFa';
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// ‚îÄ‚îÄ‚îÄ CONSTANTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CANVAS_W = 800, CANVAS_H = 500;
const GOAL_Y_START = 175, GOAL_Y_END = 325, GOAL_HEIGHT = 150;
const MATCH_DURATION = 90;      // segundos reales por partido (= 90 min comprimidos)
const MIN_PER_SEC = 1;          // 1 segundo real = 1 minuto de juego

// Velocidad del replay: cu√°ntos eventos por segundo se reproducen
const REPLAY_SPEED_MS = 800;

// ‚îÄ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let miEquipo = null;             // datos del equipo del usuario
let jornadaActiva = null;        // config_liga row
let partidoActual = null;        // jornada row (el partido del usuario)
let todosLosPartidos = [];       // todos los partidos de la jornada
let eventos = [];                // eventos del partido actual cargados
let replayIdx = 0;
let modoVista = 'wait';          // 'wait' | 'live' | 'replay' | 'fin'
let matchMinuto = 0;
let scoreHome = 0, scoreAway = 0;
let realtimeChannel = null;

// ‚îÄ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Colores de equipos (se asignan al cargar partido)
let colorHome = '#3498db', colorAway = '#e74c3c';
let nombreHome = 'Local', nombreAway = 'Visita';

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
    const { data: { session } } = await db.auth.getSession();
    if (!session) { window.location.href = 'login.html'; return; }
    currentUser = session.user;

    // Cargar equipo del usuario
    const { data: eq } = await db.from('equipos').select('*').eq('user_id', currentUser.id).single();
    miEquipo = eq;

    await cargarEstado();
    iniciarCountdown();
    gameLoop();
}

// ‚îÄ‚îÄ‚îÄ CARGAR ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarEstado() {
    // Config liga
    const { data: cfg } = await db.from('config_liga').select('*').eq('id', 1).single();
    jornadaActiva = cfg;

    if (!cfg || cfg.jornada_activa === 0) {
        mostrarWaiting('Sin jornada programada a√∫n');
        return;
    }

    // Todos los partidos de la jornada activa
    const { data: partidos } = await db
        .from('jornadas')
        .select('*')
        .eq('temporada', '2025')
        .eq('numero_jornada', cfg.jornada_activa)
        .order('id');

    todosLosPartidos = partidos || [];

    // Encontrar el partido del usuario
    if (miEquipo) {
        const equipoBase = EQUIPO_BASE_NAMES[miEquipo.equipo_base] || miEquipo.nombre;
        partidoActual = todosLosPartidos.find(p =>
            p.equipo_local === equipoBase || p.equipo_visitante === equipoBase
        );
    }

    // Mostrar lista de partidos
    renderMatchesList();

    if (cfg.estado === 'en_vivo') {
        await iniciarModoVivo();
    } else if (cfg.estado === 'finalizado') {
        await iniciarModoFinJornada();
    } else {
        mostrarWaiting();
        if (partidoActual) mostrarInfoMiPartido();
    }

    // Suscribir a cambios en tiempo real
    suscribirRealtime();
}

// ‚îÄ‚îÄ‚îÄ MODO EN VIVO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciarModoVivo() {
    if (!partidoActual) {
        mostrarWaiting('Tu equipo no juega en esta jornada');
        return;
    }

    modoVista = 'live';
    mostrarCanvas();

    // Configurar colores y nombres del partido
    configurarPartido(partidoActual);

    // Cargar eventos ya ocurridos (para sincronizar si llego tarde)
    const { data: evts } = await db
        .from('eventos_partido')
        .select('*')
        .eq('partido_id', partidoActual.id)
        .order('minuto');

    eventos = evts || [];

    // Recalcular estado actual del marcador desde eventos guardados
    eventos.forEach(ev => {
        if (ev.tipo === 'gol') {
            if (ev.es_local) scoreHome++; else scoreAway++;
            registrarEventoUI(ev);
        }
    });

    // Calcular minuto actual
    if (jornadaActiva.inicio_jornada) {
        const elapsed = (Date.now() - new Date(jornadaActiva.inicio_jornada).getTime()) / 1000;
        matchMinuto = Math.min(90, Math.floor(elapsed * MIN_PER_SEC));
    }

    actualizarScoreUI();
    actualizarTimerUI(matchMinuto);
    document.getElementById('mode-badge').className = 'mode-badge badge-live';
    document.getElementById('mode-badge').innerText = '‚óè EN VIVO';

    // Iniciar simulaci√≥n visual del campo (solo animaci√≥n, no l√≥gica real)
    iniciarAnimacionCampo();
}

// ‚îÄ‚îÄ‚îÄ MODO FIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciarModoFinJornada() {
    modoVista = 'fin';

    if (!partidoActual || partidoActual.estado !== 'finalizado') {
        mostrarWaiting('Jornada finalizada. Revisa los resultados abajo.');
        renderMatchesList();
        return;
    }

    scoreHome = partidoActual.goles_local ?? 0;
    scoreAway = partidoActual.goles_visitante ?? 0;

    document.getElementById('waiting-panel').style.display = 'none';
    const fin = document.getElementById('fin-panel');
    fin.style.display = 'block';

    document.getElementById('fin-titulo').innerText = 'Partido Finalizado';
    document.getElementById('fin-equipos').innerText =
        `${partidoActual.equipo_local} vs ${partidoActual.equipo_visitante}`;
    document.getElementById('fin-score').innerText = `${scoreHome} ‚Äî ${scoreAway}`;

    // Cargar eventos para el replay
    const { data: evts } = await db
        .from('eventos_partido')
        .select('*')
        .eq('partido_id', partidoActual.id)
        .order('minuto');
    eventos = evts || [];

    const goles = eventos.filter(e => e.tipo === 'gol');
    if (goles.length) {
        document.getElementById('fin-goles').innerHTML = goles.map(g =>
            `<span style="color:${g.es_local ? colorHome : colorAway}">‚öΩ ${g.minuto}' ${g.jugador || ''}${g.es_local ? ' (L)' : ' (V)'}</span>`
        ).join('  ¬∑  ');
    }
}

// ‚îÄ‚îÄ‚îÄ REPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.iniciarReplay = function() {
    if (!eventos.length) { alert('No hay eventos guardados para el replay'); return; }

    modoVista = 'replay';
    document.getElementById('fin-panel').style.display = 'none';
    document.getElementById('canvas-wrap').style.display = 'block';
    document.getElementById('ui-panel').style.display = 'flex';
    document.getElementById('live-events').style.display = 'flex';

    scoreHome = 0; scoreAway = 0; replayIdx = 0;
    actualizarScoreUI();
    document.getElementById('home-scorers').innerHTML = '';
    document.getElementById('away-scorers').innerHTML = '';
    document.getElementById('mode-badge').className = 'mode-badge badge-replay';
    document.getElementById('mode-badge').innerText = 'üé¨ REPLAY';

    configurarPartido(partidoActual);
    iniciarAnimacionCampo();

    // Reproducir eventos uno a uno
    reproducirSiguienteEvento();
};

function reproducirSiguienteEvento() {
    if (replayIdx >= eventos.length) {
        // Replay terminado
        setTimeout(() => {
            document.getElementById('mode-badge').innerText = '‚úÖ FIN';
            mostrarAnimacionGol('Fin del partido', '#f1c40f');
        }, 1000);
        return;
    }

    const ev = eventos[replayIdx++];
    actualizarTimerUI(ev.minuto);

    if (ev.tipo === 'gol') {
        if (ev.es_local) scoreHome++; else scoreAway++;
        actualizarScoreUI();
        registrarEventoUI(ev);
        mostrarAnimacionGol(ev.jugador, ev.es_local ? colorHome : colorAway);
        setTimeout(reproducirSiguienteEvento, REPLAY_SPEED_MS * 4);
    } else {
        setTimeout(reproducirSiguienteEvento, REPLAY_SPEED_MS);
    }
}

// ‚îÄ‚îÄ‚îÄ REALTIME SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function suscribirRealtime() {
    if (realtimeChannel) db.removeChannel(realtimeChannel);

    realtimeChannel = db.channel('partido-vivo')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'eventos_partido',
            filter: partidoActual ? `partido_id=eq.${partidoActual.id}` : undefined
        }, payload => {
            const ev = payload.new;
            if (ev.tipo === 'gol') {
                if (ev.es_local) scoreHome++; else scoreAway++;
                actualizarScoreUI();
                registrarEventoUI(ev);
                mostrarAnimacionGol(ev.jugador, ev.es_local ? colorHome : colorAway);
            }
        })
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'config_liga'
        }, payload => {
            const cfg = payload.new;
            jornadaActiva = cfg;
            if (cfg.estado === 'en_vivo' && modoVista === 'wait') {
                cargarEstado();
            } else if (cfg.estado === 'finalizado' && modoVista === 'live') {
                modoVista = 'fin';
                setTimeout(() => iniciarModoFinJornada(), 2000);
            }
        })
        .subscribe();
}

// ‚îÄ‚îÄ‚îÄ ANIMACI√ìN DEL CAMPO (visual) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Los jugadores se mueven aleatoriamente para dar sensaci√≥n de partido en vivo
// La l√≥gica real de goles viene de Supabase Realtime
let animPlayers = [];
let animBall = { x: CANVAS_W/2, y: CANVAS_H/2, vx: 2, vy: 1.5 };
let animActive = false;
let timerInterval = null;

function iniciarAnimacionCampo() {
    animActive = true;
    animPlayers = [];

    // Crear 22 jugadores animados
    const formHome = [{x:130,y:100},{x:110,y:200},{x:110,y:300},{x:130,y:400},{x:250,y:100},{x:220,y:200},{x:220,y:300},{x:250,y:400},{x:350,y:180},{x:350,y:320},{x:30,y:250}];
    const formAway = [{x:670,y:100},{x:690,y:200},{x:690,y:300},{x:670,y:400},{x:550,y:100},{x:580,y:200},{x:580,y:300},{x:550,y:400},{x:450,y:180},{x:450,y:320},{x:770,y:250}];

    formHome.forEach((p, i) => animPlayers.push({ x: p.x, y: p.y, bx: p.x, by: p.y, team: 'home', num: i+1, vx: 0, vy: 0 }));
    formAway.forEach((p, i) => animPlayers.push({ x: p.x, y: p.y, bx: p.x, by: p.y, team: 'away', num: i+1, vx: 0, vy: 0 }));

    animBall = { x: CANVAS_W/2, y: CANVAS_H/2, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4 };

    // Timer en vivo
    if (timerInterval) clearInterval(timerInterval);
    if (modoVista === 'live') {
        timerInterval = setInterval(() => {
            if (modoVista !== 'live') { clearInterval(timerInterval); return; }
            matchMinuto = Math.min(90, matchMinuto + 1);
            actualizarTimerUI(matchMinuto);
            if (matchMinuto >= 90) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "90'";
            }
        }, 1000);
    }
}

function updateAnimacion() {
    if (!animActive) return;

    // Mover pelota
    animBall.x += animBall.vx;
    animBall.y += animBall.vy;
    animBall.vx *= 0.99;
    animBall.vy *= 0.99;

    // Rebotes
    if (animBall.x < 6)  { animBall.x = 6;  animBall.vx *= -1; }
    if (animBall.x > CANVAS_W-6) { animBall.x = CANVAS_W-6; animBall.vx *= -1; }
    if (animBall.y < 6)  { animBall.y = 6;  animBall.vy *= -1; }
    if (animBall.y > CANVAS_H-6) { animBall.y = CANVAS_H-6; animBall.vy *= -1; }

    // Velocidad m√≠nima
    if (Math.abs(animBall.vx) < 1) animBall.vx = (Math.random()-0.5) * 4;
    if (Math.abs(animBall.vy) < 1) animBall.vy = (Math.random()-0.5) * 4;

    // Mover jugadores hacia la pelota con algo de aleatoriedad
    animPlayers.forEach(p => {
        const targetX = animBall.x + (Math.random()-0.5)*120 + (p.team==='home' ? -60 : 60);
        const targetY = animBall.y + (Math.random()-0.5)*80;
        const bx = p.bx, by = p.by;

        const destX = (targetX + bx) / 2;
        const destY = (targetY + by) / 2;

        const dx = destX - p.x;
        const dy = destY - p.y;
        const dist = Math.hypot(dx, dy);

        if (dist > 2) {
            const spd = 1.5;
            p.x += (dx/dist) * spd;
            p.y += (dy/dist) * spd;
        }

        p.x = Math.max(p.team==='home'?5:CANVAS_W/2, Math.min(p.team==='home'?CANVAS_W/2:CANVAS_W-5, p.x));
        p.y = Math.max(5, Math.min(CANVAS_H-5, p.y));
    });
}

function dibujarCampo() {
    ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

    // Campo verde
    ctx.fillStyle = '#27ae60';
    ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);

    // L√≠neas
    ctx.strokeStyle = 'rgba(255,255,255,.7)';
    ctx.lineWidth = 3;
    ctx.strokeRect(2, 2, CANVAS_W-4, CANVAS_H-4);

    // L√≠nea central
    ctx.beginPath(); ctx.moveTo(CANVAS_W/2, 0); ctx.lineTo(CANVAS_W/2, CANVAS_H); ctx.stroke();

    // C√≠rculo central
    ctx.beginPath(); ctx.arc(CANVAS_W/2, CANVAS_H/2, 60, 0, Math.PI*2); ctx.stroke();

    // Porter√≠as
    ctx.lineWidth = 4;
    ctx.strokeStyle = colorHome;
    ctx.beginPath(); ctx.moveTo(0, GOAL_Y_START); ctx.lineTo(0, GOAL_Y_END); ctx.stroke();
    ctx.strokeStyle = colorAway;
    ctx.beginPath(); ctx.moveTo(CANVAS_W, GOAL_Y_START); ctx.lineTo(CANVAS_W, GOAL_Y_END); ctx.stroke();

    // √Åreas
    ctx.strokeStyle = 'rgba(255,255,255,.5)'; ctx.lineWidth = 2;
    ctx.strokeRect(0, GOAL_Y_START-50, 100, GOAL_HEIGHT+100);
    ctx.strokeRect(CANVAS_W-100, GOAL_Y_START-50, 100, GOAL_HEIGHT+100);

    // Jugadores
    animPlayers.forEach(p => {
        const col = p.team === 'home' ? colorHome : colorAway;
        ctx.beginPath(); ctx.arc(p.x, p.y, 9, 0, Math.PI*2);
        ctx.fillStyle = col; ctx.fill();
        ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#fff'; ctx.font = 'bold 9px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(p.num, p.x, p.y);
    });

    // Pelota
    ctx.beginPath(); ctx.arc(animBall.x, animBall.y, 7, 0, Math.PI*2);
    ctx.fillStyle = '#fff'; ctx.fill();
    ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5; ctx.stroke();
}

function gameLoop() {
    if (animActive && (modoVista === 'live' || modoVista === 'replay')) {
        updateAnimacion();
        dibujarCampo();
    } else if (modoVista === 'wait' || modoVista === 'fin') {
        // No renderizar canvas
    }
    requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ‚îÄ HELPERS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function configurarPartido(p) {
    const colores = TEAM_COLORS;
    colorHome = colores[p.equipo_local]?.c1 || '#3498db';
    colorAway = colores[p.equipo_visitante]?.c1 || '#e74c3c';
    nombreHome = p.equipo_local;
    nombreAway = p.equipo_visitante;
    actualizarScoreUI();
}

function actualizarScoreUI() {
    document.getElementById('scoreHome').innerText = `${nombreHome.substring(0,10)}: ${scoreHome}`;
    document.getElementById('scoreHome').style.color = colorHome;
    document.getElementById('scoreAway').innerText = `${nombreAway.substring(0,10)}: ${scoreAway}`;
    document.getElementById('scoreAway').style.color = colorAway;
}

function actualizarTimerUI(min) {
    const el = document.getElementById('timer');
    el.innerText = `${min}'`;
    el.className = 'timer ' + (modoVista === 'live' ? 'live' : 'replay');
}

function registrarEventoUI(ev) {
    const min = ev.minuto;
    const gol = `<div style="margin-top:2px;">‚öΩ ${min}' ${ev.jugador || 'Jugador'}</div>`;
    if (ev.es_local) document.getElementById('home-scorers').innerHTML += gol;
    else document.getElementById('away-scorers').innerHTML += gol;
}

function mostrarCanvas() {
    document.getElementById('waiting-panel').style.display = 'none';
    document.getElementById('canvas-wrap').style.display = 'block';
    document.getElementById('ui-panel').style.display = 'flex';
    document.getElementById('live-events').style.display = 'flex';
}

function mostrarWaiting(msg = null) {
    document.getElementById('canvas-wrap').style.display = 'none';
    document.getElementById('ui-panel').style.display = 'none';
    document.getElementById('live-events').style.display = 'none';
    document.getElementById('fin-panel').style.display = 'none';
    document.getElementById('waiting-panel').style.display = 'block';
    if (msg) document.getElementById('waiting-panel').querySelector('.wait-desc').innerText = msg;
}

function mostrarInfoMiPartido() {
    if (!partidoActual || !jornadaActiva) return;
    const el = document.getElementById('mi-partido-info');
    el.style.display = 'block';
    document.getElementById('mi-partido-teams').innerText =
        `${partidoActual.equipo_local} vs ${partidoActual.equipo_visitante}`;
    document.getElementById('mi-partido-jornada').innerText =
        `Jornada ${jornadaActiva.jornada_activa}`;
}

function renderMatchesList() {
    const container = document.getElementById('matches-list');
    if (!todosLosPartidos.length) { container.innerHTML = ''; return; }

    const equipoBase = miEquipo ? (EQUIPO_BASE_NAMES[miEquipo.equipo_base] || miEquipo.nombre) : null;

    container.innerHTML = todosLosPartidos.map(p => {
        const esMio = equipoBase && (p.equipo_local === equipoBase || p.equipo_visitante === equipoBase);
        const fin = p.estado === 'finalizado';
        const vivo = p.estado === 'en_curso';
        const clases = `match-item ${esMio?'mi-partido':''} ${fin?'finalizado':''} ${vivo?'en-vivo':''}`;
        const score = fin
            ? `<span class="ms">${p.goles_local} ‚Äî ${p.goles_visitante}</span>`
            : `<span class="ms ms-pending">${vivo?'EN VIVO':'VS'}</span>`;
        return `<div class="${clases}" onclick="verPartido('${p.id}')">
            <span class="mt home ${esMio&&p.equipo_local===equipoBase?'mi-equipo':''}">${p.equipo_local}</span>
            ${score}
            <span class="mt away ${esMio&&p.equipo_visitante===equipoBase?'mi-equipo':''}">${p.equipo_visitante}</span>
        </div>`;
    }).join('');
}

window.verPartido = async function(id) {
    const p = todosLosPartidos.find(x => x.id === id);
    if (!p) return;
    partidoActual = p;
    configurarPartido(p);

    if (p.estado === 'finalizado') {
        scoreHome = p.goles_local;
        scoreAway = p.goles_visitante;
        const { data: evts } = await db.from('eventos_partido').select('*').eq('partido_id', id).order('minuto');
        eventos = evts || [];
        await iniciarModoFinJornada();
    } else if (p.estado === 'en_curso' || jornadaActiva?.estado === 'en_vivo') {
        await iniciarModoVivo();
    }
};

// ‚îÄ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciarCountdown() {
    function tick() {
        if (modoVista !== 'wait') return;

        const now = new Date();
        const target = new Date();
        target.setHours(19, 0, 0, 0); // 7PM hora local (el servidor ajusta a UTC-5)

        let diff = target - now;
        if (diff < 0) diff += 86400000; // si ya pas√≥, ma√±ana

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        document.getElementById('countdown').innerText =
            `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick();
    setInterval(tick, 1000);
}

// ‚îÄ‚îÄ‚îÄ ANIMACI√ìN GOL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarAnimacionGol(nombre, color) {
    const overlay = document.getElementById('goal-overlay');
    const txt = document.getElementById('goal-text');
    const stxt = document.getElementById('goal-scorer-text');
    overlay.querySelectorAll('.confetti-piece').forEach(c => c.remove());
    overlay.style.display = 'block';
    txt.style.color = color || '#f1c40f';
    txt.style.transform = 'translate(-50%,-50%) scale(1)';
    stxt.style.opacity = '1';
    stxt.innerText = nombre ? `‚öΩ ${nombre}` : '‚öΩ GOL';
    const colors = ['#f1c40f','#e74c3c','#3498db','#2ecc71','#9b59b6','#fff'];
    for (let i = 0; i < 30; i++) {
        const c = document.createElement('div');
        c.className = 'confetti-piece';
        c.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*30}%;background:${colors[Math.floor(Math.random()*colors.length)]};width:${Math.random()*12+6}px;height:${Math.random()*12+6}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-delay:${Math.random()*.5}s;animation-duration:${Math.random()+1}s;`;
        overlay.appendChild(c);
    }
    setTimeout(() => {
        txt.style.transform = 'translate(-50%,-50%) scale(0)';
        stxt.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 400);
    }, 2200);
}

// ‚îÄ‚îÄ‚îÄ DATOS EQUIPOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EQUIPO_BASE_NAMES = {
    'u': 'Universitario', 'al': 'Alianza Lima', 'sc': 'Sporting Cristal',
    'mel': 'Melgar', 'cus': 'Cusco FC', 'cie': 'Cienciano',
    'adt': 'ADT', 'gra': 'Grau', 'shu': 'Sport Huancayo', 'sba': 'Sport Boys'
};

const TEAM_COLORS = {
    'Universitario':    { c1: '#f3e5ab', c2: '#800000' },
    'Alianza Lima':     { c1: '#1a237e', c2: '#ffffff' },
    'Sporting Cristal': { c1: '#5DADE2', c2: '#ffffff' },
    'Melgar':           { c1: '#c0392b', c2: '#000000' },
    'Cusco FC':         { c1: '#d4af37', c2: '#000000' },
    'Cienciano':        { c1: '#e74c3c', c2: '#ffffff' },
    'ADT':              { c1: '#74b9ff', c2: '#2d3436' },
    'UTC':              { c1: '#f5deb3', c2: '#800000' },
    'Mannucci':         { c1: '#f39c12', c2: '#2c3e50' },
    'Binacional':       { c1: '#27ae60', c2: '#ffffff' },
    'Deportivo Garcilaso': { c1: '#81ecec', c2: '#1a1a1a' },
    'Sport Huancayo':   { c1: '#b33939', c2: '#27ae60' },
    'Cesar Vallejo':    { c1: '#8e44ad', c2: '#f1c40f' },
    'Grau':             { c1: '#ffec13', c2: '#1a1a1a' },
    'Alianza Atl√©tico': { c1: '#ecf0f1', c2: '#2980b9' },
    'Los Chankas':      { c1: '#d63031', c2: '#d4af37' },
    'Ayacucho FC':      { c1: '#e67e22', c2: '#ffffff' },
    'UCV':              { c1: '#c0392b', c2: '#f1c40f' }
};

init();
</script>
</body>
</html>
