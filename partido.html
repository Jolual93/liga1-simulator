<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga 1 â€” Partido en Vivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--gold:#f1c40f;--dark:#1a1a1a;--mid:#2c3e50;--blue:#3498db;--red:#e74c3c;--green:#27ae60;}
        *{box-sizing:border-box;margin:0;padding:0;}
        body{background:var(--dark);color:white;font-family:'Rajdhani',sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:10px;overflow-x:hidden;}
        .top-bar{width:800px;display:flex;justify-content:space-between;align-items:center;padding:10px 0;}
        .top-logo{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;background:linear-gradient(135deg,#f1c40f,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .top-nav a{color:rgba(255,255,255,.4);text-decoration:none;font-size:13px;font-weight:600;margin-left:16px;transition:color .2s;}
        .top-nav a:hover{color:#f1c40f;}
        #ui-panel{display:flex;justify-content:space-between;align-items:center;width:800px;background:var(--mid);padding:12px 20px;border-radius:10px;margin-bottom:6px;box-shadow:0 4px 10px rgba(0,0,0,.4);}
        .score-board{font-size:22px;font-weight:bold;display:flex;gap:16px;align-items:center;}
        #scoreAzul{color:var(--blue);font-family:'Bebas Neue',sans-serif;letter-spacing:1px;}
        #scoreRojo{color:var(--red);font-family:'Bebas Neue',sans-serif;letter-spacing:1px;}
        #timeEl{font-size:24px;font-weight:bold;color:#ecf0f1;background:rgba(0,0,0,.4);padding:5px 14px;border-radius:8px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;}
        .mode-badge{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;padding:3px 10px;border-radius:5px;}
        .badge-live{background:#c0392b;color:#fff;animation:blink-bg .8s infinite;}
        .badge-replay{background:#8e44ad;color:#fff;}
        @keyframes blink-bg{0%,100%{background:#c0392b;}50%{background:#e74c3c;}}
        #live-events{display:flex;justify-content:space-between;width:800px;padding:8px 16px;font-size:13px;margin-bottom:6px;background:rgba(44,62,80,.8);border-radius:8px;min-height:44px;border:2px solid #34495e;}
        #home-scorers{color:var(--blue);width:48%;text-align:left;}
        #away-scorers{color:var(--red);width:48%;text-align:right;}
        #canvas-wrap{position:relative;}
        canvas{background-color:#27ae60;border:4px solid #fff;border-radius:4px;box-shadow:0 10px 20px rgba(0,0,0,.5);display:block;}
        #goal-overlay{display:none;position:absolute;top:0;left:0;width:800px;height:500px;z-index:500;pointer-events:none;overflow:hidden;background:radial-gradient(ellipse at center,rgba(241,196,15,.3) 0%,rgba(0,0,0,.7) 100%);}
        #goal-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);font-family:'Bebas Neue',sans-serif;font-size:120px;color:#f1c40f;text-shadow:0 0 60px rgba(241,196,15,1),4px 4px 0 #000;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);letter-spacing:8px;}
        #goal-scorer-text{position:absolute;top:62%;left:50%;transform:translateX(-50%);font-family:'Bebas Neue',sans-serif;font-size:28px;color:white;text-shadow:2px 2px 0 #000;letter-spacing:3px;opacity:0;transition:opacity .4s ease .3s;}
        .confetti-piece{position:absolute;opacity:0;animation:confettiFall 1.5s ease-out forwards;}
        @keyframes confettiFall{0%{opacity:1;transform:translateY(-20px) rotate(0);}100%{opacity:0;transform:translateY(520px) rotate(720deg);}}
        #waiting-panel{width:800px;background:linear-gradient(135deg,rgba(241,196,15,.07),rgba(230,126,34,.04));border:1px solid rgba(241,196,15,.2);border-radius:16px;padding:48px 32px;text-align:center;}
        .wait-icon{font-size:64px;margin-bottom:16px;animation:float 3s ease-in-out infinite;}
        @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
        .wait-title{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:4px;color:#f1c40f;margin-bottom:8px;}
        .wait-desc{color:rgba(255,255,255,.4);font-size:15px;margin-bottom:24px;}
        #countdown{font-family:'Bebas Neue',sans-serif;font-size:56px;color:#f1c40f;letter-spacing:4px;}
        .wait-match{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px 24px;margin:20px auto;max-width:400px;}
        .wait-match-teams{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;margin-bottom:6px;}
        .wait-match-sub{color:rgba(255,255,255,.3);font-size:12px;letter-spacing:1px;}
        .matches-list{width:800px;margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:8px;}
        .match-item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:10px 14px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;cursor:pointer;transition:border-color .2s;}
        .match-item:hover{border-color:rgba(241,196,15,.4);}
        .match-item.mi-partido{border-color:#f1c40f;background:rgba(241,196,15,.06);}
        .match-item.en-vivo{border-left:3px solid #2ecc71;}
        .match-item.finalizado{opacity:.7;}
        .mt{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:.5px;}
        .mt.home{text-align:right;}
        .mt.mi-equipo{color:#f1c40f;}
        .ms{font-family:'Bebas Neue',sans-serif;font-size:17px;text-align:center;}
        .ms-pending{color:rgba(255,255,255,.25);font-size:11px;text-align:center;}
        #fin-panel{display:none;width:800px;background:linear-gradient(135deg,#1a1a1a,#0a0a0a);border:2px solid #f1c40f;border-radius:16px;padding:32px;text-align:center;margin-top:12px;}
        .fin-title{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:5px;color:#f1c40f;}
        .fin-score{font-family:'Bebas Neue',sans-serif;font-size:64px;letter-spacing:8px;margin:8px 0;}
        .fin-equipos{font-size:18px;color:rgba(255,255,255,.5);margin-bottom:8px;}
        .fin-btns{display:flex;gap:12px;justify-content:center;margin-top:20px;}
        .btn{padding:11px 24px;border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;border:none;transition:.2s;text-decoration:none;display:inline-flex;align-items:center;gap:6px;color:#fff;}
        .btn-gold{background:#f1c40f;color:#000;}
        .btn-gold:hover{background:#f39c12;transform:translateY(-1px);}
        .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.2);}
        .btn-outline:hover{border-color:#f1c40f;color:#f1c40f;}
        @media(max-width:820px){.top-bar,#ui-panel,#live-events,#canvas-wrap,#waiting-panel,.matches-list,#fin-panel{width:100%;}canvas{width:100%;height:auto;}.matches-list{grid-template-columns:1fr;}}
    </style>
</head>
<body>

<div class="top-bar">
    <div class="top-logo">âš½ LIGA 1 SIM</div>
    <nav class="top-nav"><a href="dashboard.html">Mi Equipo</a><a href="jornadas.html">Jornadas</a></nav>
</div>

<div id="ui-panel" style="display:none;">
    <div class="score-board">
        <span id="scoreAzul">Local: 0</span>
        <span style="color:rgba(255,255,255,.3);">â€”</span>
        <span id="scoreRojo">Visita: 0</span>
    </div>
    <span id="timeEl">90</span>
    <span class="mode-badge badge-live" id="mode-badge">â— EN VIVO</span>
</div>

<div id="live-events" style="display:none;">
    <div id="home-scorers"></div>
    <div id="away-scorers"></div>
</div>

<div id="canvas-wrap" style="display:none;">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="goal-overlay">
        <div id="goal-text">âš½ GOL</div>
        <div id="goal-scorer-text"></div>
    </div>
</div>

<div id="fin-panel">
    <div class="fin-title">Partido Finalizado</div>
    <div class="fin-equipos" id="fin-equipos">â€”</div>
    <div class="fin-score" id="fin-score">0 â€” 0</div>
    <div id="fin-goles" style="margin-top:8px;color:rgba(255,255,255,.5);font-size:13px;"></div>
    <div class="fin-btns">
        <button class="btn btn-gold" onclick="iniciarReplay()">ğŸ¬ Ver Replay</button>
        <a href="jornadas.html" class="btn btn-outline">â† Jornadas</a>
    </div>
</div>

<div id="waiting-panel">
    <div class="wait-icon">âš½</div>
    <div class="wait-title">PrÃ³xima Jornada</div>
    <div class="wait-desc">Los partidos comienzan hoy a las <strong style="color:#f1c40f;">7:00 PM</strong> (hora PerÃº)</div>
    <div id="countdown">--:--:--</div>
    <div class="wait-match" id="mi-partido-info" style="display:none;">
        <div class="wait-match-sub">TU PARTIDO HOY</div>
        <div class="wait-match-teams" id="mi-partido-teams">â€”</div>
        <div class="wait-match-sub" id="mi-partido-jornada">Jornada â€”</div>
    </div>
</div>

<div class="matches-list" id="matches-list"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BASE DE DATOS â€” IGUAL QUE EL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATABASE_TEAMS = [
    {id:'u',   name:'Universitario de Deportes', c1:'#f3e5ab',c2:'#800000',power:90},
    {id:'al',  name:'Alianza Lima',               c1:'#1a237e',c2:'#ffffff',power:90},
    {id:'sc',  name:'Sporting Cristal',           c1:'#5DADE2',c2:'#ffffff',power:90},
    {id:'mel', name:'FBC Melgar',                 c1:'#c0392b',c2:'#000000',power:85},
    {id:'cus', name:'Cusco FC',                   c1:'#d4af37',c2:'#000000',power:85},
    {id:'sba', name:'Sport Boys Association',     c1:'#fd79a8',c2:'#000000',power:65},
    {id:'gar', name:'Deportivo Garcilaso',        c1:'#81ecec',c2:'#1a1a1a',power:65},
    {id:'com', name:'Comerciantes Unidos',        c1:'#6c5ce7',c2:'#f1c40f',power:60},
    {id:'cie', name:'Cienciano',                  c1:'#e74c3c',c2:'#ffffff',power:75},
    {id:'shu', name:'Sport Huancayo',             c1:'#b33939',c2:'#27ae60',power:70},
    {id:'adt', name:'ADT de Tarma',               c1:'#74b9ff',c2:'#2d3436',power:75},
    {id:'gra', name:'AtlÃ©tico Grau',              c1:'#ffec13',c2:'#1a1a1a',power:75},
    {id:'utc', name:'UTC Cajamarca',              c1:'#f5deb3',c2:'#800000',power:60},
    {id:'jpi', name:'Juan Pablo II College',      c1:'#f39c12',c2:'#e74c3c',power:60},
    {id:'cha', name:'CD Los Chankas',             c1:'#d63031',c2:'#d4af37',power:65},
    {id:'fcc', name:'FC Cajamarca',               c1:'#bdc3c7',c2:'#2c3e50',power:60},
    {id:'aal', name:'Alianza AtlÃ©tico Sullana',   c1:'#ecf0f1',c2:'#2980b9',power:65},
    {id:'moq', name:'Deportivo Moquegua',         c1:'#00b894',c2:'#ffffff',power:60}
];

const ROSTERS = {
    'u':  {Portero:['D. Romero','M. Vargas','J. RodrÃ­guez'],Central:['A. SantamarÃ­a','W. Riveros','M. Di Benedetto','A. Corzo'],Lateral:['C. Inga','J. CarabalÃ­','P. Reyna','H. Ancajima'],Medio:['J. Castillo','J. Murrugarra','J. Concha','H. Calcaterra','D. VÃ¡squez','S. Flores'],Extremo:['E. Flores','H. FÃ©rtoli','C. Loayza','A. Polo'],Delantero:['Ã. Valera','J. Rivera','S. Gassama','R. Dioses']},
    'al': {Portero:['G. Viscarra','A. Duarte','F. MesÃ­as'],Central:['R. GarcÃ©s','G. ChÃ¡vez','M. Antoni','J. VelÃ¡squez'],Lateral:['C. Carbajal','R. AlarcÃ³n','D. Montenegro','L. AdvÃ­ncula'],Medio:['P. Aquino','J. Castillo','E. Pavez','P. Cari','F. Gaibor'],Extremo:['K. Quevedo','A. Cantero','E. Castillo','G. Gentile'],Delantero:['F. Girotti','L. Ramos','P. Guerrero','G. Motta']},
    'sc': {Portero:['D. EnrÃ­quez','R. SolÃ­s','I. Spoljaric'],Central:['L. Abram','M. Araujo','R. Lutiger','A. PÃ³sito'],Lateral:['Cristiano','F. Lora','L. Sosa','J. GonzÃ¡lez'],Medio:['G. Cazonatti','C. Cabellos','M. TÃ¡vara','Y. YotÃºn','C. Benavente'],Extremo:['S. GonzÃ¡lez','M. Castro','S. SÃ¡nchez','J. Moretti'],Delantero:['F. Vizeu','L. Iberico','D. Otaya']},
    'mel':{Portero:['C. CÃ¡ceda','J. Cabezuado','R. Farro'],Central:['M. Lazo','J. AlcÃ¡ntar','A. Deneumostier'],Lateral:['N. Cabanillas','J. Ayque','Ã. Obando'],Medio:['J. Salas','W. Tandazo','Y. Gamero','K. YÃ¡Ã±ez','N. Quagliata'],Extremo:['J. CÃ¡ceres','F. Zanelatto','C. Bordacahar'],Delantero:['P. Erustes','J. de Santis','N. Figueroa']},
    'cus':{Portero:['P. DÃ­az','A. Vidal','R. Anderson'],Central:['C. Gamarra','G. Choi','A. Fuentes'],Lateral:['J. BolÃ­var','Ã. Ampuero','M. RuidÃ­as'],Medio:['M. Auca','O. Valenzuela','C. Diez','I. Colman'],Extremo:['L. Colitto','J. Manzaneda','J. AlÃ­'],Delantero:['F. Callejo','J. TÃ©vez']},
    'cie':{Portero:['J. Bolado','M. Vargas'],Central:['J. Valoyes','D. Ortiz','H. Riojas'],Lateral:['J. Estrada','A. Ugarriza','K. Aparicio'],Medio:['Ã. Romero','C. TorrejÃ³n','R. GarcÃ­a'],Extremo:['K. Sandoval','G. Gentile','J. Romagnoli'],Delantero:['D. Carando','G. Pacheco']},
    'adt':{Portero:['J. Valencia','C. SolÃ­s'],Central:['R. BiojÃ³','J. Soto','L. GÃ³mez Cuero'],Lateral:['J. Navarro','A. GutiÃ©rrez'],Medio:['J. GuivÃ­n','Ã. Ojeda','L. PÃ©rez','V. CedrÃ³n'],Extremo:['A. Mazzo'],Delantero:['A. RodrÃ­guez','H. Rengifo','N. Rengifo']},
    'gra':{Portero:['P. Ãlvarez','A. Fuentes'],Central:['R. Tapia','F. Cavagna','D. Franco'],Lateral:['J. BolÃ­var','E. Rodas'],Medio:['R. Guarderas','D. Barreto','H. Espinoza','E. Correa'],Extremo:['N. Delgadillo'],Delantero:['R. RuidÃ­az','I. Camargo']},
    'shu':{Portero:['Ã. Zamudio','D. Campos'],Central:['J. Barreda','M. Gaona','Y. Murillo'],Lateral:['H. Ãngeles','A. ChÃ¡vez'],Medio:['R. Salcedo','E. Villar','C. Huyhua'],Extremo:['P. Magallanes','J. Canela'],Delantero:['W. DÃ­az','R. Huaccha']},
    'sba':{Portero:['S. Rivadeneira'],Central:['G. Dulanto','A. Flores','R. Alfani'],Lateral:['M. Llontop','S. Aranda'],Medio:['E. Gonzales','F. Illanes','L. SolÃ­s'],Extremo:['J. AlarcÃ³n','J. Torres','L. Urruti'],Delantero:['L. Nequecaur','P. Liza']},
    'gar':{Portero:['P. Zubczuk','J. Barbieri'],Central:['A. GÃ³mez','H. Benincasa','J. Portales'],Lateral:['O. NÃºÃ±ez','E. Canales'],Medio:['C. TorrejÃ³n','I. Garrafa','A. Ascues'],Extremo:['K. Sandoval','B. da Silva','F. Arancibia'],Delantero:['A. Graneros','C. Olivares','J. Sinisterra']},
    'com':{Portero:['Ã. Villete','J. CharÃºn'],Central:['Y. VÃ­lchez','J. RodrÃ­guez','F. Alcedo'],Lateral:['C. VÃ¡squez','A. Cossio'],Medio:['C. Correa','M. Carpio','J. Herrera'],Extremo:['W. AyovÃ­','Ã“. Pinto'],Delantero:['M. Sen','M. Carranza']},
    'fcc':{Portero:['S. Aspajo','M. Sandi'],Central:['H. TimanÃ¡','M. AlmirÃ³n','B. Bernaola'],Lateral:['N. Loyola','R. Lagos'],Medio:['A. Moyano','K. Paico','P. Lavandeira'],Extremo:['F. Ocas','C. Meza','B. Palacios'],Delantero:['H. Barcos','S. Peralta']},
    'utc':{Portero:['Ã. Campos','R. Bettocchi'],Central:['M. Ganoza','P. Serra','B. Duarte'],Lateral:['J. Huerto','D. Caro'],Medio:['M. Lliuya','A. MuÃ±oz','D. Camacho'],Extremo:['L. Arce','J. NÃºÃ±ez'],Delantero:['M. de JesÃºs']},
    'jpi':{Portero:['I. Quispe','J. Stucchi'],Central:['B. PuÃ±o','S. LuzquiÃ±os','P. Fuentes'],Lateral:['F. Agurto','P. AntÃ³n'],Medio:['C. Flores','C. GarcÃ­a','D. Lozano','C. Cueva'],Extremo:['M. AlanÃ­z','A. Espinoza'],Delantero:['M. Juambeltz']},
    'cha':{Portero:['F. Saravia','H. Camacho'],Central:['G. Rizzo','M. Kaufman','C. Pimienta'],Lateral:['A. Quintana','B. Guevara'],Medio:['K. SÃ¡nchez','D. Dioses','J. Palomino'],Extremo:['J. Manzaneda','O. Takeuchi'],Delantero:['I. Camargo','P. Bueno']},
    'aal':{Portero:['E. Hermoza','D. Prieto'],Central:['A. Gordillo','E. Perleche','W. GuzmÃ¡n'],Lateral:['J. Mendieta','J. Aguirre'],Medio:['F. Urciuoli','H. LupÃº','C. VÃ¡squez'],Extremo:['J. Quintana'],Delantero:['P. GuzmÃ¡n']},
    'moq':{Portero:['C. Grados','R. Figueroa'],Central:['J. Amasifuen','C. Enciso','J. Granda'],Lateral:['E. Montenegro','A. Perleche'],Medio:['R. Chipao','C. RamÃ­rez','D. RamÃ­rez'],Extremo:['K. Ruiz','J. Vilela'],Delantero:['B. Angulo','J. Collazos','E. Lastre']},
    'gen':{Portero:['S. Rivadeneyra'],Central:['L. Abram','C. Ramos'],Lateral:['L. AdvÃ­ncula','M. Trauco'],Medio:['R. Tapia','W. Cartagena'],Extremo:['A. Carrillo'],Delantero:['G. Lapadula','L. Urruti']}
};

function getTeamByName(nombre) {
    return DATABASE_TEAMS.find(t => t.name === nombre) || {id:'gen', name:nombre, c1:'#3498db', c2:'#fff', power:70};
}

function generateStarting11(teamId) {
    let db = ROSTERS[teamId] || ROSTERS['gen'];
    let gk = db.Portero?.[0] || 'Arquero';
    let field = [];
    for (let cat of ['Delantero','Extremo','Medio','Lateral','Central']) if(db[cat]) field = field.concat(db[cat]);
    field = [...new Set(field)].slice(0,10);
    while (field.length < 10) field.push('Juvenil '+Math.floor(Math.random()*99));
    return {gk, field};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO â€” IDÃ‰NTICO AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GOAL_Y_START=175, GOAL_HEIGHT=150, GOAL_Y_END=GOAL_Y_START+GOAL_HEIGHT;
const MATCH_DURATION=90;

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const timeEl=document.getElementById('timeEl');
const coinsEl={innerText:''};

let state={golesAzul:0, golesRojo:0, tiempo:MATCH_DURATION, partidoActivo:false, pausado:false};

// Datos del partido actual
let currentMatchState={
    myTeamIsHome:true,
    homeData:null,  // equipo azul (local)
    awayData:null,  // equipo rojo (visitante)
    actualHomeColor:'#3498db',
    actualAwayColor:'#e74c3c'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMACIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const formacionesDB={
    "4-4-2":[{x:130,y:100,rol:'Lateral'},{x:110,y:200,rol:'Central'},{x:110,y:300,rol:'Central'},{x:130,y:400,rol:'Lateral'},{x:250,y:100,rol:'Medio'},{x:220,y:200,rol:'Medio'},{x:220,y:300,rol:'Medio'},{x:250,y:400,rol:'Medio'},{x:350,y:180,rol:'Delantero'},{x:350,y:320,rol:'Delantero'}]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SONIDO â€” IGUAL AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AudioCtx=window.AudioContext||window.webkitAudioContext;
const audioCtx=new AudioCtx();
let soundEnabled=true;
function activarSonido(){if(audioCtx.state==='suspended')audioCtx.resume();}
function playKick(){if(!soundEnabled)return;try{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='triangle';o.frequency.setValueAtTime(150,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);g.gain.setValueAtTime(.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);o.start();o.stop(audioCtx.currentTime+.1);}catch(e){}}
function playWhistle(){if(!soundEnabled)return;try{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='square';o.frequency.setValueAtTime(2000,audioCtx.currentTime);g.gain.setValueAtTime(.05,audioCtx.currentTime);g.gain.setValueAtTime(.05,audioCtx.currentTime+.1);g.gain.setValueAtTime(0,audioCtx.currentTime+.15);g.gain.setValueAtTime(.05,audioCtx.currentTime+.2);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.5);o.start();o.stop(audioCtx.currentTime+.5);}catch(e){}}
function playGoal(){if(!soundEnabled)return;try{const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*2,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=buf;const f=audioCtx.createBiquadFilter();f.type='bandpass';f.frequency.value=800;const g=audioCtx.createGain();n.connect(f);f.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(0,audioCtx.currentTime);g.gain.linearRampToValueAtTime(.4,audioCtx.currentTime+.2);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+2);n.start();}catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASE BALL â€” IDÃ‰NTICA AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Ball{
    constructor(){this.reset();this.radius=6;this.color='#fff';this.friction=0.98;}
    reset(){this.x=canvas.width/2;this.y=canvas.height/2;this.vx=0;this.vy=0;this.lastTouch=null;this.assistTouch=null;}
    update(){
        this.x+=this.vx;this.y+=this.vy;this.vx*=this.friction;this.vy*=this.friction;
        if(this.y-this.radius<0){this.y=this.radius;this.vy*=-1;}
        else if(this.y+this.radius>canvas.height){this.y=canvas.height-this.radius;this.vy*=-1;}
        if(this.x-this.radius<0){
            if(this.y>GOAL_Y_START&&this.y<GOAL_Y_END) window.anotarGol('rojo',this.lastTouch,this.assistTouch);
            else{this.x=this.radius;this.vx*=-1;}
        }
        if(this.x+this.radius>canvas.width){
            if(this.y>GOAL_Y_START&&this.y<GOAL_Y_END) window.anotarGol('azul',this.lastTouch,this.assistTouch);
            else{this.x=canvas.width-this.radius;this.vx*=-1;}
        }
    }
    draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.stroke();ctx.closePath();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASE PLAYER â€” IDÃ‰NTICA AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Player{
    constructor(bx,by,color,team,rolBase,numero){
        this.baseX=bx;this.baseY=by;this.x=bx;this.y=by;
        this.color=color;this.team=team;this.rolBase=rolBase;this.numero=numero;
        this.type='Novato';this.subType='Basico';this.cooldown=0;
        this.playerName=null;this.wallPassActive=0;this.resetStats();
    }
    resetStats(){this.radius=9;this.speed=2.5;this.kickPower=5;this.rangoTiro=250;this.precisionPase=0.5;this.saveSkill=0.2;this.wallPassActive=0;}
    reset(){this.x=this.baseX;this.y=this.baseY;this.cooldown=0;this.wallPassActive=0;}
    aplicarEspecialidad(t,s){
        this.type=t;this.subType=s;
        switch(s){
            case 'Ofensivo':this.radius=11;this.speed=2.5;this.kickPower=6;this.saveSkill=0.4;this.precisionPase=0.8;break;
            case 'Defensivo':this.radius=15;this.speed=3.5;this.kickPower=8;this.saveSkill=0.9;this.precisionPase=0.2;break;
            case 'Central':this.radius=13;this.speed=1.6;this.kickPower=7;this.rangoTiro=0;break;
            case 'Lateral Ofensivo':this.radius=9;this.speed=3.5;this.kickPower=6;this.precisionPase=0.8;break;
            case 'Lateral Defensivo':this.radius=9;this.speed=3.2;this.kickPower=4;this.precisionPase=0.3;break;
            case 'MCD':this.radius=11;this.speed=2.5;this.kickPower=5;this.precisionPase=0.5;break;
            case 'Mediapunta':this.radius=9;this.speed=2.8;this.kickPower=6;this.precisionPase=1.0;break;
            case 'Box to Box':this.radius=10;this.speed=3.2;this.kickPower=7;this.precisionPase=0.6;this.rangoTiro=300;break;
            case 'Extremo':this.radius=8;this.speed=4.0;this.kickPower=5;this.precisionPase=0.8;break;
            case 'Centrodelantero':this.radius=13;this.speed=1.6;this.kickPower=9;this.rangoTiro=180;break;
            case 'Segundo Delantero':this.radius=9;this.speed=3.2;this.kickPower=6;this.rangoTiro=350;break;
        }
    }
    update(ballObj,allPlayers){
        if(this.cooldown>0)this.cooldown--;
        if(state.pausado)return;
        const myTeam=allPlayers.filter(p=>p.team===this.team);
        const attackDir=this.team==='azul'?1:-1;
        const enemyGoalX=this.team==='azul'?canvas.width:0;
        const enemyGoalY=GOAL_Y_START+GOAL_HEIGHT/2;
        let targetX=this.baseX,targetY=this.baseY,spd=this.speed;
        if(this.rolBase==='Portero'){
            targetX=this.baseX;
            let err=Math.random()>this.saveSkill?(Math.random()-.5)*60:0;
            targetY=Math.max(GOAL_Y_START,Math.min(GOAL_Y_END,ballObj.y+err));
        } else {
            let cl=myTeam.reduce((c,p)=>p.rolBase==='Portero'?c:Math.hypot(p.x-ballObj.x,p.y-ballObj.y)<Math.hypot(c.x-ballObj.x,c.y-ballObj.y)?p:c,myTeam[1]||myTeam[0]);
            const bOff=(ballObj.x-canvas.width/2)*0.4;
            const atk=(this.team==='azul'&&ballObj.x>canvas.width/2)||(this.team==='rojo'&&ballObj.x<canvas.width/2);
            if(this.wallPassActive>0)this.wallPassActive--;
            if(this===cl){targetX=ballObj.x;targetY=ballObj.y;}
            else if(this.subType==='Central'){targetX=this.baseX+bOff*.1;}
            else if(this.subType==='Lateral Ofensivo'){targetX=atk?enemyGoalX-attackDir*150:this.baseX+bOff*.8;spd=atk?spd*1.4:spd*.8;}
            else if(this.subType==='Lateral Defensivo'){targetX=this.baseX+bOff*.15;targetY=this.baseY+(ballObj.y-this.baseY)*.3;spd*=1.28;}
            else if(this.subType==='MCD'){targetX=this.baseX+bOff*.15;let dB=Math.hypot(ballObj.x-this.x,ballObj.y-this.y),dCB=Math.hypot(cl.x-ballObj.x,cl.y-ballObj.y);if(!atk){if(dCB<25){targetX=this.baseX;targetY=this.baseY+(ballObj.y-this.baseY)*.2;}else if(dB<200){targetX=ballObj.x;targetY=ballObj.y;spd*=1.4;}else targetY=this.baseY+(ballObj.y-this.baseY)*.5;}else targetY=this.baseY+(ballObj.y-this.baseY)*.3;}
            else if(this.subType==='Mediapunta'){targetX=this.baseX+bOff*.6;targetY=this.baseY+(ballObj.y-this.baseY)*.5;}
            else if(this.subType==='Box to Box'){targetX=atk?enemyGoalX-attackDir*200:this.baseX;targetY=this.baseY+(ballObj.y-this.baseY)*.4;}
            else if(this.subType==='Extremo'){targetX=atk?enemyGoalX-attackDir*90:this.baseX+bOff*.9;spd=atk?spd*1.6:spd*1.4;targetY=myTeam.filter(p=>p.subType==='Extremo').indexOf(this)===0?50:canvas.height-50;}
            else if(this.subType==='Centrodelantero'){targetX=enemyGoalX-attackDir*80;if(atk){let bY=this.y,mS=-Infinity;const en=allPlayers.filter(p=>p.team!==this.team);for(let tY=120;tY<=canvas.height-120;tY+=30){let sc=Math.min(...en.map(e=>Math.hypot(e.x-targetX,e.y-tY)))-Math.abs(canvas.height/2-tY)*.5;if(sc>mS){mS=sc;bY=tY;}}targetY=bY;}else targetY=Math.max(80,Math.min(canvas.height-80,ballObj.y+(this.baseY<canvas.height/2?-60:60)));}
            else if(this.subType==='Segundo Delantero'){targetX=enemyGoalX-attackDir*180;if(atk){let bY=this.y,mS=-Infinity;const en=allPlayers.filter(p=>p.team!==this.team),ot=myTeam.filter(p=>p!==this&&p.subType==='Segundo Delantero');for(let tY=100;tY<=canvas.height-100;tY+=40){let sc=Math.min(...en.map(e=>Math.hypot(e.x-targetX,e.y-tY)));ot.forEach(o=>{if(Math.abs(o.y-tY)<80)sc-=100;});if(sc>mS){mS=sc;bY=tY;}}targetY=bY;}else targetY=this.baseY+(ballObj.y-this.baseY)*.3;}
            else{targetX=this.baseX+bOff;targetY=this.baseY+(ballObj.y-this.baseY)*.3;}
        }
        const dx=targetX-this.x,dy=targetY-this.y,dist=Math.hypot(dx,dy);
        if(dist>2){this.x+=dx/dist*spd;this.y+=dy/dist*spd;}
        const dBall=Math.hypot(ballObj.x-this.x,ballObj.y-this.y);
        if(dBall<this.radius+ballObj.radius&&this.cooldown===0){
            playKick();
            if(ballObj.lastTouch!==this){if(ballObj.lastTouch&&ballObj.lastTouch.team===this.team)ballObj.assistTouch=ballObj.lastTouch;else ballObj.assistTouch=null;ballObj.lastTouch=this;}
            const dGoal=Math.hypot(enemyGoalX-this.x,enemyGoalY-this.y);
            const shotClear=()=>{let a=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x);return !allPlayers.some(e=>e.team!==this.team&&e.rolBase!=='Portero'&&Math.abs(Math.atan2(e.y-this.y,e.x-this.x)-a)<.25&&Math.hypot(e.x-this.x,e.y-this.y)<dGoal);};
            const passSafe=t=>{let a=Math.atan2(t.y-this.y,t.x-this.x),d=Math.hypot(t.x-this.x,t.y-this.y);return !allPlayers.some(e=>e.team!==this.team&&Math.abs(Math.atan2(e.y-this.y,e.x-this.x)-a)<.3&&Math.hypot(e.x-this.x,e.y-this.y)<d);};
            let canShoot=dGoal<=this.rangoTiro;
            if(this.subType==='Centrodelantero'&&!canShoot&&shotClear()&&dGoal<=320)canShoot=true;
            if(this.subType==='Box to Box'&&dGoal<=300&&shotClear())canShoot=true;
            if(canShoot&&this.rolBase!=='Portero'&&this.subType!=='Central'){
                let ang=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x)+(Math.random()-.5)*.4;
                ballObj.vx=Math.cos(ang)*this.kickPower*1.5;ballObj.vy=Math.sin(ang)*this.kickPower*1.5;this.cooldown=15;
            } else {
                const sfwd=allPlayers.filter(p=>p.team===this.team&&p!==this&&passSafe(p)&&(this.team==='azul'?p.x>this.x:p.x<this.x));
                const sbk=allPlayers.filter(p=>p.team===this.team&&p!==this&&passSafe(p)&&(this.team==='azul'?p.x<=this.x:p.x>=this.x));
                let tgt=null;
                if(this.subType==='Mediapunta'){let fw=sfwd.filter(p=>p.rolBase==='Delantero');if(fw.length)tgt=fw[Math.floor(Math.random()*fw.length)];else{let a=Math.atan2(enemyGoalY-this.y,enemyGoalX-this.x);ballObj.vx=Math.cos(a)*this.speed*1.3;ballObj.vy=Math.sin(a)*this.speed*1.3;this.cooldown=10;return;}}
                else if(this.subType==='MCD'){if(sfwd.length>0&&Math.random()>.2)tgt=sfwd[Math.floor(Math.random()*sfwd.length)];else if(sbk.length){let d=sbk.filter(p=>p.rolBase!=='Portero');tgt=d.length?d[Math.floor(Math.random()*d.length)]:sbk[0];}}
                else if(this.subType==='Extremo'||this.subType==='Lateral Ofensivo'){if(Math.abs(enemyGoalX-this.x)>160){let a=Math.atan2((this.y<canvas.height/2?40:canvas.height-40)-this.y,enemyGoalX-this.x);ballObj.vx=Math.cos(a)*this.speed*1.6;ballObj.vy=Math.sin(a)*this.speed*1.6;this.cooldown=8;return;}let fw=sfwd.filter(p=>p.subType==='Centrodelantero'||p.rolBase==='Delantero');if(fw.length)tgt=fw.reduce((c,p)=>(this.team==='azul'?p.x>c.x:p.x<c.x)?p:c,fw[0]);else if(sfwd.length)tgt=sfwd[0];}
                else if(this.subType==='Box to Box'){if(sfwd.length)tgt=sfwd[Math.floor(Math.random()*sfwd.length)];else if(sbk.length)tgt=sbk[0];}
                else{if(sfwd.length)tgt=sfwd[0];else if(this.subType==='Centrodelantero'&&sbk.length)tgt=sbk[0];}
                if(tgt){let err=(1-this.precisionPase)*(Math.random()-.5)*1.5,a=Math.atan2(tgt.y-this.y,tgt.x-this.x);ballObj.vx=Math.cos(a+err)*this.kickPower*1.2;ballObj.vy=Math.sin(a+err)*this.kickPower*1.2;}
                else{ballObj.vx=attackDir*this.kickPower;ballObj.vy=(Math.random()-.5)*2;}
                this.cooldown=15;
            }
        }
        allPlayers.forEach(o=>{if(o!==this){let d=Math.hypot(this.x-o.x,this.y-o.y),m=this.radius+o.radius;if(d<m&&d>0){this.x+=(this.x-o.x)/d*(m-d)*.1;this.y+=(this.y-o.y)/d*(m-d)*.1;}}});
        this.x=Math.max(this.radius,Math.min(canvas.width-this.radius,this.x));
        this.y=Math.max(this.radius,Math.min(canvas.height-this.radius,this.y));
    }
    draw(){
        ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();
        ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.stroke();
        ctx.beginPath();ctx.arc(this.x,this.y,this.radius/3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fill();ctx.closePath();
        ctx.fillStyle='#fff';ctx.font='bold 10px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(this.numero,this.x,this.y);
        if(this.playerName){ctx.font='bold 9px Arial';ctx.fillText(this.playerName.split(' ').pop(),this.x,this.y-this.radius-8);}
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTANCIAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ball=new Ball();
const players=[];
players.push(new Player(30,250,'#3498db','azul','Portero',1));
let nA=2;formacionesDB["4-4-2"].forEach(p=>players.push(new Player(p.x,p.y,'#3498db','azul',p.rol,nA++)));
players.push(new Player(770,250,'#e74c3c','rojo','Portero',1));
let nR=2;
[{x:670,y:100,rol:'Lateral'},{x:690,y:200,rol:'Central'},{x:690,y:300,rol:'Central'},{x:670,y:400,rol:'Lateral'},
 {x:550,y:100,rol:'Medio'},{x:580,y:200,rol:'Medio'},{x:580,y:300,rol:'Medio'},{x:550,y:400,rol:'Medio'},
 {x:450,y:180,rol:'Delantero'},{x:450,y:320,rol:'Delantero'}
].forEach(p=>players.push(new Player(p.x,p.y,'#e74c3c','rojo',p.rol,nR++)));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURAR PARTIDO â€” asigna nombres reales a los jugadores
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function configurarEquipos(homeTeam, awayTeam) {
    currentMatchState.homeData = homeTeam;
    currentMatchState.awayData = awayTeam;
    currentMatchState.actualHomeColor = homeTeam.c1;
    currentMatchState.actualAwayColor = awayTeam.c1;

    // Aplicar colores
    players.forEach(p=>{
        if(p.team==='azul') p.color=homeTeam.c1;
        if(p.team==='rojo') p.color=awayTeam.c1;
    });

    // Asignar especialidades y NOMBRES REALES â€” igual que mejorarEquipoRival del offline
    const rolesSubtipos=['Lateral Ofensivo','Central','Central','Lateral Defensivo','MCD','Box to Box','MCD','Extremo','Centrodelantero','Segundo Delantero'];
    const homePoder=homeTeam.power||70, awayPoder=awayTeam.power||70;

    // AZUL (local)
    const homeS11=generateStarting11(homeTeam.id);
    const azulField=players.filter(p=>p.team==='azul'&&p.rolBase!=='Portero');
    const azulGK=players.find(p=>p.team==='azul'&&p.rolBase==='Portero');
    azulField.forEach((p,i)=>{
        const sub=rolesSubtipos[i]||'Basico';
        p.aplicarEspecialidad(p.rolBase,sub);
        p.speed*=(homePoder/70);p.kickPower*=(homePoder/70);
        p.playerName=homeS11.field[i]||'Jugador';
    });
    if(azulGK){azulGK.aplicarEspecialidad('Portero','Defensivo');azulGK.playerName=homeS11.gk;}

    // ROJO (visitante)
    const awayS11=generateStarting11(awayTeam.id);
    const rojoField=players.filter(p=>p.team==='rojo'&&p.rolBase!=='Portero');
    const rojoGK=players.find(p=>p.team==='rojo'&&p.rolBase==='Portero');
    rojoField.forEach((p,i)=>{
        const sub=rolesSubtipos[i]||'Basico';
        p.aplicarEspecialidad(p.rolBase,sub);
        p.speed*=(awayPoder/70);p.kickPower*=(awayPoder/70);
        p.playerName=awayS11.field[i]||'Jugador';
    });
    if(rojoGK){rojoGK.aplicarEspecialidad('Portero','Defensivo');rojoGK.playerName=awayS11.gk;}

    // Score UI
    document.getElementById('scoreAzul').innerText=`${homeTeam.name.substring(0,12)}: 0`;
    document.getElementById('scoreAzul').style.color=homeTeam.c1;
    document.getElementById('scoreRojo').innerText=`${awayTeam.name.substring(0,12)}: 0`;
    document.getElementById('scoreRojo').style.color=awayTeam.c1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANOTAR GOL â€” IDÃ‰NTICO AL OFFLINE + sube a Supabase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.anotarGol=function(equipo, scorerP, assistP){
    if(!state.partidoActivo||state.tiempo<=0)return;
    if(equipo==='azul'&&scorerP&&scorerP.team!=='azul')return;
    if(equipo==='rojo'&&scorerP&&scorerP.team!=='rojo')return;
    playGoal();playWhistle();
    const sName=scorerP?.playerName?scorerP.playerName.split(' ').pop():null;
    const tMin=Math.floor(((MATCH_DURATION-state.tiempo)/MATCH_DURATION)*90)+1;
    const ev=`<div style="margin-top:2px;">âš½ ${tMin}' ${sName||'Jugador'}</div>`;
    if(equipo==='azul'){
        state.golesAzul++;
        document.getElementById('scoreAzul').innerText=`${currentMatchState.homeData?.name.substring(0,12)||'Local'}: ${state.golesAzul}`;
        document.getElementById('home-scorers').innerHTML+=ev;
        mostrarAnimacionGol(sName,currentMatchState.actualHomeColor);
    } else {
        state.golesRojo++;
        document.getElementById('scoreRojo').innerText=`${currentMatchState.awayData?.name.substring(0,12)||'Visita'}: ${state.golesRojo}`;
        document.getElementById('away-scorers').innerHTML+=ev;
        mostrarAnimacionGol(sName,currentMatchState.actualAwayColor);
    }
    ball.reset();players.forEach(p=>p.reset());
    // Notificar a Supabase (si funciÃ³n disponible)
    if(window._onGol) window._onGol(equipo, sName, tMin);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER â€” IDÃ‰NTICO AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(()=>{
    if(state.partidoActivo&&state.tiempo>0&&!state.pausado){
        state.tiempo--;
        const minMostrar=Math.floor(((MATCH_DURATION-state.tiempo)/MATCH_DURATION)*90);
        timeEl.innerText=minMostrar+"'";
        if(state.tiempo<=0){
            state.partidoActivo=false;
            ball.vx=0;ball.vy=0;
            playWhistle();
            setTimeout(()=>{ if(window._onFinPartido) window._onFinPartido(); },800);
        }
    }
},1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€” IGUAL AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawPitch(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#27ae60';ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='rgba(255,255,255,.7)';ctx.lineWidth=3;ctx.strokeRect(0,0,canvas.width,canvas.height);
    ctx.beginPath();ctx.moveTo(canvas.width/2,0);ctx.lineTo(canvas.width/2,canvas.height);ctx.stroke();
    ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,60,0,Math.PI*2);ctx.stroke();
    ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(0,GOAL_Y_START);ctx.lineTo(0,GOAL_Y_END);ctx.strokeStyle=currentMatchState.actualHomeColor;ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=2;ctx.strokeRect(0,GOAL_Y_START-50,100,GOAL_HEIGHT+100);
    ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(canvas.width,GOAL_Y_START);ctx.lineTo(canvas.width,GOAL_Y_END);ctx.strokeStyle=currentMatchState.actualAwayColor;ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=2;ctx.strokeRect(canvas.width-100,GOAL_Y_START-50,100,GOAL_HEIGHT+100);
}

function gameLoop(){
    drawPitch();
    if(state.partidoActivo&&!state.pausado){ball.update();players.forEach(p=>p.update(ball,players));}
    players.forEach(p=>p.draw());
    ball.draw();
    requestAnimationFrame(gameLoop);
}
gameLoop();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMACIÃ“N GOL â€” IGUAL AL OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarAnimacionGol(nombre,color){
    const overlay=document.getElementById('goal-overlay');
    const txt=document.getElementById('goal-text');
    const stxt=document.getElementById('goal-scorer-text');
    overlay.querySelectorAll('.confetti-piece').forEach(c=>c.remove());
    overlay.style.display='block';
    txt.style.color=color||'#f1c40f';
    txt.style.transform='translate(-50%,-50%) scale(1)';
    stxt.style.opacity='1';
    stxt.innerText=nombre?`âš½ ${nombre}`:'âš½ GOL';
    const cols=['#f1c40f','#e74c3c','#3498db','#2ecc71','#9b59b6','#fff'];
    for(let i=0;i<30;i++){const c=document.createElement('div');c.className='confetti-piece';c.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*30}%;background:${cols[Math.floor(Math.random()*cols.length)]};width:${Math.random()*12+6}px;height:${Math.random()*12+6}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-delay:${Math.random()*.5}s;animation-duration:${Math.random()+1}s;`;overlay.appendChild(c);}
    state.pausado=true;
    setTimeout(()=>{txt.style.transform='translate(-50%,-50%) scale(0)';stxt.style.opacity='0';setTimeout(()=>overlay.style.display='none',400);},2200);
    setTimeout(()=>{state.pausado=false;},2000);
}
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MÃ“DULO SUPABASE â€” conecta el motor al online
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
import{createClient}from'https://esm.sh/@supabase/supabase-js@2';
const db=createClient('https://hpvpxadhbftiulwmysaw.supabase.co','sb_publishable_Inip39JWInROxtuAaTL9rQ_f24sZcFa');

let miEquipo=null, jornadaActiva=null, partidoActual=null, todosLosPartidos=[];
let modoVista='wait', replayEventos=[];

async function init(){
    const{data:{session}}=await db.auth.getSession();
    if(!session){window.location.href='login.html';return;}
    const{data:eq}=await db.from('equipos').select('*').eq('user_id',session.user.id).single();
    miEquipo=eq;
    await cargarEstado();
    iniciarCountdown();
}

async function cargarEstado(){
    const{data:cfg}=await db.from('config_liga').select('*').eq('id',1).single();
    jornadaActiva=cfg;
    if(!cfg||cfg.jornada_activa===0){mostrarWaiting();return;}
    const{data:ps}=await db.from('jornadas').select('*').eq('temporada','2025').eq('numero_jornada',cfg.jornada_activa).order('id');
    todosLosPartidos=ps||[];
    if(miEquipo){
        const nb=miEquipo.equipo_base||miEquipo.nombre;
        partidoActual=todosLosPartidos.find(p=>p.equipo_local===nb||p.equipo_visitante===nb);
    }
    renderMatchesList();
    if(cfg.estado==='en_vivo') iniciarPartido();
    else if(cfg.estado==='finalizado') await mostrarFin();
    else { mostrarWaiting(); if(partidoActual) mostrarInfoMiPartido(); }
    suscribirRealtime();
}

function iniciarPartido(){
    if(!partidoActual){mostrarWaiting('Tu equipo no juega en esta jornada');return;}
    modoVista='live';

    // Obtener datos de los equipos con jugadores reales
    const homeTeam=getTeamByName(partidoActual.equipo_local);
    const awayTeam=getTeamByName(partidoActual.equipo_visitante);

    // Configurar motor (asigna especialidades + nombres reales)
    configurarEquipos(homeTeam, awayTeam);

    document.getElementById('mode-badge').className='mode-badge badge-live';
    document.getElementById('mode-badge').innerText='â— EN VIVO';
    mostrarCanvas();

    // Iniciar motor
    state.golesAzul=0;state.golesRojo=0;state.tiempo=MATCH_DURATION;
    state.partidoActivo=true;state.pausado=false;
    ball.reset();players.forEach(p=>p.reset());
    document.getElementById('home-scorers').innerHTML='';
    document.getElementById('away-scorers').innerHTML='';
    timeEl.innerText="0'";
    activarSonido();

    // Hook: cuando el motor marca gol â†’ sube a Supabase
    window._onGol=async(equipo, jugador, minuto)=>{
        if(!partidoActual)return;
        await db.from('jornadas').update({
            goles_local:state.golesAzul,
            goles_visitante:state.golesRojo,
            estado:'en_curso'
        }).eq('id',partidoActual.id);
        await db.from('eventos_partido').insert({
            partido_id:partidoActual.id,
            minuto, tipo:'gol',
            equipo:equipo==='azul'?homeTeam.name:awayTeam.name,
            jugador:jugador||'Jugador',
            es_local:equipo==='azul',
            temporada:'2025'
        });
    };

    // Hook: cuando termina el partido
    window._onFinPartido=async()=>{
        if(!partidoActual)return;
        await db.from('jornadas').update({
            goles_local:state.golesAzul,
            goles_visitante:state.golesRojo,
            estado:'finalizado'
        }).eq('id',partidoActual.id);
        setTimeout(()=>mostrarFin(),1500);
    };
}

async function mostrarFin(){
    modoVista='fin';state.partidoActivo=false;
    window._onGol=null;window._onFinPartido=null;
    if(!partidoActual){mostrarWaiting('Jornada finalizada.');return;}
    const{data:p}=await db.from('jornadas').select('*').eq('id',partidoActual.id).single();
    if(p)partidoActual=p;
    const homeTeam=getTeamByName(partidoActual.equipo_local);
    const awayTeam=getTeamByName(partidoActual.equipo_visitante);
    const gl=partidoActual.goles_local??state.golesAzul;
    const gv=partidoActual.goles_visitante??state.golesRojo;
    document.getElementById('canvas-wrap').style.display='none';
    document.getElementById('ui-panel').style.display='none';
    document.getElementById('live-events').style.display='none';
    document.getElementById('waiting-panel').style.display='none';
    document.getElementById('fin-panel').style.display='block';
    document.getElementById('fin-equipos').innerText=`${partidoActual.equipo_local} vs ${partidoActual.equipo_visitante}`;
    document.getElementById('fin-score').innerText=`${gl} â€” ${gv}`;
    const{data:evts}=await db.from('eventos_partido').select('*').eq('partido_id',partidoActual.id).order('minuto');
    replayEventos=evts||[];
    const goles=replayEventos.filter(e=>e.tipo==='gol');
    if(goles.length) document.getElementById('fin-goles').innerHTML=goles.map(g=>`<span style="color:${g.es_local?homeTeam.c1:awayTeam.c1}">âš½ ${g.minuto}' ${g.jugador||''}</span>`).join(' Â· ');
    renderMatchesList();
}

// REPLAY â€” reproduce los goles en sus minutos exactos sobre el motor corriendo
window.iniciarReplay=function(){
    if(!replayEventos.length){alert('No hay eventos para replay');return;}
    const homeTeam=getTeamByName(partidoActual.equipo_local);
    const awayTeam=getTeamByName(partidoActual.equipo_visitante);
    modoVista='replay';
    document.getElementById('fin-panel').style.display='none';
    mostrarCanvas();
    document.getElementById('mode-badge').className='mode-badge badge-replay';
    document.getElementById('mode-badge').innerText='ğŸ¬ REPLAY';
    document.getElementById('home-scorers').innerHTML='';
    document.getElementById('away-scorers').innerHTML='';
    // Configurar equipos de nuevo
    configurarEquipos(homeTeam, awayTeam);
    state.golesAzul=0;state.golesRojo=0;state.tiempo=MATCH_DURATION;
    state.partidoActivo=true;state.pausado=false;
    ball.reset();players.forEach(p=>p.reset());
    timeEl.innerText="0'";
    // Deshabilitar hooks de Supabase
    window._onGol=null;window._onFinPartido=null;
    // Programar goles en sus minutos exactos
    replayEventos.filter(e=>e.tipo==='gol').forEach(ev=>{
        const segundos=Math.floor((ev.minuto/90)*90);
        setTimeout(()=>{
            const eq=ev.es_local?'azul':'rojo';
            const scorerFake={team:eq,playerName:ev.jugador||'Jugador',rolBase:'Delantero'};
            window.anotarGol(eq,scorerFake,null);
        },segundos*1000+200);
    });
};

function suscribirRealtime(){
    db.channel('config-live')
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'config_liga'},payload=>{
            jornadaActiva=payload.new;
            if(payload.new.estado==='en_vivo'&&modoVista==='wait') cargarEstado();
            else if(payload.new.estado==='finalizado'&&modoVista==='live'){
                modoVista='fin';setTimeout(()=>mostrarFin(),2000);
            }
        }).subscribe();
}

function mostrarCanvas(){
    document.getElementById('waiting-panel').style.display='none';
    document.getElementById('fin-panel').style.display='none';
    document.getElementById('canvas-wrap').style.display='block';
    document.getElementById('ui-panel').style.display='flex';
    document.getElementById('live-events').style.display='flex';
}

function mostrarWaiting(msg=null){
    document.getElementById('canvas-wrap').style.display='none';
    document.getElementById('ui-panel').style.display='none';
    document.getElementById('live-events').style.display='none';
    document.getElementById('fin-panel').style.display='none';
    document.getElementById('waiting-panel').style.display='block';
    if(msg)document.querySelector('.wait-desc').innerText=msg;
}

function mostrarInfoMiPartido(){
    if(!partidoActual||!jornadaActiva)return;
    document.getElementById('mi-partido-info').style.display='block';
    document.getElementById('mi-partido-teams').innerText=`${partidoActual.equipo_local} vs ${partidoActual.equipo_visitante}`;
    document.getElementById('mi-partido-jornada').innerText=`Jornada ${jornadaActiva.jornada_activa}`;
}

function renderMatchesList(){
    const container=document.getElementById('matches-list');
    if(!todosLosPartidos.length){container.innerHTML='';return;}
    const nb=miEquipo?(miEquipo.equipo_base||miEquipo.nombre):null;
    container.innerHTML=todosLosPartidos.map(p=>{
        const esMio=nb&&(p.equipo_local===nb||p.equipo_visitante===nb);
        const fin=p.estado==='finalizado',vivo=p.estado==='en_curso';
        const score=fin?`<span class="ms">${p.goles_local??0} â€” ${p.goles_visitante??0}</span>`:`<span class="ms-pending">${vivo?'EN VIVO':'VS'}</span>`;
        return `<div class="match-item ${esMio?'mi-partido':''} ${fin?'finalizado':''} ${vivo?'en-vivo':''}">
            <span class="mt home ${esMio&&p.equipo_local===nb?'mi-equipo':''}">${p.equipo_local}</span>
            ${score}
            <span class="mt ${esMio&&p.equipo_visitante===nb?'mi-equipo':''}">${p.equipo_visitante}</span>
        </div>`;
    }).join('');
}

function iniciarCountdown(){
    function tick(){
        if(modoVista!=='wait')return;
        const now=new Date(),target=new Date();target.setHours(19,0,0,0);
        let diff=target-now;if(diff<0)diff+=86400000;
        const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
        document.getElementById('countdown').innerText=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick();setInterval(tick,1000);
}

init();
</script>
</body>
</html>
