<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga 1 â€” En Vivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--gold:#f1c40f;--dark:#0f0f0f;--mid:#1e2530;--green:#27ae60;}
        *{box-sizing:border-box;margin:0;padding:0;}
        body{background:var(--dark);color:white;font-family:'Rajdhani',sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:10px 16px;}

        /* TOP */
        .top-bar{width:100%;max-width:900px;display:flex;justify-content:space-between;align-items:center;padding:10px 0 14px;}
        .top-logo{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;background:linear-gradient(135deg,#f1c40f,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .top-nav a{color:rgba(255,255,255,.35);text-decoration:none;font-size:13px;font-weight:600;margin-left:16px;}
        .top-nav a:hover{color:#f1c40f;}

        /* LAYOUT PRINCIPAL */
        .main{width:100%;max-width:900px;display:grid;grid-template-columns:1fr 280px;gap:14px;}
        @media(max-width:700px){.main{grid-template-columns:1fr;}}

        /* PANEL PARTIDO ACTIVO */
        .partido-panel{display:flex;flex-direction:column;gap:10px;}

        /* SCORE HEADER */
        .score-header{background:var(--mid);border-radius:14px;padding:16px 20px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;border:1px solid rgba(255,255,255,.06);}
        .team-name{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;line-height:1.2;}
        .team-name.home{text-align:right;}
        .team-score{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;text-align:center;padding:0 10px;}
        .time-badge{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;background:rgba(0,0,0,.4);border-radius:6px;padding:3px 10px;text-align:center;margin-top:4px;}
        .badge-live{color:#2ecc71;animation:pulse .8s infinite alternate;}
        .badge-wait{color:#f1c40f;}
        .badge-fin{color:rgba(255,255,255,.4);}
        @keyframes pulse{from{opacity:.6;}to{opacity:1;}}
        .center-col{display:flex;flex-direction:column;align-items:center;}

        /* CANVAS DECORATIVO */
        .canvas-wrap{position:relative;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,.08);}
        canvas{display:block;width:100%;}

        /* GOAL OVERLAY */
        #goal-overlay{display:none;position:absolute;inset:0;z-index:10;pointer-events:none;
            background:radial-gradient(ellipse at center,rgba(241,196,15,.25) 0%,rgba(0,0,0,.75) 100%);}
        #goal-text{position:absolute;top:42%;left:50%;transform:translate(-50%,-50%) scale(0);
            font-family:'Bebas Neue',sans-serif;font-size:90px;color:#f1c40f;
            text-shadow:0 0 50px rgba(241,196,15,1),3px 3px 0 #000;white-space:nowrap;
            transition:transform .3s cubic-bezier(.34,1.56,.64,1);}
        #goal-scorer{position:absolute;top:58%;left:50%;transform:translateX(-50%);
            font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;
            text-shadow:2px 2px 0 #000;letter-spacing:3px;opacity:0;transition:opacity .3s ease .25s;}
        .confetti{position:absolute;opacity:0;animation:confettiFall 1.4s ease-out forwards;}
        @keyframes confettiFall{0%{opacity:1;transform:translateY(-10px) rotate(0);}100%{opacity:0;transform:translateY(300px) rotate(720deg);}}

        /* FEED GOL */
        .feed-box{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px 14px;min-height:80px;}
        .feed-title{font-size:11px;letter-spacing:2px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-bottom:8px;}
        .feed-item{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:14px;}
        .feed-item:last-child{border-bottom:none;}
        .feed-min{font-family:'Bebas Neue',sans-serif;font-size:13px;color:#f1c40f;min-width:30px;}
        .feed-jugador{font-weight:600;}
        .feed-equipo{font-size:12px;color:rgba(255,255,255,.35);}
        .feed-empty{color:rgba(255,255,255,.2);font-size:13px;text-align:center;padding:12px 0;}

        /* WAITING */
        #waiting-panel{text-align:center;padding:40px 20px;}
        .wait-icon{font-size:56px;margin-bottom:12px;animation:float 3s ease-in-out infinite;}
        @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
        .wait-title{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:4px;color:#f1c40f;margin-bottom:6px;}
        .wait-sub{color:rgba(255,255,255,.3);font-size:14px;margin-bottom:20px;}
        #countdown{font-family:'Bebas Neue',sans-serif;font-size:48px;color:#f1c40f;letter-spacing:4px;}

        /* LISTA PARTIDOS (sidebar) */
        .sidebar{display:flex;flex-direction:column;gap:8px;}
        .sidebar-title{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:rgba(255,255,255,.3);padding:0 4px 6px;border-bottom:1px solid rgba(255,255,255,.06);}
        .p-item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:9px 12px;cursor:pointer;transition:.15s;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;}
        .p-item:hover{border-color:rgba(241,196,15,.4);background:rgba(241,196,15,.04);}
        .p-item.activo{border-color:#f1c40f;background:rgba(241,196,15,.07);}
        .p-item.finalizado{opacity:.55;}
        .p-item.en-curso .p-vs::before{content:'';display:inline-block;width:6px;height:6px;background:#2ecc71;border-radius:50%;margin-right:4px;animation:pulse .8s infinite alternate;}
        .p-t{font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:.5px;line-height:1.3;}
        .p-t.home{text-align:right;}
        .p-vs{font-family:'Bebas Neue',sans-serif;font-size:15px;text-align:center;color:#f1c40f;white-space:nowrap;}
        .p-vs.pen{font-size:11px;color:rgba(255,255,255,.2);}

        /* REPLAY / FIN */
        .fin-box{background:rgba(241,196,15,.06);border:1px solid rgba(241,196,15,.2);border-radius:12px;padding:16px;text-align:center;}
        .fin-score-big{font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:6px;color:#f1c40f;margin:4px 0;}
        .fin-teams{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:8px;}
        .btn-replay{background:#f1c40f;color:#000;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;border:none;border-radius:8px;padding:10px 24px;cursor:pointer;transition:.2s;width:100%;margin-top:10px;}
        .btn-replay:hover{background:#f39c12;transform:translateY(-1px);}
        .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;border-radius:8px;padding:8px 16px;cursor:pointer;width:100%;margin-top:6px;transition:.2s;}
        .btn-outline:hover{border-color:#f1c40f;color:#f1c40f;}
    </style>
</head>
<body>

<div class="top-bar">
    <div class="top-logo">âš½ LIGA 1 SIM</div>
    <nav class="top-nav">
        <a href="dashboard.html">Mi Equipo</a>
        <a href="jornadas.html">Jornadas</a>
    </nav>
</div>

<!-- WAITING -->
<div id="waiting-panel" style="display:none;">
    <div class="wait-icon">âš½</div>
    <div class="wait-title">PrÃ³xima Jornada</div>
    <div class="wait-sub">Los partidos comienzan hoy a las <strong style="color:#f1c40f;">7:00 PM</strong> (hora PerÃº)</div>
    <div id="countdown">--:--:--</div>
</div>

<!-- MAIN EN VIVO / FIN -->
<div class="main" id="main-panel" style="display:none;">

    <!-- IZQUIERDA: partido seleccionado -->
    <div class="partido-panel">

        <!-- Score header -->
        <div class="score-header" id="score-header">
            <div>
                <div class="team-name home" id="nombre-home">â€”</div>
            </div>
            <div class="center-col">
                <div class="team-score" id="team-score">0 â€” 0</div>
                <div class="time-badge badge-live" id="time-badge">â— EN VIVO</div>
            </div>
            <div>
                <div class="team-name" id="nombre-away">â€”</div>
            </div>
        </div>

        <!-- Canvas decorativo -->
        <div class="canvas-wrap">
            <canvas id="gameCanvas" width="580" height="360"></canvas>
            <div id="goal-overlay">
                <div id="goal-text">âš½ GOL</div>
                <div id="goal-scorer"></div>
            </div>
        </div>

        <!-- Feed de goles -->
        <div class="feed-box">
            <div class="feed-title">âš½ Goles del partido</div>
            <div id="feed-goles"><div class="feed-empty">Sin goles aÃºn</div></div>
        </div>

        <!-- Panel fin de partido -->
        <div class="fin-box" id="fin-box" style="display:none;">
            <div class="fin-teams" id="fin-teams">â€”</div>
            <div class="fin-score-big" id="fin-score-big">0 â€” 0</div>
            <div id="fin-goles-list" style="font-size:13px;color:rgba(255,255,255,.4);margin-bottom:8px;"></div>
            <button class="btn-replay" onclick="iniciarReplay()">ğŸ¬ Ver Replay</button>
            <button class="btn-outline" onclick="window.location.href='jornadas.html'">â† Jornadas</button>
        </div>

    </div>

    <!-- DERECHA: lista de partidos -->
    <div class="sidebar">
        <div class="sidebar-title">ğŸ“‹ Partidos de la Jornada</div>
        <div id="lista-partidos"></div>
    </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS DECORATIVO â€” jugadores que se mueven solos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const CW = canvas.width, CH = canvas.height;

// Colores actuales (se actualizan al cambiar de partido)
let colorHome = '#3498db', colorAway = '#e74c3c';

// 22 jugadores decorativos â€” solo se mueven aleatoriamente
const dots = [];
for(let i=0;i<11;i++) dots.push({x:Math.random()*CW*0.45+10, y:Math.random()*CH, vx:(Math.random()-.5)*1.2, vy:(Math.random()-.5)*1.2, team:'home'});
for(let i=0;i<11;i++) dots.push({x:Math.random()*CW*0.45+CW*0.5, y:Math.random()*CH, vx:(Math.random()-.5)*1.2, vy:(Math.random()-.5)*1.2, team:'away'});
// Pelota
const pelota = {x:CW/2, y:CH/2, vx:1.5, vy:1, r:6};

function moveDots(){
    dots.forEach(d=>{
        // Moverse hacia la pelota suavemente
        const dx=pelota.x-d.x, dy=pelota.y-d.y, dist=Math.hypot(dx,dy);
        if(dist<120){ d.vx+=dx/dist*0.05; d.vy+=dy/dist*0.05; }
        // Velocidad mÃ¡xima
        const spd=Math.hypot(d.vx,d.vy);
        if(spd>1.8){d.vx=d.vx/spd*1.8;d.vy=d.vy/spd*1.8;}
        // FriccciÃ³n
        d.vx*=0.98; d.vy*=0.98;
        // Ruido
        d.vx+=(Math.random()-.5)*0.15; d.vy+=(Math.random()-.5)*0.15;
        d.x+=d.vx; d.y+=d.vy;
        // LÃ­mites del campo (home en izq, away en der, pero pueden ir al centro)
        if(d.x<8){d.x=8;d.vx*=-1;} if(d.x>CW-8){d.x=CW-8;d.vx*=-1;}
        if(d.y<8){d.y=8;d.vy*=-1;} if(d.y>CH-8){d.y=CH-8;d.vy*=-1;}
    });
    // Pelota
    pelota.x+=pelota.vx; pelota.y+=pelota.vy;
    if(pelota.x<pelota.r){pelota.x=pelota.r;pelota.vx*=-1;}
    if(pelota.x>CW-pelota.r){pelota.x=CW-pelota.r;pelota.vx*=-1;}
    if(pelota.y<pelota.r){pelota.y=pelota.r;pelota.vy*=-1;}
    if(pelota.y>CH-pelota.r){pelota.y=CH-pelota.r;pelota.vy*=-1;}
}

function drawCanvas(){
    ctx.clearRect(0,0,CW,CH);
    // Campo
    ctx.fillStyle='#2d7a33'; ctx.fillRect(0,0,CW,CH);
    // LÃ­neas
    ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=2;
    ctx.strokeRect(4,4,CW-8,CH-8);
    ctx.beginPath();ctx.moveTo(CW/2,0);ctx.lineTo(CW/2,CH);ctx.stroke();
    ctx.beginPath();ctx.arc(CW/2,CH/2,46,0,Math.PI*2);ctx.stroke();
    // PorterÃ­as
    ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=3;
    ctx.strokeRect(0,CH/2-40,60,80); ctx.strokeRect(CW-60,CH/2-40,60,80);
    // Jugadores
    dots.forEach(d=>{
        ctx.beginPath();ctx.arc(d.x,d.y,7,0,Math.PI*2);
        ctx.fillStyle=d.team==='home'?colorHome:colorAway; ctx.fill();
        ctx.strokeStyle='rgba(0,0,0,.6)';ctx.lineWidth=1.5;ctx.stroke();
    });
    // Pelota
    ctx.beginPath();ctx.arc(pelota.x,pelota.y,pelota.r,0,Math.PI*2);
    ctx.fillStyle='#fff';ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.stroke();
}

function loop(){ moveDots(); drawCanvas(); requestAnimationFrame(loop); }
loop();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SONIDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AudioCtx=window.AudioContext||window.webkitAudioContext;
const audioCtx=new AudioCtx();
function playGoalSound(){
    try{
        const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*1.5,audioCtx.sampleRate);
        const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
        const n=audioCtx.createBufferSource();n.buffer=buf;
        const f=audioCtx.createBiquadFilter();f.type='bandpass';f.frequency.value=700;
        const g=audioCtx.createGain();n.connect(f);f.connect(g);g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0,audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(.35,audioCtx.currentTime+.2);
        g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+1.5);
        n.start();
    }catch(e){}
}
function playWhistle(){
    try{
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.connect(g);g.connect(audioCtx.destination);o.type='square';
        o.frequency.setValueAtTime(2000,audioCtx.currentTime);
        g.gain.setValueAtTime(.04,audioCtx.currentTime);
        g.gain.setValueAtTime(.04,audioCtx.currentTime+.1);
        g.gain.setValueAtTime(0,audioCtx.currentTime+.15);
        g.gain.setValueAtTime(.04,audioCtx.currentTime+.2);
        g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.5);
        o.start();o.stop(audioCtx.currentTime+.5);
    }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMACIÃ“N GOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarGolOverlay(nombre, color){
    const overlay=document.getElementById('goal-overlay');
    const txt=document.getElementById('goal-text');
    const sc=document.getElementById('goal-scorer');
    overlay.querySelectorAll('.confetti').forEach(c=>c.remove());
    overlay.style.display='block';
    txt.style.color=color||'#f1c40f';
    txt.style.transform='translate(-50%,-50%) scale(1)';
    sc.style.opacity='1';
    sc.innerText=nombre?`âš½ ${nombre}`:'âš½ GOL';
    playGoalSound();
    const cols=['#f1c40f','#e74c3c','#3498db','#2ecc71','#9b59b6','#fff'];
    for(let i=0;i<25;i++){
        const c=document.createElement('div');c.className='confetti';
        c.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*40}%;background:${cols[Math.floor(Math.random()*cols.length)]};width:${Math.random()*10+5}px;height:${Math.random()*10+5}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-delay:${Math.random()*.4}s;animation-duration:${Math.random()*.8+.8}s;`;
        overlay.appendChild(c);
    }
    setTimeout(()=>{
        txt.style.transform='translate(-50%,-50%) scale(0)';
        sc.style.opacity='0';
        setTimeout(()=>overlay.style.display='none',350);
    },2000);
}
</script>

<script type="module">
import{createClient}from'https://esm.sh/@supabase/supabase-js@2';
const db=createClient('https://hpvpxadhbftiulwmysaw.supabase.co','sb_publishable_Inip39JWInROxtuAaTL9rQ_f24sZcFa');

const COLORES={
    'Universitario de Deportes':'#f3e5ab','Alianza Lima':'#1a237e','Sporting Cristal':'#5DADE2',
    'FBC Melgar':'#c0392b','Cusco FC':'#d4af37','Sport Boys Association':'#fd79a8',
    'Deportivo Garcilaso':'#81ecec','Comerciantes Unidos':'#6c5ce7','Cienciano':'#e74c3c',
    'Sport Huancayo':'#b33939','ADT de Tarma':'#74b9ff','AtlÃ©tico Grau':'#ffec13',
    'UTC Cajamarca':'#f5deb3','Juan Pablo II College':'#f39c12','CD Los Chankas':'#d63031',
    'FC Cajamarca':'#bdc3c7','Alianza AtlÃ©tico Sullana':'#ecf0f1','Deportivo Moquegua':'#00b894'
};

let miEquipo=null, jornadaActiva=null, todosPartidos=[], partidoViendo=null;
let golesViendo=[], replayTimeouts=[];

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
    const{data:{session}}=await db.auth.getSession();
    if(!session){window.location.href='login.html';return;}
    if(audioCtx.state==='suspended') audioCtx.resume().catch(()=>{});
    const{data:eq}=await db.from('equipos').select('*').eq('user_id',session.user.id).single();
    miEquipo=eq;
    await cargarEstado();
    iniciarCountdown();
    suscribirRealtime();
}

// â”€â”€â”€ CARGAR ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarEstado(){
    const{data:cfg}=await db.from('config_liga').select('*').eq('id',1).single();
    jornadaActiva=cfg;
    if(!cfg||cfg.jornada_activa===0){mostrarWaiting();return;}

    const{data:ps}=await db.from('jornadas').select('*')
        .eq('temporada','2025').eq('numero_jornada',cfg.jornada_activa).order('id');
    todosPartidos=ps||[];

    // Seleccionar automÃ¡ticamente el partido del manager
    let auto=null;
    if(miEquipo){
        const nb=miEquipo.equipo_base||miEquipo.nombre;
        auto=todosPartidos.find(p=>p.equipo_local===nb||p.equipo_visitante===nb);
    }
    if(!auto&&todosPartidos.length) auto=todosPartidos[0];

    document.getElementById('waiting-panel').style.display='none';
    document.getElementById('main-panel').style.display='grid';

    renderListaPartidos();
    if(auto) await verPartido(auto);
}

// â”€â”€â”€ VER PARTIDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verPartido(p){
    partidoViendo=p;
    cancelarReplay();

    // Colores
    colorHome=COLORES[p.equipo_local]||'#3498db';
    colorAway=COLORES[p.equipo_visitante]||'#e74c3c';

    // Aplicar colores a dots decorativos
    dots.forEach(d=>{ if(d.team==='home') d.color=colorHome; if(d.team==='away') d.color=colorAway; });

    // Score header
    document.getElementById('nombre-home').innerText=p.equipo_local;
    document.getElementById('nombre-home').style.color=colorHome;
    document.getElementById('nombre-away').innerText=p.equipo_visitante;
    document.getElementById('nombre-away').style.color=colorAway;
    actualizarScore(p.goles_local??0, p.goles_visitante??0);

    // Estado badge
    const badge=document.getElementById('time-badge');
    if(p.estado==='finalizado'){badge.className='time-badge badge-fin';badge.innerText='FINALIZADO';}
    else if(p.estado==='en_curso'){badge.className='time-badge badge-live';badge.innerText='â— EN VIVO';}
    else{badge.className='time-badge badge-wait';badge.innerText='PRÃ“XIMO';}

    // Cargar goles ya ocurridos
    const{data:evts}=await db.from('eventos_partido').select('*').eq('partido_id',p.id).order('minuto');
    golesViendo=evts||[];
    renderFeedGoles(golesViendo);

    // Panel fin
    if(p.estado==='finalizado'){
        document.getElementById('fin-box').style.display='block';
        document.getElementById('fin-teams').innerText=`${p.equipo_local} vs ${p.equipo_visitante}`;
        document.getElementById('fin-score-big').innerText=`${p.goles_local??0} â€” ${p.goles_visitante??0}`;
        document.getElementById('fin-score-big').style.color=colorHome;
        const golesFin=golesViendo.filter(e=>e.tipo==='gol');
        document.getElementById('fin-goles-list').innerHTML=golesFin.map(g=>
            `<span style="color:${g.es_local?colorHome:colorAway}">âš½ ${g.minuto}' ${g.jugador||''}</span>`
        ).join('  Â·  ');
    } else {
        document.getElementById('fin-box').style.display='none';
    }

    renderListaPartidos();
}

window.verPartido=verPartido;
window.clickPartido=function(el){ 
    const id=el.getAttribute('data-pid');
    const p=todosPartidos.find(x=>String(x.id)===String(id));
    if(p) verPartido(p);
};

// â”€â”€â”€ SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarScore(gl, gv){
    document.getElementById('team-score').innerText=`${gl} â€” ${gv}`;
}

// â”€â”€â”€ FEED GOLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeedGoles(evts){
    const goles=evts.filter(e=>e.tipo==='gol');
    const container=document.getElementById('feed-goles');
    if(!goles.length){container.innerHTML='<div class="feed-empty">Sin goles aÃºn</div>';return;}
    container.innerHTML=goles.map(g=>`
        <div class="feed-item">
            <span class="feed-min">${g.minuto}'</span>
            <div>
                <div class="feed-jugador" style="color:${g.es_local?colorHome:colorAway}">${g.jugador||'Jugador'}</div>
                <div class="feed-equipo">${g.es_local?partidoViendo?.equipo_local:partidoViendo?.equipo_visitante}</div>
            </div>
        </div>`).join('');
}

// â”€â”€â”€ LISTA PARTIDOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderListaPartidos(){
    const container=document.getElementById('lista-partidos');
    const nb=miEquipo?(miEquipo.equipo_base||miEquipo.nombre):null;
    container.innerHTML=todosPartidos.map(p=>{
        const fin=p.estado==='finalizado', vivo=p.estado==='en_curso';
        const activo=partidoViendo?.id===p.id;
        const esMio=nb&&(p.equipo_local===nb||p.equipo_visitante===nb);
        const score=fin?`<span class="p-vs">${p.goles_local??0}â€”${p.goles_visitante??0}</span>`
                       :`<span class="p-vs ${vivo?'':'pen'}">${vivo?'âš½':'VS'}</span>`;
        const borde=esMio?'border-color:#f1c40f;':'';
        const cl=`p-item ${activo?'activo':''} ${fin?'finalizado':''} ${vivo?'en-curso':''}`;
        return `<div class="${cl}" style="${borde}" data-pid="${p.id}" onclick="clickPartido(this)">
            <span class="p-t home">${p.equipo_local}</span>
            ${score}
            <span class="p-t">${p.equipo_visitante}</span>
        </div>`;
    }).join('');
}

// â”€â”€â”€ REPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.iniciarReplay=function(){
    if(!golesViendo.length&&!golesViendo.filter(e=>e.tipo==='gol').length){
        alert('No hay goles para reproducir');return;
    }
    cancelarReplay();
    const goles=golesViendo.filter(e=>e.tipo==='gol');
    if(!goles.length){alert('No hubo goles en este partido');return;}

    const badge=document.getElementById('time-badge');
    badge.className='time-badge badge-live';
    badge.innerText='ğŸ¬ REPLAY';

    // Reset marcador visual
    actualizarScore(0,0);
    document.getElementById('feed-goles').innerHTML='<div class="feed-empty">Reproduciendo...</div>';
    document.getElementById('fin-box').style.display='none';

    let gL=0, gR=0;
    const durSeg=60; // replay de 60 segundos reales

    goles.forEach(ev=>{
        const t=Math.floor((ev.minuto/90)*durSeg)*1000;
        const tid=setTimeout(()=>{
            if(ev.es_local) gL++; else gR++;
            actualizarScore(gL,gR);
            mostrarGolOverlay(ev.jugador, ev.es_local?colorHome:colorAway);
            // Agregar al feed
            const container=document.getElementById('feed-goles');
            if(container.querySelector('.feed-empty')) container.innerHTML='';
            container.innerHTML+=`<div class="feed-item">
                <span class="feed-min">${ev.minuto}'</span>
                <div>
                    <div class="feed-jugador" style="color:${ev.es_local?colorHome:colorAway}">${ev.jugador||'Jugador'}</div>
                    <div class="feed-equipo">${ev.es_local?partidoViendo?.equipo_local:partidoViendo?.equipo_visitante}</div>
                </div>
            </div>`;
        },t+200);
        replayTimeouts.push(tid);
    });

    // Fin replay
    const tid=setTimeout(()=>{
        badge.className='time-badge badge-fin';
        badge.innerText='âœ… FIN REPLAY';
        document.getElementById('fin-box').style.display='block';
        playWhistle();
    },durSeg*1000+800);
    replayTimeouts.push(tid);
};

function cancelarReplay(){
    replayTimeouts.forEach(t=>clearTimeout(t));
    replayTimeouts=[];
}

// â”€â”€â”€ REALTIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function suscribirRealtime(){
    db.channel('partido-feed')
        // Nuevo gol insertado
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'eventos_partido'},payload=>{
            const ev=payload.new;
            if(ev.tipo!=='gol') return;
            // Actualizar lista de todos los partidos
            todosPartidos.forEach(p=>{
                if(p.id===ev.partido_id){
                    if(ev.es_local) p.goles_local=(p.goles_local||0)+1;
                    else p.goles_visitante=(p.goles_visitante||0)+1;
                }
            });
            renderListaPartidos();
            // Si es el partido que estamos viendo
            if(partidoViendo&&ev.partido_id===partidoViendo.id){
                if(ev.es_local) partidoViendo.goles_local=(partidoViendo.goles_local||0)+1;
                else partidoViendo.goles_visitante=(partidoViendo.goles_visitante||0)+1;
                actualizarScore(partidoViendo.goles_local??0, partidoViendo.goles_visitante??0);
                golesViendo.push(ev);
                renderFeedGoles(golesViendo);
                mostrarGolOverlay(ev.jugador, ev.es_local?colorHome:colorAway);
            }
        })
        // Partido finalizado
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'jornadas'},payload=>{
            const p=payload.new;
            const idx=todosPartidos.findIndex(x=>x.id===p.id);
            if(idx>=0) todosPartidos[idx]=p;
            renderListaPartidos();
            if(partidoViendo&&p.id===partidoViendo.id){
                partidoViendo=p;
                if(p.estado==='finalizado'){
                    document.getElementById('time-badge').className='time-badge badge-fin';
                    document.getElementById('time-badge').innerText='FINALIZADO';
                    document.getElementById('fin-box').style.display='block';
                    document.getElementById('fin-teams').innerText=`${p.equipo_local} vs ${p.equipo_visitante}`;
                    document.getElementById('fin-score-big').innerText=`${p.goles_local??0} â€” ${p.goles_visitante??0}`;
                    playWhistle();
                }
            }
        })
        // Estado general cambia
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'config_liga'},payload=>{
            jornadaActiva=payload.new;
            if(payload.new.estado==='en_vivo') cargarEstado();
        })
        .subscribe();
}

// â”€â”€â”€ WAITING COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarWaiting(){
    document.getElementById('waiting-panel').style.display='block';
    document.getElementById('main-panel').style.display='none';
}

function iniciarCountdown(){
    function tick(){
        if(jornadaActiva?.estado==='en_vivo'||jornadaActiva?.estado==='finalizado') return;
        const now=new Date(), target=new Date();
        target.setHours(19,0,0,0);
        let diff=target-now; if(diff<0) diff+=86400000;
        const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
        const el=document.getElementById('countdown');
        if(el) el.innerText=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick(); setInterval(tick,1000);
}

init();
</script>
</body>
</html>
